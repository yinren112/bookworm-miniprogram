<!-- pages/order-detail/index.wxml -->
<wxs module="filters" src="../../utils/filters.wxs"></wxs>

<view class="container page-container">
  <!-- Decorative Blobs -->
  <view class="bg-blob bg-blob-1"></view>
  <view class="bg-blob bg-blob-2"></view>

  <!-- Loading State -->
  <skeleton wx:if="{{isLoading}}" type="list" count="3" />

  <!-- Error State -->
  <view wx:elif="{{error}}" class="error-container anim-fade-in-up">
    <view class="error-icon">âš ï¸</view>
    <view class="error-text">{{error}}</view>
    <button class="retry-btn" bind:tap="onRefresh">åˆ·æ–°é‡è¯•</button>
  </view>

  <!-- Order Detail Content -->
  <view wx:else class="order-detail anim-fade-in-up">
    
    <!-- 1. Header Status (Hero Card) -->
    <view class="status-card">
      <view class="status-icon-box">
        <!-- Simple status icon logic based on status -->
        <text wx:if="{{order.status === 'PENDING_PICKUP'}}" class="status-icon">ğŸ«</text>
        <text wx:elif="{{order.status === 'PENDING_PAYMENT'}}" class="status-icon">ğŸ’³</text>
        <text wx:elif="{{order.status === 'COMPLETED'}}" class="status-icon">âœ…</text>
        <text wx:elif="{{order.status === 'CANCELLED'}}" class="status-icon">ğŸš«</text>
        <text wx:else class="status-icon">ğŸ“„</text>
      </view>
      <view class="status-main">
        <text class="status-title">{{filters.getStatusText(order.status)}}</text>
        <text class="status-desc" wx:if="{{order.status === 'PENDING_PICKUP'}}">è¯·å‡­ä¸‹æ–¹å–è´§ç å–è´§</text>
        <text class="status-desc" wx:elif="{{order.status === 'PENDING_PAYMENT'}}">è¯·å°½å¿«å®Œæˆæ”¯ä»˜</text>
        <text class="status-desc" wx:else>è®¢å•å·²ç»“æŸ</text>
      </view>
    </view>

    <!-- 2. Pickup Info (Ticket Style) - Only for PENDING_PICKUP -->
    <view wx:if="{{order.status === 'PENDING_PICKUP'}}" class="pickup-ticket">
      <view class="ticket-header">
        <text class="ticket-label">å–è´§å‡­è¯</text>
        <text class="ticket-time">{{formatDate(order.createdAt)}}</text>
      </view>
      
      <view class="code-section">
        <text class="code-label">å–è´§ç </text>
        <text class="pickup-code clay-num">{{order.pickup_code}}</text>
        <button class="copy-btn" bind:tap="copyPickupCode" data-code="{{order.pickup_code}}">å¤åˆ¶</button>
      </view>

      <view class="ticket-divider">
        <view class="half-circle left"></view>
        <view class="line"></view>
        <view class="half-circle right"></view>
      </view>

      <view class="ticket-info">
        <view class="info-row">
          <text class="label">å–è´§åœ°ç‚¹</text>
          <text class="value">ç†ç§‘æ¥¼ä¸€æ¥¼æ´»åŠ¨å®¤</text>
        </view>
        <view class="info-row">
          <text class="label">è¥ä¸šæ—¶é—´</text>
          <text class="value">å‘¨ä¸€è‡³å‘¨äº” 10:00 - 18:00</text>
        </view>
        <view class="info-row" wx:if="{{order.pickupExpiresAt}}">
          <text class="label">æˆªæ­¢æ—¶é—´</text>
          <text class="value highlight">{{formatDate(order.pickupExpiresAt)}}</text>
        </view>
      </view>
    </view>

    <!-- 3. Book List (Clay List) -->
    <view class="books-card">
      <view class="card-title">è´­ä¹°ä¹¦ç±</view>
      <view class="book-list">
        <view wx:for="{{order.orderItem}}" wx:key="id" class="book-item">
          <image 
            class="book-cover"
            src="{{item.inventoryItem.bookSku.cover_image_url || '/images/placeholder-cover.svg'}}" 
            mode="aspectFill"
          />
          <view class="book-info">
            <text class="book-title">{{item.inventoryItem.bookSku.bookMaster.title}}</text>
            <text class="book-author">{{item.inventoryItem.bookSku.bookMaster.author || 'ä½œè€…æœªçŸ¥'}}</text>
            <view class="tags-row">
              <view class="clay-tag">{{filters.getConditionText(item.inventoryItem.condition)}}</view>
              <view class="clay-tag version" wx:if="{{item.inventoryItem.bookSku.edition}}">{{item.inventoryItem.bookSku.edition}}</view>
            </view>
          </view>
          <text class="book-price clay-num">{{filters.formatCurrency(item.price)}}</text>
        </view>
      </view>
    </view>

    <!-- 4. Order Meta Info (Inset Card) -->
    <view class="meta-card">
      <view class="meta-row">
        <text class="label">è®¢å•ç¼–å·</text>
        <text class="value copyable clay-num" bindtap="copyOrderId" data-id="{{order.id}}">{{order.id}}</text>
      </view>
      <view class="meta-row">
        <text class="label">ä¸‹å•æ—¶é—´</text>
        <text class="value clay-num">{{formatDate(order.createdAt)}}</text>
      </view>
      <view wx:if="{{order.paid_at}}" class="meta-row">
        <text class="label">æ”¯ä»˜æ—¶é—´</text>
        <text class="value clay-num">{{formatDate(order.paid_at)}}</text>
      </view>
      
      <view class="meta-divider"></view>
      
      <view class="meta-row total">
        <text class="label">å®ä»˜é‡‘é¢</text>
        <text class="value total-price clay-num">{{filters.formatCurrency(order.total_amount)}}</text>
      </view>
    </view>

    <!-- Action Bar (if needed) -->
    <view class="action-bar" wx:if="{{order.status === 'PENDING_PAYMENT'}}">
       <button class="pay-btn" bindtap="handlePay">ç«‹å³æ”¯ä»˜</button>
    </view>

  </view>
</view>
