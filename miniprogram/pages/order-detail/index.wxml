<!-- pages/order-detail/index.wxml -->
<wxs module="filters" src="../../utils/filters.wxs"></wxs>
<view class="container">
  <!-- Loading State -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-text">加载中...</view>
  </view>

  <!-- Error State -->
  <view wx:elif="{{error}}" class="error-container">
    <view class="error-text">{{error}}</view>
    <button class="retry-btn" bind:tap="onRefresh">重试</button>
  </view>

  <!-- Order Detail Content -->
  <view wx:else class="order-detail">
    <!-- 履约信息区 -->
    <view class="fulfillment-section">
      <view class="status-header">
        <view class="status-text">{{filters.getStatusText(order.status)}}</view>
      </view>
      
      <view wx:if="{{order.status === 'PENDING_PICKUP'}}" class="pickup-info">
        <view class="pickup-code-container">
          <view class="pickup-code-label">取货码</view>
          <view class="pickup-code">{{order.pickup_code}}</view>
          <button class="btn btn-sm copy-btn" bind:tap="copyPickupCode" data-code="{{order.pickup_code}}">复制</button>
        </view>
        
        <view class="pickup-details">
          <view class="pickup-item">
            <view class="pickup-label">取货地点</view>
            <view class="pickup-value">理科楼一楼活动室</view>
          </view>
          <view class="pickup-item">
            <view class="pickup-label">营业时间</view>
            <view class="pickup-value">周一至周五 10:00 - 18:00</view>
          </view>
          <view wx:if="{{order.pickupExpiresAt}}" class="pickup-item">
            <view class="pickup-label">取货截止</view>
            <view class="pickup-value">{{formatDate(order.pickupExpiresAt)}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 书籍列表区 -->
    <view class="books-section">
      <view class="section-title">购买书籍</view>
      <view class="book-list">
        <view wx:for="{{order.orderItem}}" wx:key="id" class="book-item">
          <view class="book-cover">
            <image 
              wx:if="{{item.inventoryItem.bookSku.cover_image_url}}"
              src="{{item.inventoryItem.bookSku.cover_image_url}}" 
              class="cover-image"
              mode="aspectFit"
            />
            <view wx:else class="cover-placeholder">
              <text class="cover-placeholder-text">暂无封面</text>
            </view>
          </view>
          
          <view class="book-info">
            <view class="book-title">{{item.inventoryItem.bookSku.bookMaster.title}}</view>
            <view wx:if="{{item.inventoryItem.bookSku.bookMaster.author}}" class="book-author">
              作者：{{item.inventoryItem.bookSku.bookMaster.author}}
            </view>
            <view wx:if="{{item.inventoryItem.bookSku.edition}}" class="book-edition">
              版本：{{item.inventoryItem.bookSku.edition}}
            </view>
            <view class="book-condition">品相：{{filters.getConditionText(item.inventoryItem.condition)}}</view>
          </view>
          
          <view class="book-price">
            {{filters.formatCurrency(item.price)}}
          </view>
        </view>
      </view>
    </view>

    <!-- 订单详情区 -->
    <view class="order-info-section">
      <view class="section-title">订单详情</view>
      <view class="order-info-list">
        <view class="info-item">
          <view class="info-label">订单号</view>
          <view class="info-value">{{order.id}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">下单时间</view>
          <view class="info-value">{{formatDate(order.createdAt)}}</view>
        </view>
        <view wx:if="{{order.paid_at}}" class="info-item">
          <view class="info-label">支付时间</view>
          <view class="info-value">{{formatDate(order.paid_at)}}</view>
        </view>
        <view wx:if="{{order.completed_at}}" class="info-item">
          <view class="info-label">完成时间</view>
          <view class="info-value">{{formatDate(order.completed_at)}}</view>
        </view>
        <view wx:if="{{order.cancelled_at}}" class="info-item">
          <view class="info-label">取消时间</view>
          <view class="info-value">{{formatDate(order.cancelled_at)}}</view>
        </view>
        <view class="info-item total-amount">
          <view class="info-label">订单总额</view>
          <view class="info-value price">{{filters.formatCurrency(order.total_amount)}}</view>
        </view>
      </view>
    </view>
  </view>
</view>