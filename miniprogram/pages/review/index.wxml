<!-- pages/review/index.wxml -->
<!-- 复习首页 -->
<view class="container">
  <view class="header-section">
    <text class="greeting-text">你好，同学</text>
    <text class="greeting-sub">今天也要稳稳推进复习节奏</text>
  </view>

  <state-view
    wx:if="{{loading || error}}"
    status="{{loading ? 'loading' : 'error'}}"
    loadingText="正在加载复习看板..."
    errorText="网络波动，稍后再试"
    bind:retry="onRetry"
    bind:feedback="onFeedback"
    skeletonType="grid"
    skeletonCount="{{4}}"
  />

  <view wx:if="{{!loading && !error}}">
    <view class="dashboard-card clay-card">
      <view class="dashboard-header">
        <view class="date-badge">
          <text class="date-text">{{todayDate}}</text>
        </view>
        <view class="streak-chip">
          <image class="streak-icon" src="/images/icons/review/flame.svg" mode="aspectFit" />
          <text>{{dashboard.streakDays || 0}} 天</text>
        </view>
      </view>
      <view class="metric-grid">
        <view class="metric-item">
          <text class="metric-value">{{dashboard.dueCardCount || 0}}</text>
          <text class="metric-label">到期卡片</text>
        </view>
        <view class="metric-item">
          <text class="metric-value">{{dashboard.dueQuizCount || 0}}</text>
          <text class="metric-label">待测验</text>
        </view>
        <view class="metric-item">
          <text class="metric-value">{{dashboard.wrongCount || 0}}</text>
          <text class="metric-label">错题数</text>
        </view>
        <view class="metric-item">
          <text class="metric-value">{{dashboard.etaMinutes || 0}}</text>
          <text class="metric-label">预计分钟</text>
        </view>
      </view>
      <button class="cta-btn {{highlightStart ? 'highlight' : ''}}" bindtap="startPrimaryCta">
        {{primaryCtaText}}
      </button>
      <button class="cta-btn ghost" wx:if="{{resumeSession}}" bindtap="continueSession">
        继续上次复习
      </button>
      <button class="cta-btn subtle" wx:if="{{dashboard.wrongCount > 0}}" bindtap="startWrongQuiz">
        错题强化
      </button>
    </view>

    <view class="course-section" wx:if="{{currentCourse}}">
      <view class="section-title">当前学习课程</view>
      <view class="course-card clay-card-sm" bindtap="navigateToCourse" data-course-key="{{currentCourse.courseKey}}">
        <view class="course-summary">
          <text class="course-name">{{currentCourse.title}}</text>
          <text class="course-progress">已完成 {{currentCourse.progressPercent}}%</text>
        </view>
        <view class="course-action">
          <text>继续学习</text>
        </view>
      </view>
    </view>

    <view class="empty-wrap" wx:if="{{!currentCourse}}">
      <state-view
        status="empty"
        emptyText="还没有加入课程，先从推荐课程开始"
        actionText="浏览推荐课程"
        bind:action="goToFirstRecommended"
      />
      <view class="recommend-list" wx:if="{{recommendedCourses.length > 0}}">
        <view class="section-title">推荐课程</view>
        <view class="course-card clay-card-sm" wx:for="{{recommendedCourses}}" wx:key="id" bindtap="navigateToCourse" data-course-key="{{item.courseKey}}">
          <view class="course-summary">
            <text class="course-name">{{item.title}}</text>
            <text class="course-progress">{{item.totalCards || 0}} 卡片</text>
          </view>
          <view class="course-action">
            <text>去学习</text>
          </view>
        </view>
      </view>
    </view>

    <view class="heatmap-section" wx:if="{{heatmapData.length > 0}}">
      <view class="section-title">过去 35 天</view>
      <view class="heatmap-grid">
        <block wx:for="{{heatmapData}}" wx:key="date">
          <view class="heatmap-cell level-{{item.level}}" data-date="{{item.date}}" bindtap="onHeatmapTap"></view>
        </block>
      </view>
      <text class="heatmap-hint">点击任意一天查看记录</text>
    </view>
  </view>
</view>
