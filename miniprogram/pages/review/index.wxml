<view class="container {{isPageActive ? 'page-active' : ''}}">
  <topbar title="å¤ä¹ " back="{{false}}" color="var(--color-text-main)" background="var(--color-bg-card)">
    <view slot="right" class="header-actions">
      <view class="header-icon-wrapper" bindtap="onHistoryTap">
        <image src="/images/icons/review/clock.svg" class="header-icon" mode="aspectFit" />
      </view>
      <view class="header-icon-wrapper" bindtap="onSettingsTap">
        <image src="/images/icons/setting.svg" class="header-icon" mode="aspectFit" />
      </view>
    </view>
  </topbar>
  <scroll-view scroll-y class="main-scroll {{showCoursePicker ? 'scale-down' : ''}}" enable-flex>
    <!-- Skeleton Screen -->
    <view wx:if="{{loading}}" class="content-wrapper skel-wrapper">
      <view class="study-card">
        <view class="course-header">
          <view class="course-info">
            <view class="skel-block skel-title"></view>
            <view class="skel-stat-split">
              <view class="skel-block skel-stat"></view>
              <view class="skel-block skel-stat"></view>
            </view>
          </view>
          <view class="skel-block skel-icon"></view>
        </view>
        <view class="skel-block skel-progress"></view>
        <view class="skel-block skel-cta"></view>
      </view>
      <view class="study-card">
        <view class="skel-block skel-section-title"></view>
        <view class="skel-heatmap-row">
          <view class="skel-block skel-bar" style="height:40rpx"></view>
          <view class="skel-block skel-bar" style="height:80rpx"></view>
          <view class="skel-block skel-bar" style="height:56rpx"></view>
          <view class="skel-block skel-bar" style="height:100rpx"></view>
          <view class="skel-block skel-bar" style="height:32rpx"></view>
          <view class="skel-block skel-bar" style="height:72rpx"></view>
          <view class="skel-block skel-bar" style="height:48rpx"></view>
        </view>
      </view>
    </view>
    <block wx:elif="{{error}}">
      <error-state mode="network" title="åŠ è½½å¤±è´¥" desc="è¯·é‡è¯•" bind:retry="onRetry" />
      <view class="error-debug" wx:if="{{isDevtools && debugApiBaseUrl}}">
        <text>DEVTOOLS APIï¼š{{debugApiBaseUrl}}</text>
      </view>
    </block>
    <enter-transition wx:else visible="{{!loading && !error}}" staggerIndex="0">
      <view class="content-wrapper">
      <!-- å†…è”å ä½ï¼ˆmodal å·²ç§»åˆ°é¡µé¢åº•éƒ¨ï¼‰ -->
      <view class="study-card">
        <view class="course-header pressable" bindtap="navigateToCourse" data-course-key="{{currentCourse ? currentCourse.courseKey : ''}}" hover-class="course-header--pressed" hover-stay-time="80">
          <view class="course-info">
            <text class="course-name">{{currentCourse ? currentCourse.title : 'é€‰æ‹©è¯¾ç¨‹'}}</text>
            <stat-split leftValue="{{dashboard ? (dashboard.dueCardCount || 0) : 0}}" leftLabel="å¾…å¤ä¹ " leftTone="green" rightValue="{{dashboard ? (dashboard.dueQuizCount || 0) : 0}}" rightLabel="å¾…æµ‹éªŒ" rightTone="blue" />
          </view>
          <view class="course-right">
            <view class="book-spine-decoration">
              <view class="spine-bar spine-red"></view>
              <view class="spine-bar spine-blue"></view>
              <view class="spine-bar spine-green"></view>
            </view>
            <view class="course-icon">
              <image class="course-icon-img" src="/images/icons/review/book.svg" mode="aspectFit"></image>
            </view>
            <image class="course-arrow" src="/images/icons/arrow-right.svg" mode="aspectFit"></image>
          </view>
        </view>
        <view class="progress-section">
          <progress-chunky percent="{{currentCourse ? currentCourse.progressPercent : 0}}" color="yellow" label="è¿›åº¦" showLabel />
        </view>
        <view class="action-area">
          <juicy-button type="primary" full bind:tap="startPrimaryCta">
            {{primaryCtaText}}
          </juicy-button>
          <juicy-button type="outline" full wx:if="{{dashboard && dashboard.wrongCount > 0}}" bind:tap="startWrongReview">
            é”™é¢˜å¼ºåŒ– ({{dashboard.wrongCount}})
          </juicy-button>
          <view class="resume-card pressable" wx:if="{{resumeSession && resumeInfo}}" bindtap="continueSession" hover-class="resume-card--pressed" hover-stay-time="80">
            <view class="resume-card-top">
              <text class="resume-card-label">ç»§ç»­ä¸Šæ¬¡</text>
              <pill-tag variant="neutral" size="sm" wx:if="{{resumeInfo.timeAgoText}}">{{resumeInfo.timeAgoText}}</pill-tag>
            </view>
            <view class="resume-card-detail">
              <text class="resume-card-type">{{resumeInfo.typeLabel}}</text>
              <text class="resume-card-sep" wx:if="{{resumeInfo.courseTitle}}">Â·</text>
              <text class="resume-card-course" wx:if="{{resumeInfo.courseTitle}}">{{resumeInfo.courseTitle}}</text>
              <text class="resume-card-sep" wx:if="{{resumeInfo.progressText}}">Â·</text>
              <text class="resume-card-progress" wx:if="{{resumeInfo.progressText}}">{{resumeInfo.progressText}}</text>
            </view>
          </view>
        </view>
      </view>
      <enter-transition visible="{{!loading && !error}}" staggerIndex="1">
        <view class="study-card" wx:if="{{courses && courses.length > 0}}">
          <view class="section-header">
            <text class="section-title">è¯¾ç¨‹</text>
            <view class="section-link pressable" bindtap="openCoursePicker" hover-class="hover-pressed" hover-stay-time="80">
              <text>ç®¡ç†</text>
              <image class="section-link-arrow" src="/images/icons/arrow-right.svg" mode="aspectFit"></image>
            </view>
          </view>
          <scroll-view scroll-x class="course-chip-scroll" show-scrollbar="{{false}}">
            <view class="course-chip-row">
              <block wx:for="{{enrolledCourses}}" wx:key="courseKey">
                <view class="course-chip pressable {{selectedCourseKey === item.courseKey ? 'active' : ''}}" bindtap="selectEnrolledCourse" data-course-key="{{item.courseKey}}" hover-class="course-chip--pressed" hover-stay-time="80">
                  <view class="course-chip-title-row">
                    <text class="course-chip-title">{{item.title}}</text>
                    <pill-tag wx:if="{{isDevtools && item.status === 'DRAFT'}}" variant="yellow" size="sm">
                      æœªå‘å¸ƒ
                    </pill-tag>
                  </view>
                  <text class="course-chip-sub">
                    {{item.totalCards}}å¡ Â· {{item.totalQuestions}}é¢˜
                  </text>
                </view>
              </block>
              <view class="course-chip add" bindtap="openCoursePicker" hover-class="course-chip--pressed" hover-stay-time="80">
                <text class="course-chip-title">æ·»åŠ è¯¾ç¨‹</text>
                <text class="course-chip-sub">æµè§ˆå…¨éƒ¨</text>
              </view>
            </view>
          </scroll-view>
          <view class="discover-block" wx:if="{{discoverCourses && discoverCourses.length > 0}}">
            <view class="discover-header">
              <text class="discover-title">å‘ç°</text>
              <text class="discover-sub">ç‚¹è¿›å»æ³¨å†Œ</text>
            </view>
            <block wx:for="{{discoverCourses}}" wx:key="courseKey">
              <view class="discover-item pressable" bindtap="viewCourseDetail" data-course-key="{{item.courseKey}}" hover-class="discover-item--pressed" hover-stay-time="80">
                <view class="discover-left">
                  <view class="discover-title-row">
                    <text class="discover-item-title">{{item.title}}</text>
                    <pill-tag wx:if="{{isDevtools && item.status === 'DRAFT'}}" variant="yellow" size="sm">
                      æœªå‘å¸ƒ
                    </pill-tag>
                  </view>
                  <text class="discover-item-desc">{{item.description}}</text>
                </view>
                <image class="discover-arrow" src="/images/icons/arrow-right.svg" mode="aspectFit"></image>
              </view>
            </block>
          </view>
        </view>
      </enter-transition>
      <enter-transition visible="{{!loading && !error}}" staggerIndex="2">
        <view class="study-card pressable" wx:if="{{heatmapData && heatmapData.length > 0}}" bindtap="goActivityHistory" hover-class="study-card--pressed" hover-stay-time="80">
          <view class="section-header">
            <text class="section-title">å­¦ä¹ çƒ­åŠ›å›¾</text>
            <pill-tag variant="neutral" size="sm">æœ€è¿‘7å¤©</pill-tag>
          </view>
          <view class="heatmap-row">
            <block wx:for="{{heatmapData}}" wx:key="date">
              <view class="day-column" catchtap="onHeatmapTap" data-date="{{item.date}}" data-index="{{index}}">
                <view class="day-bar-wrapper">
                  <view class="heatmap-tooltip" wx:if="{{heatmapTooltipIndex === index}}">
                    <text>{{heatmapTooltipText}}</text>
                  </view>
                  <view class="day-bar level-{{item.level}}"></view>
                </view>
                <text class="day-label">{{item.dayLabel}}</text>
              </view>
            </block>
          </view>
        </view>
      </enter-transition>
      <view class="footer-slogan">
        <text>KEEP LEARNING, KEEP GROWING.</text>
      </view>
      </view>
    </enter-transition>
  </scroll-view>
  <!-- å…¨å±æ¬¢è¿å¼•å¯¼ -->
  <view class="welcome-overlay {{showWelcomeGuide && enrolledCourses.length === 0 ? 'visible' : ''}}" catchtap="openCoursePicker">
    <view class="welcome-modal" catchtap="noop">
      <view class="welcome-icon-row">
        <text class="welcome-icon-text">ğŸ“–</text>
      </view>
      <text class="welcome-title">æ¬¢è¿æ¥åˆ°å¤ä¹ åŠ©æ‰‹</text>
      <text class="welcome-desc">ç§‘å­¦é—´éš”é‡å¤ï¼Œé«˜æ•ˆè®°å¿†çŸ¥è¯†ç‚¹ã€‚\né€‰ä¸€é—¨è¯¾ç¨‹ï¼Œç«‹åˆ»å¼€å§‹ã€‚</text>
      <juicy-button type="primary" full bind:tap="openCoursePicker">æµè§ˆè¯¾ç¨‹</juicy-button>
    </view>
  </view>
  <view class="course-picker-overlay {{showCoursePicker ? 'visible' : ''}}" catchtap="closeCoursePicker">
    <view class="course-picker-modal" catchtap="noop">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©è¯¾ç¨‹</text>
        <view class="close-btn pressable" bindtap="closeCoursePicker" hover-class="hover-pressed" hover-stay-time="80">
          <text>âœ•</text>
        </view>
      </view>
      <input class="course-search" placeholder="æœç´¢è¯¾ç¨‹å / courseKey" placeholder-class="course-search__placeholder" value="{{courseSearch}}" bindinput="onCourseSearchInput" confirm-type="search" />
      <view class="picker-section">
        <view class="picker-section-header">
          <text class="picker-section-title">æˆ‘çš„è¯¾ç¨‹</text>
          <view class="picker-clear" wx:if="{{selectedCourseKey}}" bindtap="clearCourseSelection">
            <text>æ¢å¤è‡ªåŠ¨</text>
          </view>
        </view>
        <block wx:for="{{filteredEnrolledCourses}}" wx:key="courseKey">
          <view class="picker-item {{selectedCourseKey === item.courseKey ? 'selected' : ''}}" bindtap="selectEnrolledCourse" data-course-key="{{item.courseKey}}" hover-class="hover-pressed" hover-stay-time="80">
            <view class="picker-item-title-row">
              <text class="picker-item-title">{{item.title}}</text>
              <pill-tag wx:if="{{isDevtools && item.status === 'DRAFT'}}" variant="yellow" size="sm">
                æœªå‘å¸ƒ
              </pill-tag>
            </view>
            <text class="picker-item-sub">
              {{item.courseKey}} Â· {{item.totalCards}}å¡ Â· {{item.totalQuestions}}é¢˜
            </text>
          </view>
        </block>
        <view class="picker-empty" wx:if="{{filteredEnrolledCourses.length === 0}}">
          <text>è¿˜æ²¡æœ‰æ³¨å†Œè¯¾ç¨‹</text>
        </view>
      </view>
      <view class="picker-section">
        <view class="picker-section-header">
          <text class="picker-section-title">å‘ç°è¯¾ç¨‹</text>
        </view>
        <block wx:for="{{filteredDiscoverCourses}}" wx:key="courseKey">
          <view class="picker-item" bindtap="viewCourseDetail" data-course-key="{{item.courseKey}}">
            <view class="picker-item-title-row">
              <text class="picker-item-title">{{item.title}}</text>
              <pill-tag wx:if="{{isDevtools && item.status === 'DRAFT'}}" variant="yellow" size="sm">
                æœªå‘å¸ƒ
              </pill-tag>
            </view>
            <text class="picker-item-sub">
              {{item.courseKey}} Â· {{item.totalCards}}å¡ Â· {{item.totalQuestions}}é¢˜
            </text>
          </view>
        </block>
        <view class="picker-empty" wx:if="{{filteredDiscoverCourses.length === 0}}">
          <text>æ²¡æœ‰åŒ¹é…çš„è¯¾ç¨‹</text>
        </view>
      </view>
    </view>
  </view>
</view>
