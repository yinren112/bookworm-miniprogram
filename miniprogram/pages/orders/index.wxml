<!-- pages/orders/index.wxml -->
<wxs src="../../utils/formatter.wxs" module="tools" />
<wxs module="filters" src="../../utils/filters.wxs"></wxs>

<view class="container order-page">
  
  <!-- Loading State -->
  <loading-state wx:if="{{state.status === 'loading'}}" variant="page" text="加载中..." />
  
  <!-- Error State -->
  <error-state
    wx:if="{{state.status === 'error'}}"
    mode="network"
    title="加载失败"
    desc="{{state.error}}"
    bind:retry="onRetry"
  />
  
  <!-- Empty State -->
  <empty-state
    wx:if="{{state.status === 'success' && state.data.length === 0}}"
    title="暂无订单"
    desc="你还没有任何订单"
    actionText="去逛逛"
    actionType="primary"
    showAction
    bind:action="goMarket"
  />

  <!-- Order List -->
  <view class="order-list" wx:if="{{state.status === 'success' && state.data.length > 0}}">
    
    <!-- 遍历订单 -->
    <block wx:for="{{state.data}}" wx:key="id">
      
      <!-- 1. PENDING_PICKUP: 票据风格 (Hero Receipt) -->
      <view wx:if="{{item.status === 'PENDING_PICKUP'}}" 
            class="order-card receipt-card" 
            bind:tap="navigateToDetail" 
            data-order-id="{{item.id}}" 
            hover-class="card-hover">
        <!-- 锯齿边缘 (Top) -->
        <view class="receipt-edge top"></view>
        
        <view class="receipt-content">
          <view class="receipt-header">
            <text class="receipt-label">待取货凭证</text>
            <text class="receipt-time">{{tools.formatOrderTime(item.createdAt)}}</text>
          </view>
          
          <view class="pickup-code-section">
            <text class="code-label">取货码</text>
            <text class="pickup-code">{{item.pickup_code}}</text>
          </view>
          
          <view class="receipt-divider"></view>
          
          <view class="book-preview">
             <text class="book-title">{{item.orderItem[0].inventoryItem.bookSku.bookMaster.title}}</text>
             <text wx:if="{{item.orderItem.length > 1}}" class="more-count">+{{item.orderItem.length - 1}}</text>
          </view>
        </view>
        
        <!-- 锯齿边缘 (Bottom) -->
        <view class="receipt-edge bottom"></view>
      </view>

      <!-- 2. PENDING_PAYMENT: 倒计时紧迫风格 -->
      <view wx:elif="{{item.status === 'PENDING_PAYMENT'}}" 
            class="order-card urgency-card" 
            bind:tap="navigateToDetail" 
            data-order-id="{{item.id}}" 
            hover-class="card-hover">
        <view class="urgency-header">
          <view class="status-badge error">待支付</view>
          <text class="urgency-time">请尽快支付</text>
        </view>
        
        <view class="card-body">
          <view class="book-info-row">
            <image class="mini-cover" src="{{item.orderItem[0].inventoryItem.bookSku.cover_image_url || '/images/placeholder-cover.svg'}}" mode="aspectFill" />
            <view class="info-col">
              <text class="book-title">{{item.orderItem[0].inventoryItem.bookSku.bookMaster.title}}</text>
              <text class="order-total">{{filters.formatCurrency(item.total_amount)}}</text>
            </view>
          </view>
          <button class="pay-btn-small">去支付</button>
        </view>
      </view>

      <!-- 3. 其他状态 (COMPLETED, CANCELLED): 普通轻粘土卡片 -->
      <view wx:else 
            class="order-card history-card" 
            bind:tap="navigateToDetail" 
            data-order-id="{{item.id}}" 
            hover-class="card-hover">
        <view class="history-header">
           <text class="order-date">{{tools.formatOrderTime(item.createdAt)}}</text>
           <text class="status-text {{item.status === 'COMPLETED' ? 'success' : 'gray'}}">{{statusMap[item.status]}}</text>
        </view>
        
        <view class="history-body">
          <image class="mini-cover-sm" src="{{item.orderItem[0].inventoryItem.bookSku.cover_image_url || '/images/placeholder-cover.svg'}}" mode="aspectFill" />
          <view class="history-info">
             <text class="book-title-sm">{{item.orderItem[0].inventoryItem.bookSku.bookMaster.title}}</text>
             <text class="total-price-sm">{{filters.formatCurrency(item.total_amount)}}</text>
          </view>
        </view>
      </view>

    </block>

  </view>
</view>
