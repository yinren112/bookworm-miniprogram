<!-- pages/acquisition-scan/index.wxml -->
<wxs module="filters" src="../../utils/filters.wxs"></wxs>
<view class="container">
  <view class="header">
    <text class="header-title">扫码收购书籍</text>
    <text class="header-subtitle">扫描ISBN条码以添加书籍</text>
  </view>

  <!-- 扫码按钮 -->
  <button class="scan-button" bindtap="onScanCode">
    <text class="scan-icon">📷</text>
    <text class="scan-text">扫描ISBN条码</text>
  </button>

  <!-- 连续扫码开关 -->
  <view class="scan-mode-switch">
    <text class="switch-label">连续扫码模式</text>
    <switch checked="{{continuousMode}}" bindchange="onContinuousModeChange" color="#48BB78" />
  </view>

  <!-- 已扫描书籍列表 -->
  <view wx:if="{{scannedItems.length > 0}}" class="scanned-list {{scannedItems.length > 5 ? 'compact' : ''}}">
    <view class="list-header">
      <text class="list-title">已扫描书籍 ({{scannedItems.length}})</text>
      <text class="clear-btn" bindtap="onClearRejected" wx:if="{{hasRejectedItems}}">清理无效</text>
    </view>

    <view class="book-item {{item.status === 'acquirable' ? 'acquirable' : 'rejected'}}"
          wx:for="{{scannedItems}}"
          wx:key="index">
      <view class="book-info">
        <view class="book-header">
          <text class="book-title">{{item.skuInfo ? item.skuInfo.title : item.isbn}}</text>
          <view class="status-badge {{item.status}}">
            {{item.status === 'acquirable' ? '可收购' : '不收购'}}
          </view>
        </view>

        <text wx:if="{{item.skuInfo}}" class="book-author">{{item.skuInfo.author || '作者未知'}}</text>
        <text wx:if="{{item.skuInfo}}" class="book-edition">版本: {{item.skuInfo.edition || '未知'}}</text>


        <text wx:if="{{item.status === 'rejected'}}" class="rejection-reason">此书籍不在收购白名单中</text>
      </view>

      <view class="book-actions">
        <button class="remove-button" data-index="{{index}}" bindtap="onRemoveItem">移除</button>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:if="{{scannedItems.length === 0}}" class="empty-state">
    <image class="empty-img" src="/images/empty-shelf.png" mode="widthFix" />
    <text class="empty-text">还没有扫描任何书籍</text>
    <text class="empty-hint">点击上方按钮开始扫码</text>
  </view>

  <!-- 结算信息 -->
  <view wx:if="{{summary.count > 0}}" class="summary-section">

    <!-- 定价模式切换 -->
    <view class="mode-switcher">
      <view
        class="mode-tab {{pricingMode === 'bulk' ? 'active' : ''}}"
        bindtap="onSwitchMode"
        data-mode="bulk">
        快速模式
      </view>
      <view
        class="mode-tab {{pricingMode === 'individual' ? 'active' : ''}}"
        bindtap="onSwitchMode"
        data-mode="individual">
        精确模式
      </view>
    </view>

    <view class="summary-row">
      <text class="summary-label">可收购数量:</text>
      <text class="summary-value">{{summary.count}} 本</text>
    </view>

    <!-- 顾客手机号 -->
    <view class="input-row">
      <text class="input-label">顾客手机号:</text>
      <input
        class="text-input"
        type="number"
        value="{{customerPhone}}"
        bindinput="onPhoneInput"
        placeholder="请输入手机号"
        maxlength="11"
        confirm-type="next" />
    </view>

    <!-- 快速模式：按重量计价 -->
    <view wx:if="{{pricingMode === 'bulk'}}">
      <!-- 总重量 -->
      <view class="input-row">
        <text class="input-label">总重量 (kg):</text>
        <input
          class="number-input"
          type="digit"
          value="{{totalWeight}}"
          bindinput="onWeightInput"
          placeholder="0.00"
          confirm-type="next" />
      </view>

      <!-- 单价 -->
      <view class="input-row">
        <text class="input-label">单价 (元/kg):</text>
        <input
          class="number-input"
          type="digit"
          value="{{unitPriceYuan}}"
          bindinput="onUnitPriceInput"
          placeholder="0.00"
          confirm-type="next" />
      </view>
    </view>

    <!-- 精确模式：逐本定价 -->
    <view wx:if="{{pricingMode === 'individual'}}" class="individual-pricing">
      <view class="pricing-header">
        <text class="pricing-hint">为每本书设置品相和价格</text>
      </view>

      <!-- 批量设置工具栏 -->
      <view class="batch-toolbar">
        <input class="batch-input" placeholder="批量价格" type="digit" bindinput="onBatchPriceInput" />
        <button class="batch-btn" bindtap="onBatchApply">应用</button>
      </view>

      <view
        class="pricing-item"
        wx:for="{{scannedItems}}"
        wx:for-item="book"
        wx:key="index"
        wx:if="{{book.status === 'acquirable'}}">

        <view class="pricing-book-info">
          <text class="pricing-book-title">{{book.skuInfo.title}}</text>
          <text class="pricing-book-author">{{book.skuInfo.author}}</text>
        </view>

        <view class="pricing-controls">
          <!-- 品相选择器 -->
          <picker
            class="condition-picker"
            mode="selector"
            range="{{['全新', '良好', '可接受']}}"
            value="{{book.conditionIndex || 1}}"
            data-index="{{index}}"
            bindchange="onConditionChange">
            <view class="picker-display">
              {{['全新', '良好', '可接受'][book.conditionIndex || 1]}}
            </view>
          </picker>

          <!-- 价格输入 -->
          <view class="price-input-wrapper">
            <text class="price-prefix">¥</text>
            <input
              class="price-input"
              type="digit"
              value="{{book.individualPrice}}"
              data-index="{{index}}"
              bindinput="onIndividualPriceInput"
              placeholder="0.00"
              confirm-type="next" />
          </view>
        </view>
      </view>
    </view>

    <!-- 学生信息(可选) -->
    <view class="section-divider">
      <text class="divider-text">学生信息（可选，用于个性化推荐）</text>
    </view>

    <!-- 入学年份 -->
    <view class="input-row">
      <text class="input-label">入学年份:</text>
      <picker
        class="year-picker"
        mode="selector"
        range="{{yearRange}}"
        value="{{enrollmentYearIndex}}"
        bindchange="onYearChange">
        <view class="picker-display">
          {{enrollmentYear || '请选择'}}
        </view>
      </picker>
    </view>

    <!-- 专业 -->
    <view class="input-row">
      <text class="input-label">专业:</text>
      <input
        class="text-input"
        type="text"
        value="{{major}}"
        bindinput="onMajorInput"
        placeholder="如：计算机科学与技术"
        maxlength="100"
        confirm-type="next" />
    </view>

    <!-- 班级 -->
    <view class="input-row">
      <text class="input-label">班级:</text>
      <input
        class="text-input"
        type="text"
        value="{{className}}"
        bindinput="onClassNameInput"
        placeholder="如：1班"
        maxlength="50"
        confirm-type="done" />
    </view>

    <!-- 最终总金额 -->
    <view class="summary-row total">
      <text class="summary-label">最终总金额:</text>
      <text class="summary-value highlight">{{filters.formatCurrency(finalAmount)}}</text>
    </view>
  </view>

  <!-- 提交按钮 -->
  <view wx:if="{{summary.count > 0}}" class="submit-section">
    <button class="submit-button" bindtap="onSubmit" disabled="{{submitting}}">
      {{submitting ? '提交中...' : '确认收购'}}
    </button>
  </view>
</view>
