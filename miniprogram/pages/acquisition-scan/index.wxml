<!-- pages/acquisition-scan/index.wxml -->
<wxs module="filters" src="../../utils/filters.wxs"></wxs>
<view class="container">
  <view class="header">
    <text class="header-title">æ‰«ç æ”¶è´­ä¹¦ç±</text>
    <text class="header-subtitle">æ‰«æISBNæ¡ç ä»¥æ·»åŠ ä¹¦ç±</text>
  </view>

  <!-- æ‰«ç æŒ‰é’® -->
  <button class="scan-button" bindtap="onScanCode">
    <text class="scan-icon">ğŸ“·</text>
    <text class="scan-text">æ‰«æISBNæ¡ç </text>
  </button>

  <!-- å·²æ‰«æä¹¦ç±åˆ—è¡¨ -->
  <view wx:if="{{scannedItems.length > 0}}" class="scanned-list">
    <view class="list-header">
      <text class="list-title">å·²æ‰«æä¹¦ç± ({{scannedItems.length}})</text>
    </view>

    <view class="book-item {{item.status === 'acquirable' ? 'acquirable' : 'rejected'}}"
          wx:for="{{scannedItems}}"
          wx:key="index">
      <view class="book-info">
        <view class="book-header">
          <text class="book-title">{{item.skuInfo ? item.skuInfo.title : item.isbn}}</text>
          <view class="status-badge {{item.status}}">
            {{item.status === 'acquirable' ? 'å¯æ”¶è´­' : 'ä¸æ”¶è´­'}}
          </view>
        </view>

        <text wx:if="{{item.skuInfo}}" class="book-author">{{item.skuInfo.author || 'ä½œè€…æœªçŸ¥'}}</text>
        <text wx:if="{{item.skuInfo}}" class="book-edition">ç‰ˆæœ¬: {{item.skuInfo.edition || 'æœªçŸ¥'}}</text>


        <text wx:if="{{item.status === 'rejected'}}" class="rejection-reason">æ­¤ä¹¦ç±ä¸åœ¨æ”¶è´­ç™½åå•ä¸­</text>
      </view>

      <view class="book-actions">
        <button class="remove-button" data-index="{{index}}" bindtap="onRemoveItem">ç§»é™¤</button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{scannedItems.length === 0}}" class="empty-state">
    <text class="empty-icon">ğŸ“š</text>
    <text class="empty-text">è¿˜æ²¡æœ‰æ‰«æä»»ä½•ä¹¦ç±</text>
    <text class="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ‰«ç </text>
  </view>

  <!-- ç»“ç®—ä¿¡æ¯ -->
  <view wx:if="{{summary.count > 0}}" class="summary-section">

    <!-- å®šä»·æ¨¡å¼åˆ‡æ¢ -->
    <view class="mode-switcher">
      <view
        class="mode-tab {{pricingMode === 'bulk' ? 'active' : ''}}"
        bindtap="onSwitchMode"
        data-mode="bulk">
        å¿«é€Ÿæ¨¡å¼
      </view>
      <view
        class="mode-tab {{pricingMode === 'individual' ? 'active' : ''}}"
        bindtap="onSwitchMode"
        data-mode="individual">
        ç²¾ç¡®æ¨¡å¼
      </view>
    </view>

    <view class="summary-row">
      <text class="summary-label">å¯æ”¶è´­æ•°é‡:</text>
      <text class="summary-value">{{summary.count}} æœ¬</text>
    </view>

    <!-- é¡¾å®¢æ‰‹æœºå· -->
    <view class="input-row">
      <text class="input-label">é¡¾å®¢æ‰‹æœºå·:</text>
      <input
        class="text-input"
        type="number"
        value="{{customerPhone}}"
        bindinput="onPhoneInput"
        placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
        maxlength="11" />
    </view>

    <!-- å¿«é€Ÿæ¨¡å¼ï¼šæŒ‰é‡é‡è®¡ä»· -->
    <view wx:if="{{pricingMode === 'bulk'}}">
      <!-- æ€»é‡é‡ -->
      <view class="input-row">
        <text class="input-label">æ€»é‡é‡ (kg):</text>
        <input
          class="number-input"
          type="digit"
          value="{{totalWeight}}"
          bindinput="onWeightInput"
          placeholder="0.00" />
      </view>

      <!-- å•ä»· -->
      <view class="input-row">
        <text class="input-label">å•ä»· (å…ƒ/kg):</text>
        <input
          class="number-input"
          type="digit"
          value="{{unitPriceYuan}}"
          bindinput="onUnitPriceInput"
          placeholder="0.00" />
      </view>
    </view>

    <!-- ç²¾ç¡®æ¨¡å¼ï¼šé€æœ¬å®šä»· -->
    <view wx:if="{{pricingMode === 'individual'}}" class="individual-pricing">
      <view class="pricing-header">
        <text class="pricing-hint">ä¸ºæ¯æœ¬ä¹¦è®¾ç½®å“ç›¸å’Œä»·æ ¼</text>
      </view>

      <view
        class="pricing-item"
        wx:for="{{scannedItems}}"
        wx:for-item="book"
        wx:key="index"
        wx:if="{{book.status === 'acquirable'}}">

        <view class="pricing-book-info">
          <text class="pricing-book-title">{{book.skuInfo.title}}</text>
          <text class="pricing-book-author">{{book.skuInfo.author}}</text>
        </view>

        <view class="pricing-controls">
          <!-- å“ç›¸é€‰æ‹©å™¨ -->
          <picker
            class="condition-picker"
            mode="selector"
            range="{{['å…¨æ–°', 'è‰¯å¥½', 'å¯æ¥å—']}}"
            value="{{book.conditionIndex || 1}}"
            data-index="{{index}}"
            bindchange="onConditionChange">
            <view class="picker-display">
              {{['å…¨æ–°', 'è‰¯å¥½', 'å¯æ¥å—'][book.conditionIndex || 1]}}
            </view>
          </picker>

          <!-- ä»·æ ¼è¾“å…¥ -->
          <view class="price-input-wrapper">
            <text class="price-prefix">Â¥</text>
            <input
              class="price-input"
              type="digit"
              value="{{book.individualPrice}}"
              data-index="{{index}}"
              bindinput="onIndividualPriceInput"
              placeholder="0.00" />
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ç”Ÿä¿¡æ¯(å¯é€‰) -->
    <view class="section-divider">
      <text class="divider-text">å­¦ç”Ÿä¿¡æ¯ï¼ˆå¯é€‰ï¼Œç”¨äºä¸ªæ€§åŒ–æ¨èï¼‰</text>
    </view>

    <!-- å…¥å­¦å¹´ä»½ -->
    <view class="input-row">
      <text class="input-label">å…¥å­¦å¹´ä»½:</text>
      <picker
        class="year-picker"
        mode="selector"
        range="{{yearRange}}"
        value="{{enrollmentYearIndex}}"
        bindchange="onYearChange">
        <view class="picker-display">
          {{enrollmentYear || 'è¯·é€‰æ‹©'}}
        </view>
      </picker>
    </view>

    <!-- ä¸“ä¸š -->
    <view class="input-row">
      <text class="input-label">ä¸“ä¸š:</text>
      <input
        class="text-input"
        type="text"
        value="{{major}}"
        bindinput="onMajorInput"
        placeholder="å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯"
        maxlength="100" />
    </view>

    <!-- ç­çº§ -->
    <view class="input-row">
      <text class="input-label">ç­çº§:</text>
      <input
        class="text-input"
        type="text"
        value="{{className}}"
        bindinput="onClassNameInput"
        placeholder="å¦‚ï¼š1ç­"
        maxlength="50" />
    </view>

    <!-- æœ€ç»ˆæ€»é‡‘é¢ -->
    <view class="summary-row total">
      <text class="summary-label">æœ€ç»ˆæ€»é‡‘é¢:</text>
      <text class="summary-value highlight">{{filters.formatCurrency(finalAmount)}}</text>
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view wx:if="{{summary.count > 0}}" class="submit-section">
    <button class="submit-button" bindtap="onSubmit" disabled="{{submitting}}">
      {{submitting ? 'æäº¤ä¸­...' : 'ç¡®è®¤æ”¶è´­'}}
    </button>
  </view>
</view>
