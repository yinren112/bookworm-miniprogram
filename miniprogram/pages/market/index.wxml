<!-- pages/market/index.wxml -->
<import src="../../templates/search-bar.wxml" />

<view class="container">
  <view class="header-title">二手书市场</view>

  <template is="searchBar" data="{{placeholder: '搜索书名、作者或ISBN', searchTerm: searchTerm}}" />

  <!-- Personalized Recommendations Section -->
  <view wx:if="{{recommendations.length > 0}}" class="recommendations-section">
    <view class="section-header">
      <text class="section-title">为你推荐</text>
      <text class="section-subtitle">根据你的专业和年级精选</text>
    </view>
    <scroll-view class="recommendations-scroll" scroll-x="true" enable-flex="true">
      <view class="recommendation-card card"
            wx:for="{{recommendations}}"
            wx:key="skuId"
            data-isbn="{{item.isbn}}"
            bindtap="handleRecommendationTap">
        <image class="recommendation-cover"
               src="{{item.coverImageUrl || '/images/placeholder-cover.svg'}}"
               mode="aspectFill" />
        <view class="recommendation-info">
          <text class="recommendation-title">{{item.title}}</text>
          <text class="recommendation-author">{{item.author || '作者未知'}}</text>
          <view class="recommendation-meta">
            <text class="recommendation-price">¥{{item.minPrice / 100}}</text>
            <text class="recommendation-stock">库存{{item.availableCount}}本</text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- Skeleton Loading State -->
  <skeleton wx:if="{{state.status === 'loading'}}" type="grid" count="4" />

  <view wx:if="{{state.status === 'error'}}" class="error-message">{{state.error}}</view>
  <view wx:if="{{state.status === 'success' && state.data.length === 0}}" class="empty-state">
    <text>{{searchPerformed ? '没有找到匹配的图书' : '暂时没有可售图书'}}</text>
  </view>

  <!-- Real Content -->
  <view wx:if="{{state.status === 'success' && state.data.length > 0}}" class="book-grid">
    <navigator wx:for="{{state.data}}" wx:key="id" class="book-card-navigator" url="/pages/book-detail/index?id={{item.id}}" hover-class="none">
      <view class="book-card card" hover-class="item-hover">
        <image class="book-cover" src="{{item.booksku.cover_image_url || '/images/placeholder-cover.svg'}}" mode="aspectFill" />
        <view class="book-info">
          <text class="book-title">{{item.booksku.bookmaster.title}}</text>
          <text class="book-author">{{item.booksku.bookmaster.author}}</text>
          <view class="book-meta">
            <text>版本: {{item.booksku.edition}}</text>
            <text>品相: {{item.condition}}</text>
          </view>
          <text class="book-price">¥{{item.selling_price}}</text>
        </view>
      </view>
    </navigator>
  </view>
</view>