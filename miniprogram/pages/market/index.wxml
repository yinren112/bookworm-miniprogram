<!-- pages/market/index.wxml -->
<wxs module="filters" src="../../utils/filters.wxs"></wxs>
<import src="../../templates/search-bar.wxml" />

<view class="container market-container">
  
  <!-- Search Bar (Sticky or just top) -->
  <view class="search-section">
    <template is="searchBar" data="{{placeholder: 'Find books, authors...', searchTerm: searchTerm}}" />
  </view>

  <!-- Personalized Recommendations Section -->
  <view wx:if="{{recommendations.length > 0}}" class="recommendations-section">
    <view class="section-title">为你推荐</view>
    <scroll-view class="recommendations-scroll" scroll-x="true" enable-flex="true">
      <!-- Hero Card Style for Recommendations -->
      <view class="hero-card"
            wx:for="{{recommendations}}"
            wx:key="skuId"
            data-isbn="{{item.isbn}}"
            bindtap="handleRecommendationTap">
        <view class="hero-bg-circle"></view>
        <view class="hero-text">
          <view class="hero-badge">推荐</view>
          <view class="hero-h1">{{item.title}}</view>
          <view class="hero-sub">{{item.author || '作者未知'}}</view>
          <view class="hero-price">{{filters.formatCurrencyFromCents(item.minPrice)}}</view>
        </view>
        <view class="hero-img-box">
           <image class="hero-img" 
                  src="{{item.coverImageUrl || '/images/placeholder-cover.svg'}}" 
                  mode="aspectFill" 
                  binderror="onImageError"
                  data-type="recommendation"
                  data-index="{{index}}" />
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- New Arrivals / Main Grid -->
  <view class="section-title">新书上架</view>

  <!-- Skeleton Loading State -->
  <loading-state wx:if="{{state.status === 'loading'}}" variant="page" text="加载中..." />

  <error-state
    wx:if="{{state.status === 'error'}}"
    mode="network"
    title="加载失败"
    desc="{{state.error}}"
    bind:retry="onRetry"
  />
  <empty-state
    wx:if="{{state.status === 'success' && state.data.length === 0}}"
    title="{{searchPerformed ? '没有找到匹配的图书' : '暂时没有可售图书'}}"
    desc="{{searchPerformed ? '换个关键词试试' : '稍后再来看看'}}"
    actionText="清空搜索"
    actionType="outline"
    showAction="{{searchPerformed}}"
    bind:action="onClearSearch"
  />

  <!-- Real Content Grid -->
  <view wx:if="{{(state.status === 'success' || state.status === 'error') && state.data.length > 0}}" class="book-grid">
    <navigator wx:for="{{state.data}}" wx:key="id" class="book-card-navigator" url="/pages/book-detail/index?id={{item.id}}" hover-class="none">
      <view class="book-card" hover-class="card-hover">
        <!-- 图片凹陷容器 -->
        <view class="card-img-container">
          <image class="book-cover" 
                 src="{{item.booksku.cover_image_url || '/images/placeholder-cover.svg'}}" 
                 mode="aspectFill" 
                 binderror="onImageError"
                 data-type="grid"
                 data-index="{{index}}" />
        </view>
        
        <view class="card-content">
          <text class="book-title">{{item.booksku.bookmaster.title}}</text>
          <text class="book-author">{{item.booksku.bookmaster.author}}</text>
          
          <view class="card-footer">
            <text class="book-price">{{filters.formatCurrency(item.selling_price)}}</text>
            <view class="add-btn">+</view>
          </view>
        </view>
      </view>
    </navigator>
  </view>
</view>
