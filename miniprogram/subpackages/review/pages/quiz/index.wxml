<!-- subpackages/review/pages/quiz/index.wxml -->
<!-- åˆ·é¢˜é—¯å…³é¡µ -->
<view class="container">
  <!-- è¿›åº¦æ¡ -->
  <view class="progress-section" wx:if="{{!loading && !completed && questions.length > 0}}">
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progressPercent}}%"></view>
    </view>
    <view class="progress-info">
      <text class="progress-text">{{currentIndex + 1}} / {{questions.length}}</text>
      <text class="accuracy-text" wx:if="{{answeredCount > 0}}">
        æ­£ç¡®ç‡ {{Math.round(correctCount / answeredCount * 100)}}%
      </text>
    </view>
  </view>
  <!-- é¢˜ç›®åŒºåŸŸ -->
  <view class="question-card clay-card" wx:if="{{!loading && !completed && currentQuestion}}">
    <!-- é¢˜ç›®ç±»å‹æ ‡ç­¾ -->
    <view class="question-type-tag {{currentQuestion.questionType.toLowerCase()}}">
      <text>{{questionTypeLabels[currentQuestion.questionType]}}</text>
    </view>
    <!-- é¢˜å¹² -->
    <view class="question-stem">
      <mp-html content="{{currentQuestion.stem}}" markdown="{{true}}" />
    </view>
    <!-- é€‰é¡¹åŒºåŸŸ -->
    <view class="options-section" wx:if="{{currentQuestion.questionType !== 'FILL_BLANK'}}">
      <view class="option-item {{optionStates[index].isSelected ? 'selected' : ''}} {{showResult && optionStates[index].isCorrect ? 'correct' : ''}} {{showResult && optionStates[index].isWrong ? 'wrong' : ''}}" wx:for="{{currentQuestion.options}}" wx:key="index" bindtap="selectOption" data-index="{{index}}">
        <view class="option-marker">{{optionLabels[index]}}</view>
        <view class="option-content">
          <mp-html content="{{item}}" markdown="{{true}}" />
        </view>
        <view class="option-icon" wx:if="{{showResult && optionStates[index].isCorrect}}">âœ“</view>
        <view class="option-icon wrong" wx:if="{{showResult && optionStates[index].isWrong}}">
          âœ—
        </view>
      </view>
      <button class="submit-multi-btn" bindtap="submitMultiChoice" wx:if="{{currentQuestion.questionType === 'MULTI_CHOICE' && !showResult && selectedAnswers.length > 0}}">
        æäº¤
      </button>
    </view>
    <!-- å¡«ç©ºé¢˜è¾“å…¥ -->
    <view class="fill-blank-section" wx:if="{{currentQuestion.questionType === 'FILL_BLANK'}}">
      <input class="fill-input {{showResult ? (lastResult.isCorrect ? 'correct' : 'wrong') : ''}}" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" value="{{fillAnswer}}" bindinput="onFillInput" disabled="{{showResult}}" />
      <button class="submit-fill-btn" bindtap="submitFillAnswer" wx:if="{{!showResult && fillAnswer}}">
        æäº¤
      </button>
    </view>
    <!-- ç»“æœåé¦ˆ -->
    <view class="result-section" wx:if="{{showResult}}">
      <view class="result-badge {{lastResult.isCorrect ? 'correct' : 'wrong'}}">
        <text>{{lastResult.isCorrect ? 'å›ç­”æ­£ç¡®' : 'å›ç­”é”™è¯¯'}}</text>
      </view>
      <view class="explanation" wx:if="{{lastResult.explanation}}">
        <text class="explanation-label">è§£æï¼š</text>
        <view class="explanation-text">
          <mp-html content="{{lastResult.explanation}}" markdown="{{true}}" />
        </view>
      </view>
      <view class="correct-answer" wx:if="{{!lastResult.isCorrect}}">
        <text class="answer-label">æ­£ç¡®ç­”æ¡ˆï¼š</text>
        <view class="answer-text">
          <mp-html content="{{correctAnswerText}}" markdown="{{true}}" />
        </view>
      </view>
    </view>
    <!-- çº é”™æŒ‰é’® -->
    <view class="report-btn-wrapper">
      <view class="report-btn" bindtap="openReportModal">
        <text>ğŸš¨ å†…å®¹æœ‰è¯¯ï¼Ÿç‚¹å‡»åé¦ˆ</text>
      </view>
    </view>
  </view>
  <!-- ä¸‹ä¸€é¢˜æŒ‰é’® -->
  <view class="action-section" wx:if="{{showResult && !completed}}">
    <button class="next-btn clay-btn-primary" bindtap="nextQuestion">
      {{currentIndex < questions.length - 1 ? 'ä¸‹ä¸€é¢˜' : 'æŸ¥çœ‹ç»“æœ'}}
    </button>
  </view>
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <text class="loading-text">åŠ è½½é¢˜ç›®ä¸­...</text>
  </view>
  <!-- å®ŒæˆçŠ¶æ€ -->
  <view class="complete-state" wx:if="{{!loading && completed}}">
    <view class="complete-icon">
      {{correctCount === questions.length ? 'ğŸ†' : (correctCount >= questions.length * 0.6 ? 'ğŸ‰' : 'ğŸ’ª')}}
    </view>
    <text class="complete-title">
      {{correctCount === questions.length ? 'æ»¡åˆ†é€šå…³!' : (correctCount >= questions.length * 0.6 ? 'ç­”é¢˜å®Œæˆ!' : 'ç»§ç»­åŠ æ²¹!')}}
    </text>
    <view class="stats-card clay-card">
      <view class="stat-row">
        <text class="stat-label">ç­”å¯¹</text>
        <text class="stat-value correct">{{correctCount}}</text>
      </view>
      <view class="stat-row">
        <text class="stat-label">ç­”é”™</text>
        <text class="stat-value wrong">{{questions.length - correctCount}}</text>
      </view>
      <view class="stat-row">
        <text class="stat-label">æ­£ç¡®ç‡</text>
        <text class="stat-value">{{Math.round(correctCount / questions.length * 100)}}%</text>
      </view>
    </view>
    <view class="complete-actions">
      <button class="retry-btn" bindtap="retryQuiz" wx:if="{{correctCount < questions.length}}">
        é‡åšé”™é¢˜
      </button>
      <button class="back-btn clay-btn-primary" bindtap="goBack">è¿”å›è¯¾ç¨‹</button>
    </view>
  </view>
  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && !completed && questions.length === 0}}">
    <text class="empty-text">æš‚æ— é¢˜ç›®</text>
    <button class="back-btn" bindtap="goBack">è¿”å›è¯¾ç¨‹</button>
  </view>
  <!-- çº é”™å¼¹çª— -->
  <report-issue visible="{{showReportModal}}" courseKey="{{courseKey}}" questionId="{{currentQuestion.id}}" bind:close="closeReportModal" bind:success="onReportSuccess" />
</view>