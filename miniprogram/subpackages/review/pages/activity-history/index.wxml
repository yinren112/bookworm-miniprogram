<!-- subpackages/review/pages/activity-history/index.wxml -->
<view class="page">
  <loading-state wx:if="{{loading}}" variant="page" text="正在加载学习记录..." />
  <view wx:elif="{{error}}" class="hist-boundary">
    <error-state title="加载失败" desc="请重试" bind:retry="onRetry" />
    <view class="hist-boundary__extra">
      <juicy-button type="secondary" size="sm" bind:tap="onFeedback">反馈</juicy-button>
    </view>
  </view>
  <empty-state
    wx:elif="{{empty}}"
    title="暂无记录"
    desc="先完成一轮练习"
    actionText="返回首页"
    actionType="secondary"
    showAction
    bind:action="goHome"
  />

  <scroll-view wx:else scroll-y class="content">
    <!-- 概要栏 -->
    <view class="summary-card">
      <card-flat>
        <view class="summary">
          <view class="summary-item">
            <text class="summary-label">今日</text>
            <text class="summary-value">{{todayDurationText}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">累计</text>
            <text class="summary-value">{{totalDurationText}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">连续</text>
            <text class="summary-value">{{streakDays}}天</text>
          </view>
        </view>
      </card-flat>
    </view>

    <!-- 日历网格 -->
    <view class="calendar-card">
      <card-flat>
        <!-- 月份导航 -->
        <view class="month-nav">
          <view class="month-arrow pressable" bindtap="prevMonth" hover-class="hover-pressed" hover-stay-time="80">
            <text class="arrow-text">‹</text>
          </view>
          <text class="month-label">{{monthLabel}}</text>
          <view class="month-arrow pressable {{canGoNext ? '' : 'disabled'}}" bindtap="nextMonth" hover-class="{{canGoNext ? 'hover-pressed' : ''}}" hover-stay-time="80">
            <text class="arrow-text">›</text>
          </view>
        </view>

        <!-- 星期标题 -->
        <view class="weekday-row">
          <text class="weekday-label">日</text>
          <text class="weekday-label">一</text>
          <text class="weekday-label">二</text>
          <text class="weekday-label">三</text>
          <text class="weekday-label">四</text>
          <text class="weekday-label">五</text>
          <text class="weekday-label">六</text>
        </view>

        <!-- 日历格子 -->
        <view class="calendar-grid">
          <block wx:for="{{calendarDays}}" wx:key="index">
            <view wx:if="{{item.empty}}" class="cal-cell cal-cell--empty"></view>
            <view
              wx:else
              class="cal-cell cal-cell--day level-{{item.level}} {{item.isToday ? 'is-today' : ''}} {{selectedDate === item.date ? 'is-selected' : ''}}"
              bindtap="onDayTap"
              data-date="{{item.date}}"
            >
              <text class="cal-day-num">{{item.day}}</text>
              <view wx:if="{{item.isToday}}" class="today-dot"></view>
            </view>
          </block>
        </view>

        <!-- 展开详情 -->
        <view class="detail-expand {{selectedDetail ? 'is-open' : ''}}">
          <view wx:if="{{selectedDetail}}" class="detail-inner">
            <view class="detail-header">
              <text class="detail-date">{{selectedDetail.dateLabel}}</text>
              <pill-tag variant="neutral" size="sm">Lv {{selectedDetail.level}}</pill-tag>
            </view>
            <text class="detail-total">{{selectedDetail.hasData ? '总计 ' + selectedDetail.totalText : '无学习记录'}}</text>
            <text wx:if="{{selectedDetail.breakdownText}}" class="detail-breakdown">{{selectedDetail.breakdownText}}</text>
          </view>
        </view>
      </card-flat>
    </view>
  </scroll-view>
</view>
