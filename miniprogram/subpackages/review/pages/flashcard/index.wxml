<!-- subpackages/review/pages/flashcard/index.wxml -->
<!-- 卡片复习页 -->
<wxs src="../../utils/swipe-gesture.wxs" module="gesture" />
<view class="container" bindtouchstart="onUserInteraction" bindtouchmove="onUserInteraction">
  <loading-state wx:if="{{loading}}" variant="page" text="正在加载知识卡片..." />
  <view wx:elif="{{error}}" class="flash-boundary">
    <error-state title="加载失败" desc="请重试" bind:retry="loadSession" />
    <view class="flash-boundary__extra">
      <juicy-button type="secondary" size="sm" bind:tap="onFeedback">反馈</juicy-button>
    </view>
  </view>
  <empty-state
    wx:elif="{{empty}}"
    title="今日已完成"
    desc="今天的卡片都复习完了"
    actionText="返回首页"
    actionType="secondary"
    showAction
    bind:action="goBack"
  />

  <view class="progress-header" wx:if="{{!loading && !error && !empty}}">
    <progress-chunky percent="{{progressPercent}}" color="green" label="进度" showLabel />
    <view class="progress-meta">
      <pill-tag variant="neutral" size="sm">{{currentIndex + 1}} / {{cardsLength}}</pill-tag>
      <pill-tag variant="neutral" size="sm" wx:if="{{remainingMinutes > 0}}">剩余约 {{remainingMinutes}} 分钟</pill-tag>
    </view>
  </view>
  <!-- Pending Complete 态（最后一张滑走，等待 undo 窗口） -->
  <view class="pending-complete" wx:if="{{pendingComplete && !loading && !error}}">
    <view class="pending-complete-inner">
      <text class="pending-complete-text">即将完成本轮复习</text>
    </view>
  </view>
  <!-- 卡片区域 -->
  <view class="card-wrapper" wx:if="{{!loading && !error && !empty && !pendingComplete && currentCard}}">
    <view class="star-btn {{isStarred ? 'starred' : ''}}" catchtap="toggleStar">
      <view class="star-hit {{isStarred ? 'starred' : ''}}">
        <image class="star-icon" src="/images/icons/review/star-{{isStarred ? 'filled' : 'outline'}}.svg" mode="aspectFit" />
      </view>
    </view>
    <view id="swipe-card" class="card-container" style="{{cardInlineStyle}}" data-screen-width="{{screenWidth}}" bindtouchstart="{{gesture.touchStart}}" bindtouchmove="{{gesture.touchMove}}" bindtouchend="{{gesture.touchEnd}}">
      <view class="card-stack {{isFlipped ? 'is-flipped' : ''}} {{swipeExitClass}} {{cardTransitionClass}}">
        <view class="face-front" bindtap="flipCard">
          <card-flat>
            <view class="card-face">
              <view class="card-label">Q</view>
              <view class="card-content">
                <mp-html content="{{currentCard.front}}" markdown="{{false}}" />
              </view>
              <view class="card-hint"><text>轻触翻牌</text></view>
            </view>
          </card-flat>
        </view>
        <view class="face-back" bindtap="flipCard">
          <card-flat>
            <view class="card-face">
              <view class="card-label">A</view>
              <view class="card-content">
                <mp-html content="{{currentCard.back}}" markdown="{{false}}" />
              </view>
            </view>
          </card-flat>
        </view>

        <view id="indicator-left-light" class="swipe-indicator fuzzy-overlay"><text>有点模糊</text></view>
        <view id="indicator-left-heavy" class="swipe-indicator forgot-overlay"><text>想不起来</text></view>
        <view id="indicator-right-light" class="swipe-indicator knew-overlay"><text>记住了</text></view>
        <view id="indicator-right-heavy" class="swipe-indicator perfect-overlay"><text>完全掌握</text></view>
      </view>
    </view>
  </view>
  <!-- 滑动引导遮罩（首次，4级评分教学） -->
  <view class="swipe-hint-overlay" wx:if="{{showSwipeHint}}" catchtap="dismissSwipeHint">
    <view class="swipe-tutorial" catchtap="noop">
      <text class="tutorial-title">滑动评分</text>
      <text class="tutorial-sub">看完答案后，滑动卡片评价记忆程度</text>
      <view class="tutorial-levels">
        <view class="tutorial-row tutorial-left">
          <view class="tutorial-direction">← 左滑</view>
          <view class="tutorial-items">
            <view class="tutorial-item forgot">
              <text class="tutorial-label">重滑</text>
              <text class="tutorial-name">想不起来</text>
            </view>
            <view class="tutorial-item fuzzy">
              <text class="tutorial-label">轻滑</text>
              <text class="tutorial-name">有点模糊</text>
            </view>
          </view>
        </view>
        <view class="tutorial-row tutorial-right">
          <view class="tutorial-direction">右滑 →</view>
          <view class="tutorial-items">
            <view class="tutorial-item knew">
              <text class="tutorial-label">轻滑</text>
              <text class="tutorial-name">记住了</text>
            </view>
            <view class="tutorial-item perfect">
              <text class="tutorial-label">重滑</text>
              <text class="tutorial-name">完全掌握</text>
            </view>
          </view>
        </view>
      </view>
      <juicy-button type="primary" size="sm" bind:tap="dismissSwipeHint">知道了</juicy-button>
    </view>
  </view>
  <!-- 内联滑动提示 -->
  <view class="swipe-tip" wx:if="{{showSwipeTip && isFlipped}}">
    <text>← 滑动卡片 或 点击按钮 →</text>
  </view>
  <!-- 反馈按钮 (Bottom Golden Zone) -->
  <view class="feedback-zone" wx:if="{{!loading && !error && !empty && !pendingComplete && currentCard && isFlipped}}">
    <view class="feedback-buttons">
      <juicy-button type="secondary" size="sm" hapticEnabled="{{false}}" data-rating="FORGOT" bind:tap="submitFeedback">
        <view class="feedback-btn-content">
          <image class="btn-icon" src="/images/icons/review/forgot.svg" mode="aspectFit" />
          <text>想不起来</text>
        </view>
      </juicy-button>
      <juicy-button type="secondary" size="sm" hapticEnabled="{{false}}" data-rating="FUZZY" bind:tap="submitFeedback">
        <view class="feedback-btn-content">
          <image class="btn-icon" src="/images/icons/review/fuzzy.svg" mode="aspectFit" />
          <text>有点模糊</text>
        </view>
      </juicy-button>
      <juicy-button type="secondary" size="sm" hapticEnabled="{{false}}" data-rating="KNEW" bind:tap="submitFeedback">
        <view class="feedback-btn-content">
          <image class="btn-icon" src="/images/icons/review/knew.svg" mode="aspectFit" />
          <text>记住了</text>
        </view>
      </juicy-button>
      <juicy-button type="secondary" size="sm" hapticEnabled="{{false}}" data-rating="PERFECT" bind:tap="submitFeedback">
        <view class="feedback-btn-content">
          <image class="btn-icon" src="/images/icons/review/perfect.svg" mode="aspectFit" />
          <text>完全掌握</text>
        </view>
      </juicy-button>
    </view>
  </view>
  <!-- 翻转提示 -->
  <view class="flip-hint" wx:if="{{!loading && !error && !empty && !pendingComplete && currentCard && !isFlipped}}">
    <text>点击卡片查看答案</text>
  </view>
  <!-- 纠错按钮 -->
  <view class="report-btn-wrapper" wx:if="{{!loading && !error && !empty && !pendingComplete && currentCard}}">
    <view class="report-btn" bindtap="openReportModal">
      <text>发现问题？帮我们改进</text>
    </view>
  </view>
  <!-- 撤销条 -->
  <view class="undo-bar" wx:if="{{undoVisible}}" catchtap="undoLastSwipe">
    <view class="undo-bar-content">
      <text class="undo-bar-text">已标记为「{{undoRatingText}}」</text>
      <view class="undo-btn">
        <text>撤销</text>
      </view>
    </view>
  </view>
  <!-- 纠错弹窗 -->
  <report-issue visible="{{showReportModal}}" courseKey="{{courseKey}}" cardId="{{currentCard.id}}" bind:close="closeReportModal" bind:success="onReportSuccess" />
</view>
