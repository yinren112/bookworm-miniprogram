# 小程序性能调查报告

**调查日期:** 2026-01-31  
**调查范围:** miniprogram/ 目录  
**调查人:** Linus Torvalds (AI Assistant)

---

## 执行结果

✓ **7项检查通过**  
❌ **4项需要优化**  
⏭️ **11项总计**

---

## 架构概览

### 包结构

| 模块 | 页面数 | 状态 |
|------|--------|------|
| 主包页面 | 12个 | 5个已注册，7个遗留未使用 |
| 复习分包 | 8个 | 全部使用 |
| 全局组件 | 10个 | UI组件库 |

### 注册页面清单

**已注册TabBar页面:**
- `pages/review/index` - 复习首页（TabBar首页）
- `pages/profile/index` - 个人中心
- `pages/terms/index` - 用户协议
- `pages/webview/index` - 通用WebView
- `pages/customer-service/index` - 客服

**分包页面 (subpackages/review):**
- `course/index` - 课程详情
- `flashcard/index` - 背卡模式
- `quiz/index` - 刷题模式
- `cheatsheet/index` - 急救包列表
- `cheatsheet-note/index` - 急救包笔记
- `leaderboard/index` - 周榜
- `session-complete/index` - 结算完成
- `activity-history/index` - 学习热力图

**遗留未注册页面:**
- `market/index` - 书城
- `book-detail/index` - 书籍详情
- `orders/index` - 订单列表
- `order-confirm/index` - 订单确认
- `order-detail/index` - 订单详情
- `acquisition-scan/index` - 收购扫码
- `review-entry/index` - 遗留重定向页

---

## 通过项（✓ 7项）

### 1. 分包加载策略

**状态:** ✅ 通过

配置详情:
```json
{
  "subpackages": [{
    "root": "subpackages/review",
    "name": "review",
    "pages": ["pages/course/index", ...]
  }],
  "preloadRule": {
    "pages/review/index": {
      "network": "all",
      "packages": ["review"]
    }
  }
}
```

**分析:**
- 首页进入时自动预加载复习分包，用户点击课程/背卡时无需等待
- 分包大小合理（8个页面），不会造成首次加载阻塞

### 2. SWR缓存策略

**状态:** ✅ 通过

实现文件: `utils/cache.js`

缓存TTL:
- Dashboard数据: 10分钟 (600000ms)
- 课程列表: 10分钟 (600000ms)

核心逻辑:
```javascript
// 先返回缓存（如果未过期），并行后台刷新
async function swrFetch(key, fetcher, { ttlMs = 30000 } = {}) {
  const cached = await getAsync(key);
  
  // 缓存有效时先返回缓存
  if (cached && !isExpired(cached)) {
    // 后台刷新不阻塞
    fetcher()
      .then(freshData => {
        setWithTTL(key, freshData, ttlMs);
        publish(key, freshData); // 事件通知更新
      })
      .catch(() => { /* 静默处理 */ });
    return cached.data;
  }
  // 无缓存时直接拉取
}
```

**分析:**
- SWR模式实现正确，提升感知性能
- 订阅/发布模式避免回调地狱

### 3. 请求重试机制

**状态:** ✅ 通过

实现文件: `utils/request.js`

重试策略:
| 条件 | 策略 |
|------|------|
| 方法 | 仅GET/HEAD支持重试 |
| 触发条件 | 网络错误或5xx状态码 |
| 重试次数 | 3次 |
| 退避延迟 | 100ms → 300ms → 900ms |

代码示例:
```javascript
const RETRY_DELAYS = [100, 300, 900];
const MAX_RETRIES = RETRY_DELAYS.length;

if (shouldRetry(method, isNetworkError, statusCode) && attempt < MAX_RETRIES) {
  const delayMs = RETRY_DELAYS[attempt];
  await sleep(delayMs);
  // 重试逻辑...
}
```

### 4. 懒加载组件

**状态:** ✅ 通过

配置: `app.json`
```json
{
  "lazyCodeLoading": "requiredComponents"
}
```

### 5. 性能追踪

**状态:** ✅ 通过

实现文件: `app.js:107-130`

追踪指标:
- `performance_navigation` - 导航耗时
- `performance_render` - 渲染耗时

### 6. Request-ID全链路追踪

**状态:** ✅ 通过

实现:
- 每次逻辑请求生成 `timestamp-random` 格式ID
- 重试链路复用同一requestId
- 后端回写响应头，便于端到端排障

### 7. 超时配置

**状态:** ✅ 通过

配置:
- 默认超时: 8000ms（8秒）
- 位置: `utils/request.js:88`

---

## 需要优化项（❌ 4项）

### 1. 主包冗余页面（高优先级）

**问题:** 主包包含12个页面，实际仅5个注册使用

**影响:**
- 主包体积膨胀
- 首次启动加载时间增加
- 小程序审核包大小限制压力

**遗留页面清单:**
| 页面 | 用途 | 建议 |
|------|------|------|
| `market/index` | 书城 | 移至独立分包或删除 |
| `book-detail/index` | 书籍详情 | 移至独立分包或删除 |
| `orders/index` | 订单列表 | 移至独立分包或删除 |
| `order-confirm/index` | 订单确认 | 移至独立分包或删除 |
| `order-detail/index` | 订单详情 | 移至独立分包或删除 |
| `acquisition-scan/index` | 收购扫码 | 移至独立分包或删除 |
| `review-entry/index` | 重定向页 | 删除 |

**代码位置:**
- `pages/market/`
- `pages/book-detail/`
- `pages/orders/`
- `pages/order-confirm/`
- `pages/order-detail/`
- `pages/acquisition-scan/`
- `pages/review-entry/`

**建议操作:**
1. 短期: 从主包移至独立分包 `subpackages/market/`
2. 长期: 删除交易相关代码（复习模式下不使用）

---

### 2. 音效同步预加载（中优先级）

**问题:** `soundManager.preload()` 在 `onLoad` 同步执行

**代码位置:** `pages/review/index.js:43`
```javascript
onLoad(options) {
  this.setTodayDate();
  soundManager.preload(); // ⚠️ 同步预加载
  // ...
}
```

**影响:**
- 首页首次加载阻塞
- 即使用户不点击"开始学习"也加载音效资源

**建议:**
```javascript
// 改为懒加载
startPrimaryCta() {
  soundManager.preload(); // 首次交互时再加载
  this.triggerHaptic('medium');
  // ...
}
```

---

### 3. mp-html体积问题（中优先级）

**问题:** 第三方富文本组件mp-html体积较大

**位置:** `components/mp-html/`

**包含:**
- LaTeX公式渲染
- 数学字体文件
- 完整HTML解析器

**影响:**
- 包体积增加约200-500KB
- 复习模式下使用频率低

**建议:**
1. 评估是否可替换为轻量方案（rich-text组件）
2. 或仅在需要富文本显示的页面分包异步加载

---

### 4. 数据项过多（低优先级）

**问题:** 复习首页 `data` 对象包含20+个字段

**代码位置:** `pages/review/index.js:16-39`
```javascript
data: {
  loading: true,
  error: false,
  todayDate: '',
  dashboard: null,
  currentCourse: null,
  heatmapData: [],
  resumeSession: null,
  recommendedCourses: [],
  courses: [],
  enrolledCourses: [],
  discoverCourses: [],
  filteredEnrolledCourses: [],
  filteredDiscoverCourses: [],
  showCoursePicker: false,
  courseSearch: '',
  selectedCourseKey: '',
  highlightStart: false,
  noDueTasks: false,
  primaryCtaText: '开始今日挑战',
  isDevtools: false,
  debugApiBaseUrl: '',
  isPageActive: false,
}
```

**影响:**
- `setData` 传输数据量大
- 建议拆分为多个子组件或使用computed

**建议:**
- 将课程选择器拆分为独立组件
- 使用computed减少冗余字段（如enrolledCourses/discoverCourses可由courses派生）

---

## 核心配置参数汇总

| 参数 | 当前值 | 位置 | 评价 |
|------|--------|------|------|
| 分包预加载 | `pages/review/index` → `review` | app.json:47-51 | ✅ 合理 |
| 缓存TTL | 600000ms (10分钟) | pages/review/index:99 | ✅ 合理 |
| 请求超时 | 8000ms | utils/request.js:88 | ✅ 合理 |
| 重试次数 | 3次 | utils/request.js:93 | ✅ 合理 |
| 重试延迟 | [100, 300, 900]ms | utils/request.js:92 | ✅ 合理 |
| 懒加载 | `requiredComponents` | app.json:4 | ✅ 已启用 |

---

## 优化建议汇总

### 高优先级

1. **清理主包冗余代码**
   - 移除7个未注册的交易相关页面
   - 预计减少主包体积30-40%

### 中优先级

2. **音效懒加载**
   - 将 `soundManager.preload()` 从 `onLoad` 移至首次交互
   - 预计减少首页首次渲染时间100-300ms

3. **mp-html优化**
   - 评估替换为rich-text组件
   - 或改为分包异步加载

### 低优先级

4. **数据拆分**
   - 将课程选择器拆分为独立组件
   - 优化setData数据量

---

## 结论

**总体评价:** 当前小程序架构设计合理，性能优化基础扎实。

**优势:**
- ✅ 分包策略正确，首页体验流畅
- ✅ SWR缓存实现规范，感知性能好
- ✅ 网络层健壮，重试机制完善
- ✅ 全链路追踪便于性能监控

**主要风险:**
- ⚠️ 主包包含大量遗留代码，体积膨胀
- ⚠️ 部分资源同步加载

**建议:**
1. 立即执行主包清理（高优先级）
2. 下次迭代时处理音效懒加载
3. 持续监控包体积变化

---

*报告生成时间: 2026-01-31*  
*调查工具: OpenCode + 代码分析*
