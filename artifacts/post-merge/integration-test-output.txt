
> bookworm-backend@1.0.0 test:integration
> dotenv -e .env.test -- vitest run --config vitest.integration.config.ts


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mC:/Users/wapadil/WeChatProjects/miniprogram-13/bookworm-backend[39m

[Worker 1] Starting a dedicated PostgreSQL container...
[Worker 1] Container started. Applying migrations...
[Worker 1] Migrations applied.
[90mstdout[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39m‚úÖ Test database URL set for worker 1: postgres://test:test@localhost...

Sourcemap for "C:/Users/wapadil/WeChatProjects/miniprogram-13/bookworm-backend/node_modules/node-cron/dist/esm/node-cron.js" points to missing source files
[90mstderr[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760784426111,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:6106","remoteAddress":"::ffff:127.0.0.1","remotePort":6107},"msg":"incoming request"}
{"level":30,"time":1760784426176,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":64.66909999959171,"msg":"request completed"}
{"level":30,"time":1760784426192,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:6109","remoteAddress":"::ffff:127.0.0.1","remotePort":6110},"msg":"incoming request"}
{"level":30,"time":1760784426196,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784426215,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":22.928700000047684,"msg":"request completed"}
{"level":30,"time":1760784426481,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:6112","remoteAddress":"::ffff:127.0.0.1","remotePort":6113},"msg":"incoming request"}
{"level":30,"time":1760784426523,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":41.90170000027865,"msg":"request completed"}
{"level":30,"time":1760784426533,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:6114","remoteAddress":"::ffff:127.0.0.1","remotePort":6115},"msg":"incoming request"}
{"level":30,"time":1760784426536,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784426557,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":200},"responseTime":23.964800000190735,"msg":"request completed"}
{"level":30,"time":1760784426824,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:6116","remoteAddress":"::ffff:127.0.0.1","remotePort":6117},"msg":"incoming request"}
{"level":30,"time":1760784426854,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":30.22459999937564,"msg":"request completed"}
{"level":30,"time":1760784426869,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:6118","remoteAddress":"::ffff:127.0.0.1","remotePort":6119},"msg":"incoming request"}
{"level":30,"time":1760784426875,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784426890,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":21.13329999987036,"msg":"request completed"}
{"level":30,"time":1760784427179,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:6120","remoteAddress":"::ffff:127.0.0.1","remotePort":6121},"msg":"incoming request"}
{"level":30,"time":1760784427209,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":29.851100000552833,"msg":"request completed"}
{"level":30,"time":1760784427217,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:6122","remoteAddress":"::ffff:127.0.0.1","remotePort":6123},"msg":"incoming request"}
{"level":30,"time":1760784427221,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760784427229,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé PENDING_PAYMENT Êõ¥Êñ∞‰∏∫ COMPLETED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé PENDING_PAYMENT Êõ¥Êñ∞‰∏∫ COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:6122","remoteAddress":"::ffff:127.0.0.1","remotePort":6123},"msg":"An error occurred during the request"}
{"level":30,"time":1760784427262,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":400},"responseTime":44.40919999964535,"msg":"request completed"}
{"level":30,"time":1760784427537,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:6124","remoteAddress":"::ffff:127.0.0.1","remotePort":6125},"msg":"incoming request"}
{"level":30,"time":1760784427557,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":201},"responseTime":19.828300000168383,"msg":"request completed"}
{"level":30,"time":1760784427570,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:6126","remoteAddress":"::ffff:127.0.0.1","remotePort":6127},"msg":"incoming request"}
{"level":30,"time":1760784427573,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760784427579,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé COMPLETED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé COMPLETED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:6126","remoteAddress":"::ffff:127.0.0.1","remotePort":6127},"msg":"An error occurred during the request"}
{"level":30,"time":1760784427580,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":400},"responseTime":9.96820000000298,"msg":"request completed"}
{"level":30,"time":1760784427837,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:6128","remoteAddress":"::ffff:127.0.0.1","remotePort":6129},"msg":"incoming request"}
{"level":30,"time":1760784427862,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":201},"responseTime":25.49629999976605,"msg":"request completed"}
{"level":30,"time":1760784427880,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:14628","remoteAddress":"::ffff:127.0.0.1","remotePort":14629},"msg":"incoming request"}
{"level":30,"time":1760784427882,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760784427888,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ COMPLETED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:14628","remoteAddress":"::ffff:127.0.0.1","remotePort":14629},"msg":"An error occurred during the request"}
{"level":30,"time":1760784427889,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":400},"responseTime":9.495099999941885,"msg":"request completed"}
{"level":30,"time":1760784428228,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:14630","remoteAddress":"::ffff:127.0.0.1","remotePort":14631},"msg":"incoming request"}
{"level":30,"time":1760784428258,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","res":{"statusCode":201},"responseTime":29.41249999962747,"msg":"request completed"}
{"level":30,"time":1760784428266,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:14632","remoteAddress":"::ffff:127.0.0.1","remotePort":14633},"msg":"incoming request"}
{"level":30,"time":1760784428271,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","res":{"statusCode":403},"responseTime":5.726400000043213,"msg":"request completed"}
{"level":30,"time":1760784428553,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:14636","remoteAddress":"::ffff:127.0.0.1","remotePort":14637},"msg":"incoming request"}
{"level":30,"time":1760784428584,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","res":{"statusCode":201},"responseTime":30.92740000039339,"msg":"request completed"}
{"level":30,"time":1760784428590,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:14638","remoteAddress":"::ffff:127.0.0.1","remotePort":14639},"msg":"incoming request"}
{"level":30,"time":1760784428591,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","res":{"statusCode":401},"responseTime":0.276999999769032,"msg":"request completed"}
{"level":30,"time":1760784428862,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:14640","remoteAddress":"::ffff:127.0.0.1","remotePort":14641},"msg":"incoming request"}
{"level":30,"time":1760784428882,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","res":{"statusCode":201},"responseTime":20.322200000286102,"msg":"request completed"}
{"level":30,"time":1760784428889,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:14642","remoteAddress":"::ffff:127.0.0.1","remotePort":14643},"msg":"incoming request"}
{"level":30,"time":1760784428891,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760784428897,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:14642","remoteAddress":"::ffff:127.0.0.1","remotePort":14643},"msg":"An error occurred during the request"}
{"level":30,"time":1760784428898,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","res":{"statusCode":404},"responseTime":8.596499999985099,"msg":"request completed"}
{"level":30,"time":1760784429225,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:14644","remoteAddress":"::ffff:127.0.0.1","remotePort":14645},"msg":"incoming request"}
{"level":30,"time":1760784429260,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","res":{"statusCode":201},"responseTime":33.88659999985248,"msg":"request completed"}
{"level":30,"time":1760784429268,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:14646","remoteAddress":"::ffff:127.0.0.1","remotePort":14647},"msg":"incoming request"}
{"level":50,"time":1760784429270,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","err":{"type":"Error","message":"params/id must be number","stack":"Error: params/id must be number\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:145:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/id","schemaPath":"#/properties/id/type","keyword":"type","params":{"type":"number"},"message":"must be number"}],"validationContext":"params"},"req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:14646","remoteAddress":"::ffff:127.0.0.1","remotePort":14647},"msg":"An error occurred during the request"}
{"level":30,"time":1760784429273,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","res":{"statusCode":400},"responseTime":5.343000000342727,"msg":"request completed"}
{"level":30,"time":1760784429552,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:14648","remoteAddress":"::ffff:127.0.0.1","remotePort":14649},"msg":"incoming request"}
{"level":30,"time":1760784429581,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","res":{"statusCode":201},"responseTime":28.826399999670684,"msg":"request completed"}
{"level":30,"time":1760784429586,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:14650","remoteAddress":"::ffff:127.0.0.1","remotePort":14651},"msg":"incoming request"}
{"level":50,"time":1760784429586,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","err":{"type":"Error","message":"body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf","stack":"Error: body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/0/const","keyword":"const","params":{"allowedValue":"COMPLETED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/1/const","keyword":"const","params":{"allowedValue":"CANCELLED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf","keyword":"anyOf","params":{},"message":"must match a schema in anyOf"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:14650","remoteAddress":"::ffff:127.0.0.1","remotePort":14651},"msg":"An error occurred during the request"}
{"level":30,"time":1760784429587,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","res":{"statusCode":400},"responseTime":0.5095000006258488,"msg":"request completed"}
{"level":30,"time":1760784429831,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:14652","remoteAddress":"::ffff:127.0.0.1","remotePort":14653},"msg":"incoming request"}
{"level":30,"time":1760784429857,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","res":{"statusCode":201},"responseTime":25.83669999986887,"msg":"request completed"}
{"level":30,"time":1760784429872,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:14654","remoteAddress":"::ffff:127.0.0.1","remotePort":14655},"msg":"incoming request"}
{"level":50,"time":1760784429873,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:14654","remoteAddress":"::ffff:127.0.0.1","remotePort":14655},"msg":"An error occurred during the request"}
{"level":30,"time":1760784429873,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","res":{"statusCode":400},"responseTime":1.219899999909103,"msg":"request completed"}
{"level":30,"time":1760784430215,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:5907","remoteAddress":"::ffff:127.0.0.1","remotePort":5908},"msg":"incoming request"}
{"level":30,"time":1760784430255,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","res":{"statusCode":201},"responseTime":39.20280000008643,"msg":"request completed"}
{"level":30,"time":1760784430265,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5909","remoteAddress":"::ffff:127.0.0.1","remotePort":5910},"msg":"incoming request"}
{"level":30,"time":1760784430272,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430287,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","res":{"statusCode":200},"responseTime":21.846699999645352,"msg":"request completed"}
{"level":30,"time":1760784430590,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:5911","remoteAddress":"::ffff:127.0.0.1","remotePort":5912},"msg":"incoming request"}
{"level":30,"time":1760784430613,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","res":{"statusCode":201},"responseTime":22.97580000013113,"msg":"request completed"}
{"level":30,"time":1760784430629,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5918},"msg":"incoming request"}
{"level":30,"time":1760784430630,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5923},"msg":"incoming request"}
{"level":30,"time":1760784430632,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5914},"msg":"incoming request"}
{"level":30,"time":1760784430633,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5915},"msg":"incoming request"}
{"level":30,"time":1760784430633,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5916},"msg":"incoming request"}
{"level":30,"time":1760784430634,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5917},"msg":"incoming request"}
{"level":30,"time":1760784430635,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5919},"msg":"incoming request"}
{"level":30,"time":1760784430636,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5920},"msg":"incoming request"}
{"level":30,"time":1760784430636,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5921},"msg":"incoming request"}
{"level":30,"time":1760784430637,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-11","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5922},"msg":"incoming request"}
{"level":30,"time":1760784430638,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430638,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430638,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430638,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430639,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430647,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430649,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430649,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430654,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430656,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784430661,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-11","res":{"statusCode":200},"responseTime":23.893699999898672,"msg":"request completed"}
{"level":50,"time":1760784430670,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5917},"msg":"An error occurred during the request"}
{"level":30,"time":1760784430670,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","res":{"statusCode":400},"responseTime":36.21679999958724,"msg":"request completed"}
{"level":50,"time":1760784430671,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5918},"msg":"An error occurred during the request"}
{"level":30,"time":1760784430672,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","res":{"statusCode":400},"responseTime":42.844800000078976,"msg":"request completed"}
{"level":50,"time":1760784430672,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5920},"msg":"An error occurred during the request"}
{"level":30,"time":1760784430673,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","res":{"statusCode":400},"responseTime":36.931499999947846,"msg":"request completed"}
{"level":50,"time":1760784430673,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5919},"msg":"An error occurred during the request"}
{"level":30,"time":1760784430673,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","res":{"statusCode":400},"responseTime":38.111800000071526,"msg":"request completed"}
{"level":50,"time":1760784430674,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:5913","remoteAddress":"::ffff:127.0.0.1","remotePort":5921},"msg":"An error occurred during the request"}
{"level":30,"time":1760784430674,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","res":{"statusCode":400},"responseTime":37.4277999997139,"msg":"request completed"}
{"level":30,"time":1760784430683,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","res":{"statusCode":200},"responseTime":52.235999999567866,"msg":"request completed"}
{"level":30,"time":1760784430697,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","res":{"statusCode":200},"responseTime":63.55750000011176,"msg":"request completed"}
{"level":30,"time":1760784430717,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","res":{"statusCode":200},"responseTime":85.1366000007838,"msg":"request completed"}
{"level":30,"time":1760784430729,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","res":{"statusCode":200},"responseTime":95.89109999965876,"msg":"request completed"}
 [32m‚úì[39m src/tests/order-status-management.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 6874[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould allow STAFF to complete a PENDING_PICKUP order [33m 435[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould allow STAFF to cancel a PENDING_PICKUP order [33m 341[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould allow STAFF to cancel a PENDING_PAYMENT order [33m 347[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould reject invalid status transitions [33m 372[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould reject attempts to change status of already COMPLETED orders [33m 303[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould reject attempts to change status of already CANCELLED orders [33m 316[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mAccess Control[2m > [22mshould reject regular USER attempts to update order status [33m 396[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mAccess Control[2m > [22mshould handle non-existent order IDs [33m 337[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mAccess Control[2m > [22mshould handle invalid order IDs [33m 356[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mRequest Validation[2m > [22mshould reject missing status field [33m 335[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mRequest Validation[2m > [22mshould reject requests with extra fields [33m 387[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mRate Limiting[2m > [22mshould handle rapid requests gracefully when rate limiting is disabled [33m 436[2mms[22m[39m
[90mstdout[2m | src/tests/concurrent-order-control.integration.test.ts[2m > [22m[2mConcurrent Order Control Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m‚úì[39m src/tests/concurrent-order-control.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 5595[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÔºöÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïËßÑÂàô[2m > [22mÂ∫îËØ•Èò≤Ê≠¢Âêå‰∏ÄÁî®Êà∑ÂàõÂª∫Â§ö‰∏™PENDING_PAYMENTËÆ¢Âçï [33m 407[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÔºöÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïËßÑÂàô[2m > [22mÂ∫îËØ•ÂÖÅËÆ∏‰∏çÂêåÁî®Êà∑ÂêåÊó∂ÂàõÂª∫PENDING_PAYMENTËÆ¢Âçï [33m 384[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÔºöÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïËßÑÂàô[2m > [22mÂπ∂ÂèëÁ´û‰∫âÂêå‰∏ÄÂ∫ìÂ≠òÊó∂Â∫î‰ªÖ‰∏ÄÁ¨îÊàêÂäü [33m 394[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÔºöÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïËßÑÂàô[2m > [22mÁî®Êà∑ËÆ¢ÂçïÁä∂ÊÄÅÂèòÂåñÂêéÂ∫îËØ•ËÉΩÂàõÂª∫Êñ∞ËÆ¢Âçï [33m 406[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•Èò≤Ê≠¢Áî®Êà∑È¢ÑÁïôË∂ÖËøá‰∏äÈôêÁöÑÂïÜÂìÅÊÄªÊï∞ [33m 337[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•ÈÄöËøáÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïÈò≤Ê≠¢Áî®Êà∑ÂàõÂª∫Â§ö‰∏™pendingËÆ¢Âçï [33m 380[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•ÈÄöËøáÊ®°ÊãüÊï∞ÊçÆÊµãËØïMAX_RESERVED_ITEMS_PER_USERÈÄªËæë [33m 417[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•ÂÖÅËÆ∏Âú®ÂçïÁ¨îËÆ¢Âçï‰∏äÈôêÂÜÖÂàõÂª∫ËÆ¢Âçï [33m 390[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•ÂÖÅËÆ∏Âú®ÊÄªÈ¢ÑÁïô‰∏äÈôêÂÜÖÂàõÂª∫Â§ö‰∏™ËÆ¢Âçï [33m 466[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂèåÈáç‰øùÊä§Êú∫Âà∂ÂçèÂêåÂ∑•‰Ωú[2m > [22m‰∏§‰∏™ËßÑÂàôÂ∫îËØ•Áã¨Á´ãÂ∑•‰ΩúÔºå‰∏ç‰∫íÁõ∏Âπ≤Êâ∞ [33m 548[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÈò≤Á∫ø[2m > [22mË∂ÖÂá∫Êï∞ÊçÆÂ∫ìÈ¢ÑÁïô‰∏äÈôêÊó∂Â∫îÁõ¥Êé•ÊãíÁªù [33m 594[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mËæπÁïåÊÉÖÂÜµÊµãËØï[2m > [22mÂ∫îËØ•Ê≠£Á°ÆÂ§ÑÁêÜÈÉ®ÂàÜÊó†ÊïàÁöÑÂïÜÂìÅID [33m 362[2mms[22m[39m
[90mstdout[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39m‚úÖ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstderr[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760784436900,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:12934","remoteAddress":"::ffff:127.0.0.1","remotePort":12935},"msg":"incoming request"}
{"level":30,"time":1760784436901,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":401},"responseTime":0.5177999995648861,"msg":"request completed"}
{"level":30,"time":1760784437145,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:10963","remoteAddress":"::ffff:127.0.0.1","remotePort":10964},"msg":"incoming request"}
{"level":40,"time":1760784437145,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","err":{"type":"TokenError","message":"The token is malformed.","stack":"Error: The token is malformed.\n    at decode (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fast-jwt\\src\\decoder.js:18:11)\n    at verify (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fast-jwt\\src\\verifier.js:285:15)\n    at Object.authenticate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\plugins\\auth.ts:17:29)\n    at hookIterator (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:405:10)\n    at next (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:239:18)\n    at hookRunner (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:261:5)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:116:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at handleRequest (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:24:5)","code":"FAST_JWT_MALFORMED"},"msg":"Authentication failed"}
{"level":30,"time":1760784437149,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":401},"responseTime":4.100999999791384,"msg":"request completed"}
{"level":30,"time":1760784437412,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"GET","url":"/api/orders/pending-pickup","hostname":"127.0.0.1:10965","remoteAddress":"::ffff:127.0.0.1","remotePort":10966},"msg":"incoming request"}
{"level":30,"time":1760784437416,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":403},"responseTime":3.7346000000834465,"msg":"request completed"}
{"level":30,"time":1760784437658,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10967","remoteAddress":"::ffff:127.0.0.1","remotePort":10968},"msg":"incoming request"}
{"level":50,"time":1760784437659,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"Error","message":"body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf","stack":"Error: body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/0/const","keyword":"const","params":{"allowedValue":"COMPLETED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/1/const","keyword":"const","params":{"allowedValue":"CANCELLED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf","keyword":"anyOf","params":{},"message":"must match a schema in anyOf"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10967","remoteAddress":"::ffff:127.0.0.1","remotePort":10968},"msg":"An error occurred during the request"}
{"level":30,"time":1760784437660,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":400},"responseTime":1.002899999730289,"msg":"request completed"}
{"level":30,"time":1760784437932,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10969","remoteAddress":"::ffff:127.0.0.1","remotePort":10970},"msg":"incoming request"}
{"level":50,"time":1760784437932,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10969","remoteAddress":"::ffff:127.0.0.1","remotePort":10970},"msg":"An error occurred during the request"}
{"level":30,"time":1760784437933,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":400},"responseTime":0.9289000006392598,"msg":"request completed"}
{"level":30,"time":1760784438196,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10972","remoteAddress":"::ffff:127.0.0.1","remotePort":10973},"msg":"incoming request"}
{"level":50,"time":1760784438197,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","err":{"type":"SyntaxError","message":"Unexpected token 'i', \"invalid-json{\" is not valid JSON","stack":"SyntaxError: Unexpected token 'i', \"invalid-json{\" is not valid JSON","statusCode":400},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10972","remoteAddress":"::ffff:127.0.0.1","remotePort":10973},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438197,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":400},"responseTime":0.9709999999031425,"msg":"request completed"}
{"level":30,"time":1760784438483,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"GET","url":"/api/inventory/available?search=a","hostname":"127.0.0.1:10974","remoteAddress":"::ffff:127.0.0.1","remotePort":10975},"msg":"incoming request"}
{"level":30,"time":1760784438492,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":8.822699999436736,"msg":"request completed"}
{"level":30,"time":1760784438757,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10982},"msg":"incoming request"}
{"level":30,"time":1760784438760,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10985},"msg":"incoming request"}
{"level":30,"time":1760784438761,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10990},"msg":"incoming request"}
{"level":30,"time":1760784438762,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10992},"msg":"incoming request"}
{"level":30,"time":1760784438763,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10978},"msg":"incoming request"}
{"level":30,"time":1760784438764,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10979},"msg":"incoming request"}
{"level":30,"time":1760784438767,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10980},"msg":"incoming request"}
{"level":30,"time":1760784438768,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10981},"msg":"incoming request"}
{"level":30,"time":1760784438769,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10983},"msg":"incoming request"}
{"level":30,"time":1760784438770,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10984},"msg":"incoming request"}
{"level":30,"time":1760784438771,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10986},"msg":"incoming request"}
{"level":30,"time":1760784438771,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10987},"msg":"incoming request"}
{"level":30,"time":1760784438772,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10988},"msg":"incoming request"}
{"level":30,"time":1760784438772,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10989},"msg":"incoming request"}
{"level":30,"time":1760784438773,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10991},"msg":"incoming request"}
{"level":30,"time":1760784438774,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438775,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438775,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438775,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438775,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438775,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438775,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438775,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438776,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438776,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438776,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438776,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438776,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438776,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784438776,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760784438783,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10978},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438784,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":404},"responseTime":21.240900000557303,"msg":"request completed"}
{"level":50,"time":1760784438785,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10985},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438786,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":404},"responseTime":25.464500000700355,"msg":"request completed"}
{"level":50,"time":1760784438786,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10990},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438786,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":404},"responseTime":24.91399999987334,"msg":"request completed"}
{"level":50,"time":1760784438787,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10982},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438787,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":404},"responseTime":29.65070000011474,"msg":"request completed"}
{"level":50,"time":1760784438788,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10992},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438789,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":404},"responseTime":26.105000000447035,"msg":"request completed"}
{"level":50,"time":1760784438789,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10979},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438789,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","res":{"statusCode":404},"responseTime":25.43129999935627,"msg":"request completed"}
{"level":50,"time":1760784438798,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10981},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438799,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","res":{"statusCode":404},"responseTime":30.682299999520183,"msg":"request completed"}
{"level":50,"time":1760784438799,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10983},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438800,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","res":{"statusCode":404},"responseTime":30.621599999256432,"msg":"request completed"}
{"level":50,"time":1760784438800,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10984},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438800,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","res":{"statusCode":404},"responseTime":30.052500000223517,"msg":"request completed"}
{"level":50,"time":1760784438800,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10980},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438800,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","res":{"statusCode":404},"responseTime":33.739000000059605,"msg":"request completed"}
{"level":50,"time":1760784438812,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10988},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438813,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","res":{"statusCode":404},"responseTime":40.66310000047088,"msg":"request completed"}
{"level":50,"time":1760784438813,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10987},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438813,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","res":{"statusCode":404},"responseTime":41.91110000014305,"msg":"request completed"}
{"level":50,"time":1760784438814,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10986},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438814,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","res":{"statusCode":404},"responseTime":43.15959999989718,"msg":"request completed"}
{"level":50,"time":1760784438814,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10991},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438814,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","res":{"statusCode":404},"responseTime":40.98950000014156,"msg":"request completed"}
{"level":50,"time":1760784438814,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:10977","remoteAddress":"::ffff:127.0.0.1","remotePort":10989},"msg":"An error occurred during the request"}
{"level":30,"time":1760784438815,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","res":{"statusCode":404},"responseTime":42.14950000029057,"msg":"request completed"}
{"level":30,"time":1760784439132,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:13656","remoteAddress":"::ffff:127.0.0.1","remotePort":13657},"msg":"incoming request"}
{"level":30,"time":1760784439138,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760784439143,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:13656","remoteAddress":"::ffff:127.0.0.1","remotePort":13657},"msg":"An error occurred during the request"}
{"level":30,"time":1760784439144,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","res":{"statusCode":404},"responseTime":11.765700000338256,"msg":"request completed"}
{"level":30,"time":1760784439408,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:13658","remoteAddress":"::ffff:127.0.0.1","remotePort":13659},"msg":"incoming request"}
{"level":50,"time":1760784439409,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","err":{"type":"Error","message":"params/id must be number","stack":"Error: params/id must be number\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:145:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/id","schemaPath":"#/properties/id/type","keyword":"type","params":{"type":"number"},"message":"must be number"}],"validationContext":"params"},"req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:13658","remoteAddress":"::ffff:127.0.0.1","remotePort":13659},"msg":"An error occurred during the request"}
{"level":30,"time":1760784439409,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","res":{"statusCode":400},"responseTime":0.9012000001966953,"msg":"request completed"}
{"level":30,"time":1760784439710,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13660","remoteAddress":"::ffff:127.0.0.1","remotePort":13661},"msg":"incoming request"}
{"level":30,"time":1760784439757,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","res":{"statusCode":201},"responseTime":46.03260000050068,"msg":"request completed"}
{"level":30,"time":1760784439760,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:13662","remoteAddress":"::ffff:127.0.0.1","remotePort":13663},"msg":"incoming request"}
{"level":30,"time":1760784439765,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760784439778,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé PENDING_PAYMENT Êõ¥Êñ∞‰∏∫ COMPLETED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé PENDING_PAYMENT Êõ¥Êñ∞‰∏∫ COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:80:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:13662","remoteAddress":"::ffff:127.0.0.1","remotePort":13663},"msg":"An error occurred during the request"}
{"level":30,"time":1760784439779,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","res":{"statusCode":400},"responseTime":18.91969999950379,"msg":"request completed"}
{"level":30,"time":1760784440147,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","req":{"method":"GET","url":"/api/inventory/item/99999","hostname":"127.0.0.1:13664","remoteAddress":"::ffff:127.0.0.1","remotePort":13665},"msg":"incoming request"}
{"level":50,"time":1760784440153,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","err":{"type":"ApiError","message":"Book not found.","stack":"ApiError: Book not found.\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\inventory.ts:66:15)","name":"ApiError","statusCode":404,"code":"BOOK_NOT_FOUND"},"req":{"method":"GET","url":"/api/inventory/item/99999","hostname":"127.0.0.1:13664","remoteAddress":"::ffff:127.0.0.1","remotePort":13665},"msg":"An error occurred during the request"}
{"level":30,"time":1760784440155,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","res":{"statusCode":404},"responseTime":8.185300000011921,"msg":"request completed"}
{"level":30,"time":1760784440406,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:13666","remoteAddress":"::ffff:127.0.0.1","remotePort":13667},"msg":"incoming request"}
{"level":30,"time":1760784440406,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","res":{"statusCode":401},"responseTime":0.22699999995529652,"msg":"request completed"}
{"level":30,"time":1760784440409,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","req":{"method":"GET","url":"/api/orders/pending-pickup","hostname":"127.0.0.1:13668","remoteAddress":"::ffff:127.0.0.1","remotePort":13669},"msg":"incoming request"}
{"level":30,"time":1760784440412,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","res":{"statusCode":403},"responseTime":2.2945999996736646,"msg":"request completed"}
{"level":30,"time":1760784440414,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:13670","remoteAddress":"::ffff:127.0.0.1","remotePort":13671},"msg":"incoming request"}
{"level":50,"time":1760784440415,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:13670","remoteAddress":"::ffff:127.0.0.1","remotePort":13671},"msg":"An error occurred during the request"}
{"level":30,"time":1760784440415,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","res":{"statusCode":400},"responseTime":0.5578000005334616,"msg":"request completed"}
{"level":30,"time":1760784440418,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:13672","remoteAddress":"::ffff:127.0.0.1","remotePort":13673},"msg":"incoming request"}
{"level":30,"time":1760784440419,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760784440426,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:67:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:13672","remoteAddress":"::ffff:127.0.0.1","remotePort":13673},"msg":"An error occurred during the request"}
{"level":30,"time":1760784440427,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","res":{"statusCode":404},"responseTime":9.319200000725687,"msg":"request completed"}
{"level":30,"time":1760784440711,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","req":{"method":"GET","url":"/api/health","hostname":"127.0.0.1:13674","remoteAddress":"::ffff:127.0.0.1","remotePort":13675},"msg":"incoming request"}
{"level":30,"time":1760784440715,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","res":{"statusCode":200},"responseTime":3.4354999996721745,"msg":"request completed"}
 [32m‚úì[39m src/tests/error-handling.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 4268[2mms[22m[39m
   [33m[2m‚úì[22m[39m Error Handling Integration Tests[2m > [22mLayer 3: Rate Limiting Errors (429)[2m > [22mshould return 429 with correct format when rate limit exceeded [33m 342[2mms[22m[39m
   [33m[2m‚úì[22m[39m Error Handling Integration Tests[2m > [22mLayer 4: Business Logic Errors (ApiError)[2m > [22mshould return correct format for invalid status transition [33m 449[2mms[22m[39m
[90mstdout[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests
[22m[39m‚úÖ Test database URL set for worker 1: postgres://test:test@localhost...

{"level":30,"time":1760784441064,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","msg":"WeChat Pay SDK initialized successfully"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760784441293,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11098","remoteAddress":"::ffff:127.0.0.1","remotePort":11099},"msg":"incoming request"}
{"level":40,"time":1760784441308,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\payment.ts:108:33)\n    at preHandlerCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:139:37)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:123:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)"},"resource":{"ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely a malformed/malicious request."}
{"level":30,"time":1760784441310,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":200},"responseTime":16.98920000065118,"msg":"request completed"}
{"level":30,"time":1760784441572,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11100","remoteAddress":"::ffff:127.0.0.1","remotePort":11101},"msg":"incoming request"}
{"level":40,"time":1760784441572,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\payment.ts:108:33)\n    at preHandlerCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:139:37)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:123:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)"},"resource":{"ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely a malformed/malicious request."}
{"level":30,"time":1760784441573,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":0.9405000004917383,"msg":"request completed"}
{"level":30,"time":1760784441874,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11102","remoteAddress":"::ffff:127.0.0.1","remotePort":11103},"msg":"incoming request"}
{"level":40,"time":1760784441874,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\payment.ts:108:33)\n    at preHandlerCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:139:37)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:123:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)"},"resource":{"ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely a malformed/malicious request."}
{"level":30,"time":1760784441875,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":200},"responseTime":0.6343999998643994,"msg":"request completed"}
{"level":30,"time":1760784442153,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11104","remoteAddress":"::ffff:127.0.0.1","remotePort":11105},"msg":"incoming request"}
{"level":50,"time":1760784442155,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"FastifyError","message":"Body cannot be empty when content-type is set to 'application/json'","stack":"FastifyError: Body cannot be empty when content-type is set to 'application/json'\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:295:19)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)\n    at IncomingMessage.emit (node:events:530:35)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)","code":"FST_ERR_CTP_EMPTY_JSON_BODY","name":"FastifyError","statusCode":400},"req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11104","remoteAddress":"::ffff:127.0.0.1","remotePort":11105},"msg":"An error occurred during the request"}
{"level":30,"time":1760784442156,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":400},"responseTime":2.6877999994903803,"msg":"request completed"}
{"level":30,"time":1760784442426,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11106","remoteAddress":"::ffff:127.0.0.1","remotePort":11107},"msg":"incoming request"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mPayment Callback Security Fortress - HTTP Layer[2m > [22m[2mshould accept valid requests with proper timestamp and signature
[22m[39mPayment notification for unknown out_trade_no UNKNOWN_PAYMENT received. Ignoring.

{"level":30,"time":1760784442434,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":200},"responseTime":7.082100000232458,"msg":"request completed"}
{"level":30,"time":1760784442685,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11108","remoteAddress":"::ffff:127.0.0.1","remotePort":11109},"msg":"incoming request"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22m[2mshould handle successful payment notification
[22m[39mPayment notification for unknown out_trade_no TEST_ORDER_12345 received. Ignoring.

{"level":30,"time":1760784442690,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":5.263899999670684,"msg":"request completed"}
{"level":30,"time":1760784442949,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11110","remoteAddress":"::ffff:127.0.0.1","remotePort":11111},"msg":"incoming request"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22m[2mshould handle failed payment notification
[22m[39mPayment notification for unknown out_trade_no TEST_ORDER_12345 received. Ignoring.

{"level":30,"time":1760784442953,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":3.759100000374019,"msg":"request completed"}
{"level":30,"time":1760784443257,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11112","remoteAddress":"::ffff:127.0.0.1","remotePort":11113},"msg":"incoming request"}
[90mstdout[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22m[2mshould persist payment success and transition order status
[22m[39mOrder 1 successfully updated to PENDING_PICKUP.

{"level":30,"time":1760784443281,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":24.025600000284612,"msg":"request completed"}
{"level":30,"time":1760784443616,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11120","remoteAddress":"::ffff:127.0.0.1","remotePort":11121},"msg":"incoming request"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22m[2mshould mark payment record as FAILED when gateway reports final failure
[22m[39mPayment for TEST_FAIL_1760784443594 is in a final failure state (CLOSED). Marked as FAILED.

{"level":30,"time":1760784443626,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":200},"responseTime":10.110999999567866,"msg":"request completed"}
{"level":30,"time":1760784443932,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:11123","remoteAddress":"::ffff:127.0.0.1","remotePort":11124},"msg":"incoming request"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22m[2mshould mark payment record as FAILED when gateway returns PAYERROR
[22m[39mPayment for TEST_PAYERROR_1760784443912 is in a final failure state (PAYERROR). Marked as FAILED.

{"level":30,"time":1760784443943,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":200},"responseTime":11.058100000023842,"msg":"request completed"}
{"level":30,"time":1760784444243,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:5505","remoteAddress":"::ffff:127.0.0.1","remotePort":5506},"msg":"incoming request"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22m[2mshould handle unknown order notification
[22m[39mPayment notification for unknown out_trade_no NONEXISTENT_ORDER_99999 received. Ignoring.

{"level":30,"time":1760784444247,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":200},"responseTime":4.089799999259412,"msg":"request completed"}
{"level":30,"time":1760784444546,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:5508","remoteAddress":"::ffff:127.0.0.1","remotePort":5509},"msg":"incoming request"}
{"level":40,"time":1760784444546,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"SyntaxError","message":"Unexpected token 'i', \"invalid-json{\" is not valid JSON","stack":"SyntaxError: Unexpected token 'i', \"invalid-json{\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\payment.ts:108:33)\n    at preHandlerCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:139:37)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:123:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)"},"resource":{"ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely a malformed/malicious request."}
{"level":30,"time":1760784444546,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":200},"responseTime":0.7130000004544854,"msg":"request completed"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mAmount Mismatch Alert Mechanism[2m > [22m[2mshould trigger an amount mismatch alert if order total is inconsistent
[22m[39m{ orderId: [33m1[39m, storedAmount: [33m99999[39m, calculatedAmount: [33m5000[39m, userId: [33m1[39m } CRITICAL: Amount mismatch detected for order 1. This indicates data corruption!

 [32m‚úì[39m src/tests/paymentSecurity.integration.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 4084[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mPayment Callback Security Fortress - HTTP Layer[2m > [22mshould reject requests with expired timestamps (Èò≤ÈáçÊîæÊîªÔøΩ? [33m 318[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22mshould persist payment success and transition order status [33m 355[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22mshould mark payment record as FAILED when gateway reports final failure [33m 344[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22mshould mark payment record as FAILED when gateway returns PAYERROR [33m 330[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22mshould handle unknown order notification [33m 305[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mAmount Mismatch Alert Mechanism[2m > [22mshould trigger an amount mismatch alert if order total is inconsistent [33m 394[2mms[22m[39m
[90mstdout[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39m‚úÖ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstderr[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760784445650,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784445657,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784445692,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":41.6761999996379,"msg":"request completed"}
{"level":30,"time":1760784446081,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784446084,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784446110,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":201},"responseTime":29.100099999457598,"msg":"request completed"}
{"level":30,"time":1760784446111,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784446120,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784446150,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":38.816999999806285,"msg":"request completed"}
{"level":30,"time":1760784446482,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784446486,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784446497,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":201},"responseTime":14.777999999932945,"msg":"request completed"}
{"level":30,"time":1760784446773,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784446776,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":403},"responseTime":2.7974000005051494,"msg":"request completed"}
{"level":30,"time":1760784447081,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784447105,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":23.450000000186265,"msg":"request completed"}
{"level":30,"time":1760784447441,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784447455,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":13.54879999998957,"msg":"request completed"}
{"level":30,"time":1760784447719,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784447723,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":3.5191000001505017,"msg":"request completed"}
{"level":30,"time":1760784448000,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784448010,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":200},"responseTime":10.331100000068545,"msg":"request completed"}
{"level":30,"time":1760784448298,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784448298,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":401},"responseTime":0.4664000002667308,"msg":"request completed"}
 [32m‚úì[39m src/tests/profile-and-recommendations.integration.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 3346[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Profile & Recommendations Integration Tests[2m > [22mPOST /api/acquisitions - Customer Profile Collection[2m > [22mÂ∫îËØ•Âú®Êî∂Ë¥≠Êó∂ÂàõÂª∫Áî®Êà∑ÁîªÂÉè [33m 466[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Profile & Recommendations Integration Tests[2m > [22mPOST /api/acquisitions - Customer Profile Collection[2m > [22mÂ∫îËØ•Âú®Á¨¨‰∫åÊ¨°Êî∂Ë¥≠Êó∂Êõ¥Êñ∞Áî®Êà∑ÁîªÂÉè [33m 452[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Profile & Recommendations Integration Tests[2m > [22mGET /api/books/recommendations - Personalized Recommendations[2m > [22mÂ∫îËØ•‰∏∫ÊúâÁîªÂÉèÁöÑÁî®Êà∑ËøîÂõûÊé®Ëçê‰π¶Á±ç [33m 337[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Profile & Recommendations Integration Tests[2m > [22mGET /api/books/recommendations - Personalized Recommendations[2m > [22mÂ∫îËØ•Âè™ËøîÂõûÊúâÂ∫ìÂ≠òÁöÑÊé®Ëçê‰π¶Á±ç [33m 349[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Profile & Recommendations Integration Tests[2m > [22mGET /api/books/recommendations - Personalized Recommendations[2m > [22mÂ∫îËØ•ÊãíÁªùÊú™ËÆ§ËØÅÁî®Êà∑ËÆøÈóÆÊé®Ëçê [33m 306[2mms[22m[39m
[90mstdout[2m | src/tests/databaseRules.integration.test.ts[2m > [22m[2mDatabase-level Business Rules
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m‚úì[39m src/tests/databaseRules.integration.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3543[2mms[22m[39m
   [33m[2m‚úì[22m[39m Database-level Business Rules[2m > [22mwithTxRetry[2m > [22mretries deterministically on serialization conflicts [33m 429[2mms[22m[39m
   [33m[2m‚úì[22m[39m Database-level Business Rules[2m > [22mwithTxRetry[2m > [22mdoes not retry for non-retryable errors [33m 321[2mms[22m[39m
   [33m[2m‚úì[22m[39m Database-level Business Rules[2m > [22mshould enforce MAX_RESERVED_ITEMS_PER_USER via trigger using custom setting [33m 357[2mms[22m[39m
   [33m[2m‚úì[22m[39m Database-level Business Rules[2m > [22mOrder type consistency check[2m > [22mshould reject a SELL order missing unitPrice [33m 352[2mms[22m[39m
   [33m[2m‚úì[22m[39m Database-level Business Rules[2m > [22mOrder type consistency check[2m > [22mshould reject a VOUCHER sell order without voucherFaceValue [33m 385[2mms[22m[39m
   [33m[2m‚úì[22m[39m Database-level Business Rules[2m > [22mOrder type consistency check[2m > [22mshould accept a valid SELL order for CASH settlement [33m 393[2mms[22m[39m
   [33m[2m‚úì[22m[39m Database-level Business Rules[2m > [22mSource order type trigger[2m > [22mshould reject an inventory item referencing a PURCHASE order [33m 368[2mms[22m[39m
   [33m[2m‚úì[22m[39m Database-level Business Rules[2m > [22mSource order type trigger[2m > [22mshould allow an inventory item referencing a SELL order [33m 362[2mms[22m[39m
[90mstdout[2m | src/tests/inventoryService.integration.test.ts[2m > [22m[2mInventory Service Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m‚úì[39m src/tests/inventoryService.integration.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3213[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22maddBookToInventory[2m > [22mshould create a new bookMaster, sku, and inventory item for a new ISBN [33m 344[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22maddBookToInventory[2m > [22mshould create only a new inventory item for an existing book SKU [33m 319[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22mfulfillOrder[2m > [22mshould complete the order and mark inventory as sold with a valid pickup code [33m 563[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22mfulfillOrder[2m > [22mshould throw an error for an invalid pickup code [33m 374[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould find a book with a literal "%" in the title [33m 457[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould find a book with literal "__" in the title and not treat it as a wildcard [33m 425[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould find a book with "C++" without treating "+" as a special character [33m 341[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould handle search terms with multiple special characters [33m 383[2mms[22m[39m
[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge[2m > [22m[2mshould merge PRE_REGISTERED user with WeChat account when phone numbers match
[22m[39m[MERGE] PRE_REGISTERED user 1 upgraded to REGISTERED with openid wx_rea***

[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge[2m > [22m[2mshould preserve unionid during merge
[22m[39m[MERGE] PRE_REGISTERED user 1 upgraded to REGISTERED with openid wx_ope***

[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge[2m > [22m[2mshould handle CONFLICT: openid already used by REGISTERED user
[22m[39m[MERGE CONFLICT] PRE_REGISTERED user 2 (phone=135****5555) conflicts with existing REGISTERED user 1 (openid=wx_con***). Merging into REGISTERED user.

[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge[2m > [22m[2mshould handle CONFLICT: openid already used by REGISTERED user
[22m[39m[MERGE COMPLETE] Transferred data from PRE_REGISTERED user 2 to REGISTERED user 1 and deleted placeholder.

[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge[2m > [22m[2mshould transfer ALL associated records during CONFLICT merge
[22m[39m[MERGE CONFLICT] PRE_REGISTERED user 2 (phone=133****3333) conflicts with existing REGISTERED user 1 (openid=wx_ful***). Merging into REGISTERED user.

[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge[2m > [22m[2mshould transfer ALL associated records during CONFLICT merge
[22m[39m[MERGE COMPLETE] Transferred data from PRE_REGISTERED user 2 to REGISTERED user 1 and deleted placeholder.

[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge[2m > [22m[2mshould handle CONFLICT: both phone and openid already used by REGISTERED user
[22m[39m[MERGE CONFLICT] PRE_REGISTERED user 2 (phone=134****4444) conflicts with existing REGISTERED user 1 (openid=wx_dou***). Merging into REGISTERED user.

[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge[2m > [22m[2mshould handle CONFLICT: both phone and openid already used by REGISTERED user
[22m[39m[MERGE COMPLETE] Transferred data from PRE_REGISTERED user 2 to REGISTERED user 1 and deleted placeholder.

 [32m‚úì[39m src/tests/user-merge.integration.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2431[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Account Merge[2m > [22mshould merge PRE_REGISTERED user with WeChat account when phone numbers match [33m 363[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Account Merge[2m > [22mshould create new user when phone number doesn't match any PRE_REGISTERED account [33m 321[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Account Merge[2m > [22mshould handle CONFLICT: openid already used by REGISTERED user [33m 320[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Account Merge[2m > [22mshould transfer ALL associated records during CONFLICT merge [33m 313[2mms[22m[39m
[90mstdout[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39m‚úÖ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstderr[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760784458343,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784458366,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":22.923700000159442,"msg":"request completed"}
{"level":30,"time":1760784458661,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":50,"time":1760784458677,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","err":{"type":"ApiError","message":"ÈÉ®ÂàÜ‰π¶Á±çÂ∑≤‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞ÂêéÈáçËØï","stack":"ApiError: ÈÉ®ÂàÜ‰π¶Á±çÂ∑≤‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞ÂêéÈáçËØï\n    at validateInventoryAndReservations (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\create.ts:128:11)\n    at createOrderImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\create.ts:271:5)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at withTxRetry (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\db\\transaction.ts:78:14)\n    at createOrder (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\create.ts:313:14)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:63:21)","name":"ApiError","statusCode":409,"code":"INSUFFICIENT_INVENTORY_PRECHECK"},"req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"An error occurred during the request"}
{"level":30,"time":1760784458677,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":409},"responseTime":15.966599999926984,"msg":"request completed"}
{"level":30,"time":1760784458980,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784459032,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":51.77339999936521,"msg":"request completed"}
{"level":30,"time":1760784459033,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"GET","url":"/api/orders/1","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":50,"time":1760784459046,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"ApiError","message":"Order not found","stack":"ApiError: Order not found\n    at getOrderById (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\queries.ts:142:11)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:82:21)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"GET","url":"/api/orders/1","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"An error occurred during the request"}
{"level":30,"time":1760784459047,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":404},"responseTime":13.66440000012517,"msg":"request completed"}
{"level":30,"time":1760784459329,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784459362,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":33.28550000023097,"msg":"request completed"}
{"level":30,"time":1760784459364,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"GET","url":"/api/orders/1","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784459381,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":16.71250000037253,"msg":"request completed"}
{"level":30,"time":1760784459638,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784459663,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":25.196599999442697,"msg":"request completed"}
{"level":30,"time":1760784459664,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"GET","url":"/api/orders/my","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784459672,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":8.253899999894202,"msg":"request completed"}
 [32m‚úì[39m src/tests/order.integration.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1849[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Integration Tests[2m > [22mPOST /api/orders/create[2m > [22mshould successfully create an order and reserve inventory [33m 384[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Integration Tests[2m > [22mGET /api/orders/:id - Authorization[2m > [22mshould prevent unauthorized access [33m 383[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Integration Tests[2m > [22mGET /api/orders/:id - Authorization[2m > [22mshould allow authorized access to own order [33m 316[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Integration Tests[2m > [22mGET /api/orders/my[2m > [22mshould return user order history [33m 309[2mms[22m[39m
[90mstdout[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests
[22m[39m‚úÖ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstderr[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760784460257,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784460263,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
[90mstderr[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests[2m > [22m[2mshould immediately deny access after a user role is demoted from STAFF to USER
[22m[39mTanshu API Error for ISBN 9780134685991: Status 200, code: 10001, msg: ÈîôËØØÁöÑËØ∑Ê±ÇKEY

{"level":30,"time":1760784460625,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":367.6408999999985,"msg":"request completed"}
{"level":30,"time":1760784460629,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784460632,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":403},"responseTime":2.592299999669194,"msg":"request completed"}
{"level":30,"time":1760784460897,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784460902,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":403},"responseTime":4.522600000724196,"msg":"request completed"}
{"level":30,"time":1760784460907,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784460909,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
[90mstderr[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests[2m > [22m[2mshould immediately grant access after a user role is promoted from USER to STAFF
[22m[39mTanshu API Error for ISBN 9780134685994: Status 200, code: 10001, msg: ÈîôËØØÁöÑËØ∑Ê±ÇKEY

{"level":30,"time":1760784461028,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":201},"responseTime":121.12049999926239,"msg":"request completed"}
{"level":30,"time":1760784461313,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784461316,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
[90mstderr[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests[2m > [22m[2mshould enforce role check on every request, not just once per token
[22m[39mTanshu API Error for ISBN 9780134685995: Status 200, code: 10001, msg: ÈîôËØØÁöÑËØ∑Ê±ÇKEY

{"level":30,"time":1760784461417,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":104.00590000022203,"msg":"request completed"}
{"level":30,"time":1760784461420,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784461423,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":403},"responseTime":2.3434999994933605,"msg":"request completed"}
{"level":30,"time":1760784461425,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784461429,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
[90mstderr[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests[2m > [22m[2mshould enforce role check on every request, not just once per token
[22m[39mTanshu API Error for ISBN 9780134685997: Status 200, code: 10001, msg: ÈîôËØØÁöÑËØ∑Ê±ÇKEY

{"level":30,"time":1760784461542,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":116.89580000005662,"msg":"request completed"}
 [32m‚úì[39m src/tests/auth-role-revocation.integration.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1807[2mms[22m[39m
   [33m[2m‚úì[22m[39m Auth: Role Revocation Integration Tests[2m > [22mshould immediately deny access after a user role is demoted from STAFF to USER [33m 703[2mms[22m[39m
   [33m[2m‚úì[22m[39m Auth: Role Revocation Integration Tests[2m > [22mshould immediately grant access after a user role is promoted from USER to STAFF [33m 414[2mms[22m[39m
   [33m[2m‚úì[22m[39m Auth: Role Revocation Integration Tests[2m > [22mshould enforce role check on every request, not just once per token [33m 477[2mms[22m[39m
[90mstdout[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39m‚úÖ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstderr[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760784462040,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/sell-orders","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784462043,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760784462043,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","operatorId":1,"customerPhoneNumber":"13900139000","totalWeightKg":3.2,"unitPriceCents":250,"settlementType":"CASH","action":"CREATE_SELL_ORDER","msg":"STAFF member creating sell order"}
{"level":30,"time":1760784462079,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","operatorId":1,"targetUserId":2,"orderId":1,"totalAmount":800,"action":"SELL_ORDER_CREATED","msg":"Sell order created successfully"}
{"level":30,"time":1760784462080,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":39.16689999960363,"msg":"request completed"}
{"level":30,"time":1760784462354,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/sell-orders","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784462360,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":403},"responseTime":6.081000000238419,"msg":"request completed"}
 [32m‚úì[39m src/tests/sellOrders.integration.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1050[2mms[22m[39m
   [33m[2m‚úì[22m[39m Sell Orders API[2m > [22mallows staff to create and complete a sell order [33m 342[2mms[22m[39m
[90mstdout[2m | tests/integration/db/views/orderView.test.ts
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m‚úì[39m tests/integration/db/views/orderView.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1070[2mms[22m[39m
   [33m[2m‚úì[22m[39m db/views/orderView[2m > [22mreturns the expected public shape for orders with inventory items [33m 380[2mms[22m[39m
   [33m[2m‚úì[22m[39m db/views/orderView[2m > [22msupports includes with the same inventory shape [33m 380[2mms[22m[39m
   [33m[2m‚úì[22m[39m db/views/orderView[2m > [22mexposes only the base fields when using the basic selector [33m 310[2mms[22m[39m
[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Lock acquired for "test:concurrent-lock-verification". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ
[22m[39m[AdvisoryLock] Lock released for "test:concurrent-lock-verification".

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•ÂÖÅËÆ∏‰∏çÂêåÈîÅÂêçÁöÑ‰ªªÂä°Âπ∂ÂèëÊâßË°å
[22m[39m[AdvisoryLock] Lock acquired for "test:lock-b". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•ÂÖÅËÆ∏‰∏çÂêåÈîÅÂêçÁöÑ‰ªªÂä°Âπ∂ÂèëÊâßË°å
[22m[39m[AdvisoryLock] Lock acquired for "test:lock-a". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•ÂÖÅËÆ∏‰∏çÂêåÈîÅÂêçÁöÑ‰ªªÂä°Âπ∂ÂèëÊâßË°å
[22m[39m[AdvisoryLock] Lock released for "test:lock-b".

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•ÂÖÅËÆ∏‰∏çÂêåÈîÅÂêçÁöÑ‰ªªÂä°Âπ∂ÂèëÊâßË°å
[22m[39m[AdvisoryLock] Lock released for "test:lock-a".

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Âú®‰ªªÂä°ÊäõÂá∫ÂºÇÂ∏∏Êó∂‰ªçÁÑ∂ÈáäÊîæÈîÅ
[22m[39m[AdvisoryLock] Lock acquired for "test:error-handling-lock". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Âú®‰ªªÂä°ÊäõÂá∫ÂºÇÂ∏∏Êó∂‰ªçÁÑ∂ÈáäÊîæÈîÅ
[22m[39m[AdvisoryLock] Lock released for "test:error-handling-lock".

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Âú®‰ªªÂä°ÊäõÂá∫ÂºÇÂ∏∏Êó∂‰ªçÁÑ∂ÈáäÊîæÈîÅ
[22m[39m[AdvisoryLock] Lock acquired for "test:error-handling-lock". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2mÂ∫îËØ•Âú®‰ªªÂä°ÊäõÂá∫ÂºÇÂ∏∏Êó∂‰ªçÁÑ∂ÈáäÊîæÈîÅ
[22m[39m[AdvisoryLock] Lock released for "test:error-handling-lock".

 [32m‚úì[39m src/tests/advisoryLock.integration.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1083[2mms[22m[39m
   [33m[2m‚úì[22m[39m Advisory Lock Concurrent Execution Tests[2m > [22mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ [33m 560[2mms[22m[39m
[90mstdout[2m | src/tests/refund-recovery.integration.test.ts[2m > [22m[2mRefund Recovery Integration
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/refund-recovery.integration.test.ts[2m > [22m[2mRefund Recovery Integration[2m > [22m[2mshould mark refund as FAILED after exceeding max attempts
[22m[39mFailed to process refund for out_trade_no: FAIL_1_1760784465740 Error: permanent failure
    at [90mC:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\[39msrc\tests\refund-recovery.integration.test.ts:128:52
    at [90mfile:///C:/Users/wapadil/WeChatProjects/miniprogram-13/bookworm-backend/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

[90mstderr[2m | src/tests/refund-recovery.integration.test.ts[2m > [22m[2mRefund Recovery Integration[2m > [22m[2mshould mark refund as FAILED after exceeding max attempts
[22m[39mRefund permanently failed after 5 attempts for out_trade_no: FAIL_1_1760784465740

 [32m‚úì[39m src/tests/refund-recovery.integration.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 972[2mms[22m[39m
   [33m[2m‚úì[22m[39m Refund Recovery Integration[2m > [22mshould resume processing refunds that are stuck in REFUND_PROCESSING [33m 532[2mms[22m[39m
   [33m[2m‚úì[22m[39m Refund Recovery Integration[2m > [22mshould mark refund as FAILED after exceeding max attempts [33m 435[2mms[22m[39m
[90mstdout[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39m‚úÖ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstderr[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760784466446,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"GET","url":"/api/acquisitions/check?isbn=9781234567897","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784466465,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":200},"responseTime":19.66179999988526,"msg":"request completed"}
{"level":30,"time":1760784466729,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"GET","url":"/api/acquisitions/check?isbn=9781234567898","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760784466734,"pid":3000,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":4.305500000715256,"msg":"request completed"}
 [32m‚úì[39m src/tests/acquisitions.integration.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 862[2mms[22m[39m
   [33m[2m‚úì[22m[39m Acquisitions Allowlist API[2m > [22mËøîÂõûÂèØÊî∂Ë¥≠ÁâàÊú¨ÂàóË°® [33m 408[2mms[22m[39m
[90mstdout[2m | tests/integration/db/views/inventoryView.test.ts
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m‚úì[39m tests/integration/db/views/inventoryView.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 659[2mms[22m[39m
   [33m[2m‚úì[22m[39m db/views/inventoryView[2m > [22mreturns public inventory shape without internal fields [33m 310[2mms[22m[39m
   [33m[2m‚úì[22m[39m db/views/inventoryView[2m > [22mincludes status for internal consumers via the basic selector [33m 348[2mms[22m[39m
[90mstdout[2m | src/tests/order-pagination.integration.test.ts[2m > [22m[2mOrder Cursor Pagination Integration
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m‚úì[39m src/tests/order-pagination.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 433[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Cursor Pagination Integration[2m > [22mshould return first page with next cursor for subsequent fetch [33m 429[2mms[22m[39m
[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests[2m > [22m[2mshould cancel expired orders and release inventory
[22m[39mCreated test user ID: [33m1[39m
Created inventory item IDs: [ [33m1[39m, [33m2[39m ]

[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests[2m > [22m[2mshould cancel expired orders and release inventory
[22m[39mFound inventory items: [ { id: [33m1[39m, status: [32m'in_stock'[39m }, { id: [33m2[39m, status: [32m'in_stock'[39m } ]

[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests[2m > [22m[2mshould cancel expired orders and release inventory
[22m[39mAtomically cancelled 1 orders and released 2 items back to stock.

 [32m‚úì[39m src/tests/order-expiration.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 436[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Expiration Integration Tests[2m > [22mshould cancel expired orders and release inventory [33m 431[2mms[22m[39m
[90mstdout[2m | src/tests/order-payment-amount.integration.test.ts[2m > [22m[2morder payment amount integrity
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstderr[2m | src/tests/order-payment-amount.integration.test.ts[2m > [22m[2morder payment amount integrity[2m > [22m[2mrejects payment params when stored total diverges from recalculated sum
[22m[39m{ orderId: [33m1[39m, storedAmount: [33m8001[39m, calculatedAmount: [33m8000[39m, userId: [33m1[39m } CRITICAL: Amount mismatch detected for order 1. This indicates data corruption!

 [32m‚úì[39m src/tests/order-payment-amount.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 464[2mms[22m[39m
   [33m[2m‚úì[22m[39m order payment amount integrity[2m > [22mrejects payment params when stored total diverges from recalculated sum [33m 457[2mms[22m[39m

[2m Test Files [22m [1m[32m19 passed[39m[22m[90m (19)[39m
[2m      Tests [22m [1m[32m116 passed[39m[22m[90m (116)[39m
[2m   Start at [22m 18:46:54
[2m   Duration [22m 54.45s[2m (transform 775ms, setup 1.36s, collect 1.13s, tests 44.04s, environment 0ms, prepare 159ms)[22m

Tearing down all test containers...
All containers stopped.
