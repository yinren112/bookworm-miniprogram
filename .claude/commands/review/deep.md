---
description: "执行一次深度架构审查，专注于数据访问模式、复杂性和对核心原则的遵守情况。"
---
请对 `bookworm-backend/` 目录下的所有TypeScript代码执行一次深度架构审查。你的审查必须严格遵循以下三个层面，并以结构化的方式报告你的发现。

### **层面一：数据访问与性能 (`Database is Law`)**

1.  **N+1 查询**: 扫描所有代码，特别是服务层 (`src/services/`)，找出任何在循环（`for`, `map`, `forEach`）内部执行数据库查询 (`await dbCtx...`) 的模式。这是一个严重的性能反模式。
2.  **事务边界**: 审查所有 `prisma.$transaction` 的使用。是否存在事务范围过大的情况？例如，事务块中是否包含了不必要的同步业务逻辑，或者更糟糕的，包含了外部API调用？事务应该只包裹纯粹的数据库操作。
3.  **数据获取效率**: 检查 Prisma 查询，特别是 `findMany` 和 `findUnique`。是否存在获取了整个模型对象但只使用了其中少数几个字段的情况？如果存在，建议使用 `select` 或 `include` 来精确指定所需数据。

### **层面二：代码复杂性与"品味" (`Good Taste & Simplicity`)**

1.  **逻辑嵌套深度**: 找出任何函数中代码逻辑嵌套超过3层的地方（`if/else`, `for`, `try/catch` 的组合）。这些是需要重构的明显信号。
2.  **错误处理一致性**: 检查 `try...catch` 块。是否存在捕获了错误但没有重新抛出 `ApiError` 或其他业务特定错误，而是简单地 `console.error` 或返回 `null` 的情况？这会破坏我们统一的错误处理流程。
3.  **函数职责**: 找出那些看起来承担了过多职责的函数。一个好的函数应该只做一件事。如果一个函数的名字里有 "And" 这个词，它可能就有问题。

### **报告格式**

你的输出**必须**是一个Markdown列表。对于每一个发现的问题，都必须严格按照以下格式提供：

```markdown
**[问题类型]** - [简短描述]

- **文件**: `path/to/file.ts:line_number`
- **问题**: [详细解释为什么这是一个问题，它违反了哪个原则。]
- **建议**: [提出一个具体的、可执行的修复方案。]
```

---
现在，开始审查。