# CI守门增强配置片段
# 将以下job添加到 .github/workflows/ci-lint-scan.yml

  # 新增守门Job: 文档位置白名单检查
  docs-whitelist-check:
    name: Check Documentation Organization
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify root markdown files whitelist
        run: |
          # 检查根目录是否仅包含白名单.md文件
          NON_WHITELISTED=$(find . -maxdepth 1 -name "*.md" \
            -not -name "README.md" \
            -not -name "CHANGELOG.md" \
            -not -name "SECURITY_NOTES.md" \
            -not -name "CLAUDE.md" \
            -not -name "AGENTS.md" \
            -not -name "REPORT.md" \
            | wc -l)

          if [ "$NON_WHITELISTED" -gt 0 ]; then
            echo "❌ 发现非白名单.md文件在根目录:"
            find . -maxdepth 1 -name "*.md" \
              -not -name "README.md" \
              -not -name "CHANGELOG.md" \
              -not -name "SECURITY_NOTES.md" \
              -not -name "CLAUDE.md" \
              -not -name "AGENTS.md" \
              -not -name "REPORT.md"
            echo ""
            echo "请迁移非白名单文档到docs/目录"
            exit 1
          fi

          echo "✅ 文档位置符合规范"

  # 新增守门Job: 大文件检测
  file-size-check:
    name: Check for Oversized Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect files larger than 512KB
        run: |
          # 查找>512KB的非SVG文件
          LARGE_FILES=$(find . -type f -size +512k \
            -not -path "./.git/*" \
            -not -path "*/node_modules/*" \
            -not -name "*.svg" \
            | wc -l)

          if [ "$LARGE_FILES" -gt 0 ]; then
            echo "❌ 发现超过512KB的文件:"
            find . -type f -size +512k \
              -not -path "./.git/*" \
              -not -path "*/node_modules/*" \
              -not -name "*.svg" \
              -exec ls -lh {} \;
            echo ""
            echo "大文件不应入库,请使用Git LFS或外部存储"
            exit 1
          fi

          echo "✅ 无超大文件"

  # 新增守门Job: TypeScript严格模式检查
  typescript-strict-check:
    name: TypeScript Strict Mode Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: bookworm-backend/package-lock.json

      - name: Install dependencies
        working-directory: bookworm-backend
        run: npm ci

      - name: Run TypeScript compiler check
        working-directory: bookworm-backend
        run: npx tsc --noEmit

      - name: Verify strict mode enabled
        working-directory: bookworm-backend
        run: |
          STRICT=$(cat tsconfig.json | grep '"strict":' | grep 'true')
          if [ -z "$STRICT" ]; then
            echo "❌ TypeScript strict mode未开启!"
            exit 1
          fi
          echo "✅ Strict mode已启用"

  # 增强现有job: 添加测试覆盖率阈值
  test-with-coverage-threshold:
    name: Backend Tests with Coverage Threshold
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: bookworm_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: bookworm-backend/package-lock.json

      - name: Install dependencies
        working-directory: bookworm-backend
        run: npm ci

      - name: Generate Prisma Client
        working-directory: bookworm-backend
        run: npx prisma generate

      - name: Run tests with coverage
        working-directory: bookworm-backend
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/bookworm_test
        run: |
          npm test -- --coverage \
            --coverage.lines=60 \
            --coverage.functions=50 \
            --coverage.branches=50 \
            --coverage.statements=60

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: bookworm-backend/coverage/coverage-final.json
          flags: backend
          name: bookworm-backend

  # 新增Job: 安全审计(需官方registry)
  security-audit:
    name: Security Audit (npm official registry)
    runs-on: ubuntu-latest
    continue-on-error: true  # 不阻塞PR,仅警告
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        working-directory: bookworm-backend
        run: |
          # 临时切换到官方registry
          npm config set registry https://registry.npmjs.org/
          npm audit --audit-level=moderate || echo "⚠️ 发现安全漏洞,请检查"
