[
  {
    "status": "存在（study.ts约1184行，仍为超长文件）",
    "id": "LM-001",
    "severity": "P0",
    "area": "backend",
    "path": "src/routes/study.ts",
    "symbol": "studyRoutes",
    "evidence": {
      "why": [
        "单文件 1339 行，包含 15+ 个端点定义",
        "超过推荐的 400 行文件长度限制 3 倍以上"
      ],
      "signals": [
        "超长文件: 1339 行",
        "多功能混杂: 课程/卡片/刷题/急救包/Streak/排行榜/导入"
      ],
      "loc_hint": "Lines 1-1339, 整个文件"
    },
    "impact": "难以维护，容易引入bug，单点故障风险，新功能开发者需要了解整个文件才能安全修改",
    "recommendation": [
      "按功能拆分：study/courses.ts, study/cards.ts, study/quiz.ts, study/cheatsheets.ts, study/streak.ts, study/admin.ts",
      "提取共享逻辑到中间件：resolveCourseIds, resolveCardByContentId 等",
      "使用 Fastify 的 register 功能组合子路由"
    ],
    "verification": "运行 npm test && npm run test:integration，确保所有测试通过后，检查代码覆盖率"
  },
  {
    "status": "不存在（checkAnswer当前无深层嵌套）",
    "id": "LM-002",
    "severity": "P0",
    "area": "backend",
    "path": "src/services/study/quizService.ts",
    "symbol": "checkAnswer",
    "evidence": {
      "why": [
        "checkAnswer 函数使用 4 层嵌套的 switch-case 和条件判断",
        "答案校验逻辑过于复杂，难以验证所有边界情况"
      ],
      "signals": [
        "过深嵌套: 4+ 层",
        "大量分支: switch-case + 多层 if-else",
        "函数长度: >60 行"
      ],
      "loc_hint": "Lines 491-520, function checkAnswer"
    },
    "impact": "边界情况处理可能有遗漏，答案误判风险，不同题型的答案格式不统一导致用户答题体验不一致",
    "recommendation": [
      "拆分为策略模式：创建 AnswerChecker 接口和具体实现（SingleChoiceChecker, MultiChoiceChecker, FillBlankChecker）",
      "每种题型一个独立的校验器类",
      "增加更多单元测试覆盖边界情况：JSON格式、管道符分隔、大小写、空格等"
    ],
    "verification": "运行 npm test -- src/tests/quiz-answer-check.test.ts，确保所有答案格式都被正确解析"
  },
  {
    "status": "不存在（enrollCourse内部已使用事务）",
    "id": "LM-003",
    "severity": "P0",
    "area": "backend",
    "path": "src/routes/study.ts",
    "symbol": "enrollCourse endpoint",
    "evidence": {
      "why": [
        "注册课程端点先查询课程，然后调用 enrollCourse 服务",
        "无显式事务保护，可能在并发时产生数据不一致"
      ],
      "signals": [
        "关键业务操作",
        "多步骤写入",
        "缺乏事务注解"
      ],
      "loc_hint": "Lines 317-336, POST /api/study/courses/:courseKey/enroll"
    },
    "impact": "竞态条件下可能产生脏数据，如重复注册、注册计数不一致",
    "recommendation": [
      "使用 prisma.$transaction 包裹多步骤操作",
      "或确保 enrollCourse 服务内部已做事务处理（已在 study.ts 中部分实现，需全面审查）",
      "添加数据库级别的唯一约束作为最后防线"
    ],
    "verification": "审查所有写入操作的调用链，确认每个多步骤操作都在事务内"
  },
  {
    "status": "存在（后端幂等已覆盖风险）",
    "id": "LM-004",
    "severity": "P0",
    "area": "miniprogram",
    "path": "subpackages/review/pages/quiz/index.js",
    "symbol": "submitAnswer",
    "evidence": {
      "why": [
        "防重复提交依赖客户端的 submitting 状态",
        "网络延迟时用户可能重复点击提交按钮"
      ],
      "signals": [
        "竞态条件",
        "客户端状态不可靠",
        "缺乏服务端幂等性检查"
      ],
      "loc_hint": "Lines 321-381, async submitAnswer function"
    },
    "impact": "重复提交答案，导致答题记录重复、学习进度计算错误、周积分统计不准",
    "recommendation": [
      "增加服务端幂等性检查（已有部分实现，需全面检查）",
      "使用数据库唯一约束 (sessionId, userId, questionId) 防止重复写入",
      "前端增加防抖机制，至少 500ms 内禁止重复提交"
    ],
    "verification": "检查后端 submitQuizAnswer 的幂等性实现，模拟快速双击提交测试"
  },
  {
    "status": "存在（服务层仍有throw Error）",
    "id": "LM-005",
    "severity": "P1",
    "area": "backend",
    "path": "src/routes/study.ts",
    "symbol": "error handling",
    "evidence": {
      "why": [
        "有的抛 StudyServiceError，有的抛 ApiError，有的直接抛 Error",
        "错误处理模式不一致导致前端需要适配多种错误格式"
      ],
      "signals": [
        "不一致错误结构",
        "异常类型混乱",
        "多处 catch 块处理方式不同"
      ],
      "loc_hint": "Lines 327-335, 500-524, 598-601 等多处"
    },
    "impact": "错误处理代码难以统一，前端错误提示不一致，排查问题困难",
    "recommendation": [
      "统一错误层次结构：定义 StudyError -> ApiError -> HttpError 的转换链",
      "建立错误转换中间件，在服务层只抛 StudyError，路由层统一转换",
      "建立错误代码字典，所有错误都有唯一的 errorCode"
    ],
    "verification": "检查所有 catch 块的一致性，确保错误结构符合预期"
  },
  {
    "status": "不存在（resolveCourseIds未重复）",
    "id": "LM-006",
    "severity": "P1",
    "area": "backend",
    "path": "src/routes/study.ts",
    "symbol": "resolveCourseIds",
    "evidence": {
      "why": [
        "课程范围解析逻辑在多个端点内联实现",
        "类似的参数解析逻辑重复出现"
      ],
      "signals": [
        "重复逻辑",
        "内联代码块",
        "多处复制粘贴"
      ],
      "loc_hint": "Lines 154-189, resolveCourseIds function and its copies"
    },
    "impact": "修改课程范围解析规则时需要多处同步，容易遗漏导致行为不一致",
    "recommendation": [
      "提取为可复用的装饰器或中间件",
      "统一参数解析逻辑：创建 courseScopeMiddleware",
      "使用 Fastify 的 preHandler 注册中间件"
    ],
    "verification": "搜索所有 courseKey/courseId 解析代码，确认统一使用中间件"
  },
  {
    "status": "不存在（buildOptionStates仅在quiz内）",
    "id": "LM-007",
    "severity": "P1",
    "area": "miniprogram",
    "path": "subpackages/review/pages/quiz/index.js",
    "symbol": "buildOptionStates",
    "evidence": {
      "why": [
        "选项状态构建逻辑在页面内定义，可能在其他页面重复",
        "UI 逻辑与业务逻辑混杂"
      ],
      "signals": [
        "重复代码块",
        "页面内工具函数"
      ],
      "loc_hint": "Lines 581-591, buildOptionStates function"
    },
    "impact": "UI 逻辑变更时需要多处修改，容易产生 UI 不一致",
    "recommendation": [
      "提取到共享工具函数：utils/quiz-helpers.js",
      "建立统一的选项状态管理类",
      "在 WXS 中实现高性能的版本"
    ],
    "verification": "搜索所有 optionStates 相关代码，确认统一到工具函数"
  },
  {
    "status": "存在",
    "id": "LM-008",
    "severity": "P1",
    "area": "miniprogram",
    "path": "subpackages/review/pages/flashcard/index.js",
    "symbol": "Page data and implicit state",
    "evidence": {
      "why": [
        "大量使用 this._cards, this._questions 等隐式属性",
        "隐式状态与 data 中的显式状态并存"
      ],
      "signals": [
        "隐式状态",
        "模块级可变变量",
        "this._xxx 模式"
      ],
      "loc_hint": "Lines 100, 120, 163: this._cards usage"
    },
    "impact": "状态来源不明确，难以追踪，容易引入竞态bug，调试困难",
    "recommendation": [
      "所有状态统一放入 data 对象",
      "使用显式的 state 管理，避免 this._xxx 模式",
      "大型状态考虑使用 MobX 或 Redux 替代"
    ],
    "verification": "审查所有 Page 的隐式属性使用，确保全部迁移到 data"
  },
  {
    "status": "存在",
    "id": "LM-009",
    "severity": "P1",
    "area": "backend",
    "path": "src/services/study/cardScheduler.ts",
    "symbol": "LEITNER_INTERVALS, constants",
    "evidence": {
      "why": [
        "LEITNER_INTERVALS、MAX_DAILY_ATTEMPTS 等常量分散在各处",
        "dashboardService.ts 也有 CARD_SECONDS_PER_ITEM 等常量"
      ],
      "signals": [
        "魔法数字",
        "分散的常量定义",
        "多处重复定义"
      ],
      "loc_hint": "Lines 34-40: LEITNER_INTERVALS, MAX_DAILY_ATTEMPTS"
    },
    "impact": "修改业务规则时需要多处查找，容易遗漏，导致业务逻辑不一致",
    "recommendation": [
      "集中到 src/constants/study.ts",
      "统一常量命名规范：STUDY_ 前缀",
      "将关联的常量组织为枚举或配置对象"
    ],
    "verification": "搜索所有时间/数量相关的硬编码值，确认都使用常量"
  },
  {
    "status": "存在（缺少错题清除/排行榜并发/导入回滚测试）",
    "id": "LM-010",
    "severity": "P1",
    "area": "backend",
    "path": "src/services/study",
    "symbol": "missing tests",
    "evidence": {
      "why": [
        "错题本清除逻辑缺少边界测试",
        "排行榜并发排名计算未测试",
        "课程导入的事务回滚未测试"
      ],
      "signals": [
        "缺失测试的关键链路",
        "测试覆盖率不足"
      ],
      "loc_hint": "quizService.ts handleCorrectAnswer, streakService.ts getUserRank, importService.ts"
    },
    "impact": "回归风险高，重构时缺乏安全保障，边界情况可能引入bug",
    "recommendation": [
      "补充错题本边界测试：清除后再次答错",
      "增加排行榜并发测试：多人同时学习",
      "测试导入失败回滚场景：部分导入后失败"
    ],
    "verification": "运行 npm run test:integration，检查覆盖率报告，确保核心链路 >80%"
  },
  {
    "status": "存在",
    "id": "LM-011",
    "severity": "P2",
    "area": "backend",
    "path": "src/services/study",
    "symbol": "type definitions",
    "evidence": {
      "why": [
        "每个服务文件都有自己的类型定义",
        "缺乏统一的类型定义中心"
      ],
      "signals": [
        "类型定义分散",
        "重复的类型定义"
      ],
      "loc_hint": "quizService.ts:28-55, cardScheduler.ts:75-104"
    },
    "impact": "类型定义重复，修改时需要多处同步",
    "recommendation": [
      "建立 src/types/study.ts 统一类型定义",
      "共享的类型提取到 types 目录",
      "使用 TypeBox 统一运行时类型校验"
    ],
    "verification": "检查所有类型定义，确认无重复"
  },
  {
    "status": "存在",
    "id": "LM-012",
    "severity": "P2",
    "area": "backend",
    "path": "src/services/study",
    "symbol": "function naming",
    "evidence": {
      "why": [
        "submitQuizAnswer vs startQuizSession，命名风格不完全统一",
        "有的使用动词+名词，有的使用名词+动词"
      ],
      "signals": [
        "命名不一致",
        "缺乏命名规范"
      ],
      "loc_hint": "quizService.ts:162 submitQuizAnswer, line 60 startQuizSession"
    },
    "impact": "API 命名不一致，开发者使用时容易混淆",
    "recommendation": [
      "统一命名规范：动词+名词+名词",
      "startQuizSession -> startQuiz",
      "submitQuizAnswer -> submitAnswer"
    ],
    "verification": "代码审查，确认命名规范"
  },
  {
    "status": "存在",
    "id": "LM-013",
    "severity": "P2",
    "area": "backend",
    "path": "src/services/study",
    "symbol": "code comments",
    "evidence": {
      "why": [
        "有的函数有详细JSDoc，有的完全没有注释",
        "关键算法缺乏注释说明"
      ],
      "signals": [
        "注释质量不一",
        "关键算法无注释"
      ],
      "loc_hint": "quizService.ts:230-270, cardScheduler.ts:110-155"
    },
    "impact": "新开发者难以理解代码，维护成本高",
    "recommendation": [
      "建立代码注释规范",
      "关键算法必须注释",
      "公开API必须有JSDoc"
    ],
    "verification": "代码审查，确认关键代码有注释"
  },
  {
    "status": "存在",
    "id": "LM-014",
    "severity": "P2",
    "area": "miniprogram",
    "path": "subpackages/review/pages/quiz/index.js",
    "symbol": "toggleStar",
    "evidence": {
      "why": [
        "星标更新使用 Promise.then().catch() 链式调用",
        "混合使用 async/await 和 Promise 链"
      ],
      "signals": [
        "回调地狱",
        "异步风格不统一"
      ],
      "loc_hint": "Lines 225-253, toggleStar function"
    },
    "impact": "代码风格不一致，可读性差",
    "recommendation": [
      "使用 async/await 统一异步代码风格",
      "避免 Promise.then().catch() 链式调用"
    ],
    "verification": "代码审查，确认异步风格统一"
  }
]
