

## PRD.md

### 1. 背景与问题

当前小程序前台已收敛为学习复习工具，复习域具备课程、闪卡、测验、学霸笔记、连胜与周榜等能力，员工域仅保留线下扫码录入入口。你们正等待课程资料到位，短期无法通过“新增内容”驱动增长。

在此阶段，最常见的增长瓶颈来自三处：

* **启动成本高**：用户进入首页后要做多次决策，缺少“一键开始今日复习”的强入口。
* **会话完成率不足**：中途退出、网络波动、状态不一致，导致完成一次复习的闭环不稳。
* **缺少召回手段**：订阅消息没被产品化成“用户自愿、可持续触达”的复习提醒机制。

### 2. 目标与成功指标

#### 目标

* 把复习主链路做成强闭环：进入首页 → 一键开始 → 完成会话 → 结算反馈 → 次日召回。
* 在不依赖新课程资料的前提下，提升日活与会话完成率，并建立可观测体系。

#### 成功指标（上线后 14 天，按日滚动观察）

* **首页到会话启动转化率**：进入复习首页后，10 分钟内启动闪卡或测验的比例 ≥ 45%
* **会话完成率**：启动会话后到达结算页的比例 ≥ 60%
* **人均有效学习时长**：完成会话用户的人均学习时长提升 ≥ 15%
* **次日留存（D1）**：开启过复习会话的用户 D1 提升 ≥ 8%
* **订阅消息授权率**：出现订阅引导的用户中，授权比例 ≥ 25%
* **订阅召回点击率**：订阅消息到达用户后，24 小时内回访打开比例 ≥ 8%（以打开事件归因）

> 订阅消息触发必须由用户点击行为发起，且一次授权对应一次可发送的服务通知，这决定了产品设计必须把授权放在明确的按钮动作中，并且要控制打扰频率。([腾讯云][1])

### 3. 用户与场景

* **轻度用户**：临近考试，偶尔打开，想快速知道“今天要做什么”。
* **中重度用户**：连续学习，关心连胜、周榜，期待更高效率和更强反馈。
* **新用户**：缺少课程或未报名，最需要清晰的下一步指引。
* **员工（低频）**：偶尔扫码录入，主要诉求是稳定与少出错。

### 4. 范围定义

#### 本次做什么

* 复习首页看板重构：信息层级、今日目标、强 CTA、一键开始、热力图呈现优化
* 会话闭环：闪卡/测验的进度、退出与恢复、结算页的反馈与下一步引导
* 错题强化入口：把“错题清理”作为独立快捷路径（使用现有 wrong tracking 能力）
* 订阅消息产品化：授权引导、偏好设置、后端存储订阅状态、定时发送“今日到期提醒”
* 性能与稳定性：分包预下载、请求合并、缓存与统一错误态
* 可观测：关键漏斗埋点、错误与性能上报、仪表盘口径

#### 本次不做什么

* 新课程内容生产或大规模导入（仅做导入前置校验与空状态承接）
* 交易域入口恢复
* AI 自动生成题目或笔记

### 5. 用户旅程

1. 进入复习首页
2. 首屏看到：今日到期量、预计耗时、继续上次会话（如有）、一键开始按钮
3. 点击“一键开始今日复习”
4. 系统按策略分配：先闪卡后测验，或按用户上次偏好
5. 完成会话进入结算：完成量、正确率、连胜变化、明日预测
6. 在结算页点击“订阅明日提醒”（可选）
7. 次日收到提醒，点击回到复习首页直接开始

### 6. 功能需求

> 编号可追踪，验收尽量 Given/When/Then，可测且不依赖“感觉更好”。

#### FR-001 复习首页强入口与信息层级（P0）

* 描述：复习首页首屏提供“一键开始今日复习”，同时展示今日到期卡片数、待测验题数、错题数、预计耗时。
* 依赖：后端新增聚合接口 `GET /study/dashboard`（见数据契约）。
* 验收标准

  * Given 用户已登录
  * When 进入复习首页
  * Then 首屏出现“一键开始今日复习”按钮与 4 个指标卡片，且 300ms 内出现骨架屏或占位加载态

#### FR-002 看板热力图与课程区块可点击性（P0）

* 描述：过去 35 天活跃度热力图可点击进入“学习记录”或“周榜”，课程区块显示“当前学习课程”并提供“继续学习”。
* 验收标准

  * When 点击热力图任意有数据日期
  * Then 跳转到记录页并定位到该日期的统计卡片

#### FR-003 一键开始的会话编排策略（P0）

* 描述：一键开始默认策略为“先闪卡（到期优先）后测验（短测）”，若用户上次以测验结束，则下次优先测验。
* 验收标准

  * Given 用户上次完成的会话类型为 quiz
  * When 点击一键开始
  * Then 默认进入 quiz，会话结束后引导进入 flashcard

#### FR-004 闪卡会话进度与可恢复（P0）

* 描述：闪卡过程中显示进度（已完成/总量）、剩余预计时间；中途退出时保存会话快照，下次进入可继续。
* 验收标准

  * When 学习中返回上一页并在 24 小时内再次进入
  * Then 出现“继续上次复习”入口，继续后从上次未完成处开始

#### FR-005 测验会话即时反馈与错题标记（P0）

* 描述：测验支持即时判题反馈；错题自动进入错题池，并在结算页提供“错题强化”按钮。
* 验收标准

  * When 用户答错
  * Then 题目记录为 wrong，结算页出现“错题强化”入口且可进入

#### FR-006 结算页的反馈闭环与下一步（P0）

* 描述：结算页展示完成量、正确率、连胜变化、预计下次到期；提供两个主按钮“再来一组”“回到首页”，一个次按钮“订阅明日提醒”。
* 验收标准

  * When 完成会话进入结算页
  * Then 结算页信息完整展示且三按钮布局稳定，任一按钮点击有明确 loading 与结果反馈

#### FR-007 订阅消息授权引导与偏好设置（P0）

* 描述：在结算页以按钮触发订阅弹窗，用户可选择订阅“明日复习提醒”；在个人中心新增“复习提醒设置”入口，展示当前授权状态并支持重新授权。
* 依赖：小程序端使用 `wx.requestSubscribeMessage`，后端存储授权结果与发送计划。订阅弹窗必须由用户点击触发。([腾讯云][1])
* 验收标准

  * When 用户点击“订阅明日提醒”
  * Then 弹出订阅授权弹窗；用户同意后，后端记录状态为 ACCEPT，并生成 nextSendAt

#### FR-008 每日提醒发送任务（P1）

* 描述：每天固定时间（默认 09:00 Asia/Shanghai）扫描有到期任务且订阅有效的用户，下发一条订阅消息，文案包含“到期卡片数/建议耗时/一键进入入口页”。
* 依赖：后端定时任务与订阅消息发送接口；发送节奏遵守“单用户每日最多 1 条”。([腾讯云][1])
* 验收标准

  * Given 用户订阅有效且次日存在到期任务
  * When 到达发送时间
  * Then 用户收到消息，点击后进入复习首页并高亮“一键开始”

#### FR-009 统一加载、空状态、错误态组件（P0）

* 描述：复习域页面统一三态：骨架屏、空状态、错误态；错误态含“重试”与“反馈”入口。
* 验收标准

  * When 后端接口返回非 2xx 或超时
  * Then 页面展示统一错误态，点击重试会重新请求

#### FR-010 请求合并与缓存策略（P0）

* 描述：首页聚合接口替代多接口并发；课程列表、热力图等允许 10 分钟缓存（本地 storage），并带版本号失效策略。
* 验收标准

  * When 同一用户 10 分钟内重复进入首页
  * Then 不重复请求稳定数据接口或命中缓存，首屏更快进入可交互态

#### FR-011 分包预下载（P1）

* 描述：进入复习首页时预下载 review 子包中最常用页面资源（flashcard、quiz、settlement），减少首次进入子包页面的等待。
* 依赖：`app.json` 配置 `preloadRule`。([掘金][2])
* 验收标准

  * When 首次从首页进入闪卡页面
  * Then 分包下载等待时间 P75 下降（以性能上报或日志统计为准）

#### FR-012 员工扫码入口稳定性兜底（P2）

* 描述：低频场景下做轻量优化：权限提示、扫码失败重试、网络失败提示，不做离线队列。
* 验收标准

  * When 用户拒绝相机权限
  * Then 页面展示明确指引到系统设置的提示文案

### 7. 数据与状态

#### 新增或调整的数据结构（后端）

1. `StudyDashboard` 聚合响应（不落库，可按需计算）

* 字段示例：`dueCardCount`、`dueQuizCount`、`wrongCount`、`etaMinutes`、`streakDays`、`activeHeatmap[35]`、`currentCourse`

2. `StudyReminderSubscription`（建议落库）

* `id`
* `userId`
* `templateId`（当前仅 1 个模板，后续可扩展）
* `status`：`ACCEPT | REJECT | BAN`
* `consentAt`
* `nextSendAt`
* `lastSentAt`
* `lastPayloadHash`（防重复）
* `timezone`（默认 Asia/Shanghai，可后续补用户时区）

3. `StudyReminderSendLog`（可选，便于追踪）

* `subscriptionId`
* `sentAt`
* `resultCode`、`resultMsg`

#### 状态机

* 订阅状态：`UNKNOWN → ACCEPT/REJECT → BAN`
* 会话状态：`IDLE → IN_PROGRESS → COMPLETED | ABORTED → (可恢复 IN_PROGRESS)`

### 8. 交互与界面

#### 复习首页（Tab1）

* 顶部：今日概览卡片区

  * 今日到期卡片数
  * 今日待测验题数
  * 今日错题数
  * 预计耗时
* 主 CTA：一键开始今日复习
* 次 CTA：继续上次会话（仅当存在未完成快照）
* 中部：当前学习课程卡片（课程名、进度、继续按钮）
* 底部：35 天热力图（点击进入学习记录或周榜）

空状态规则：

* 未报名课程：展示“去课程列表报名”按钮
* 无到期任务：展示“今日无到期，来一组巩固”按钮（进入自选数量会话）

#### 结算页

* 标题：本次完成总结
* 数据：完成量、正确率、连胜变化、明日预计
* 按钮：再来一组 / 回到首页 / 订阅明日提醒
* 文案约束：订阅按钮旁提示“每日最多 1 条，可在我的里关闭”

#### 个人中心（Tab2）新增

* 复习提醒设置：展示订阅状态、最近一次发送时间、重新授权按钮

### 9. 权限与安全

* 订阅消息：仅在用户点击按钮时触发订阅弹窗；后端保存订阅结果与发送日志，避免重复发送与刷屏。([腾讯云][1])
* 员工工具：入口仅对 STAFF 角色可见，后端接口也必须做权限校验，禁止仅靠前端隐藏。
* 错误上报：脱敏处理，禁止上传手机号、微信敏感字段、完整请求体。

### 10. 性能与兼容

* 首屏可交互时间目标：P75 ≤ 1.5s（以 `getPerformance` 或自定义打点计算）
* 分包预下载：进入复习首页触发预下载 review 分包关键页面
* 小程序错误监控：App 级别监听错误并上报，结合页面路由与用户动作链路定位问题([腾讯云][3])
* 性能数据采集可依赖 `getPerformance` 获取启动与渲染阶段耗时，形成趋势指标([腾讯云][4])

### 11. 观测与埋点

#### 关键事件

* `review_home_view`：进入复习首页
* `review_start_click`：点击一键开始
* `session_start`：会话开始（type=flashcard/quiz）
* `session_abort`：中途退出（reason=back/close/crash）
* `session_complete`：到达结算页
* `subscribe_click`：点击订阅按钮
* `subscribe_result`：授权结果（accept/reject）
* `reminder_send`：发送结果（server）
* `reminder_open`：从消息打开进入（client）

#### 关键属性

* `courseKey`、`dueCardCount`、`etaMinutes`、`networkType`、`device`、`appVersion`、`route`

#### 漏斗口径

* 首页曝光 → 一键开始点击 → 会话开始 → 会话完成 → 次日回访

### 12. 测试与发布

* 测试清单

  * 新用户无课程空状态
  * 有课程但无到期任务
  * 到期任务多的分页或批次加载
  * 网络失败与重试
  * 会话中途退出后恢复
  * 订阅授权同意与拒绝
  * 后端定时任务发送去重
* 灰度发布

  * 先对 10% 用户开启订阅入口与聚合接口
  * 观察错误率与会话完成率后全量
* 回滚

  * 保留旧接口与旧首页路由开关，配置回切到旧逻辑

### 13. 风险与开放问题

* 订阅消息模板内容与关键词字段需要在公众平台配置，字段限制需最终以平台为准。
* 时区策略：默认 Asia/Shanghai，若用户群体存在跨时区，需要补充时区采集与发送策略。
* 聚合接口会增加后端计算压力，需要配合缓存与限流。
* 分包预下载策略需要根据包体大小与网络环境调参。

### 14. 决策记录

* 以“日活与完成率”为第一优先级，因此先做强入口、一键开始与会话闭环，再做更复杂的内容扩展。
* 允许后端小改动，因此新增 `GET /study/dashboard` 聚合接口，减少首页并发请求与前端拼装复杂度。
* 员工工具低频，本轮仅做轻量稳定性兜底，避免引入离线队列等高成本模块。
* 订阅消息可用，选择在结算页触发授权，并限制每日最多 1 条，优先保证召回有效且低打扰。([腾讯云][1])

---

## DEV_BRIEF.md

### 1. 一句话目标

把复习首页升级为“一键开始今日复习 + 可恢复会话 + 订阅明日提醒”的强闭环，并用聚合接口、预下载与埋点保证更高完成率与可观测性。

### 2. 现状扫描

#### 前端（`miniprogram/`）

* TabBar 页面：`pages/review/`（复习首页），`pages/profile/`（个人中心）
* 复习子页面：`subpackages/review/pages/`（课程、闪卡、测验、急救包、周榜、结算等）
* 客服页：`pages/customer-service/`，通用 webview：`pages/webview/`
* 网络层：存在 `api.js` 与登录守卫链路（401 处理会触发 ensureLoggedIn/login 再 request），需要注意依赖链与重试策略（避免循环与重复请求）

#### 后端（`bookworm-backend/`）

* Study 域在 `src/services/study/`：`courseService.ts`、`cardScheduler.ts`（Leitner 盒子 1/3/7/14/30 天）、`quizService.ts`、`cheatsheetService.ts`、`streakService.ts`、`feedbackService.ts`、`importService.ts`
* 系统有 cron 类后台任务与监控能力（Prometheus `/metrics`），适合承载每日提醒发送任务

### 3. 改动清单

> 按路径描述改动点，代码助手可据此定位文件。

#### 前端

1. `miniprogram/pages/review/`

* 重构首页 UI：加入今日概览卡片区、主 CTA、一键开始逻辑、继续会话入口
* 接入 `GET /study/dashboard`
* 增加本地缓存（10 分钟）与版本失效策略

2. `miniprogram/subpackages/review/pages/flashcard/`

* 增加会话进度条与 ETA 展示
* 增加退出保存快照与恢复入口对接（接口或本地存储）
* 结算页跳转参数补全（完成量、正确率等）

3. `miniprogram/subpackages/review/pages/quiz/`

* 即时反馈与错题标记 UI 校验
* 结算页入口统一

4. `miniprogram/subpackages/review/pages/settlement/`（若存在）

* 新增“订阅明日提醒”按钮
* 调用 `wx.requestSubscribeMessage`，拿到结果后调用后端 `POST /study/reminders/subscribe`

5. `miniprogram/pages/profile/`

* 新增“复习提醒设置”入口页或区块
* 展示订阅状态与重新授权按钮

6. `miniprogram/app.json`

* 配置 `preloadRule`：进入 `pages/review/` 时预下载 `subpackages/review` 的关键分包页面资源([掘金][2])

7. 新增 `miniprogram/utils/track.js`（或等价模块）

* 统一埋点上报封装：事件名、属性、节流、失败降级到本地队列

#### 后端

1. `bookworm-backend/src/routes/study/`（按现有路由组织调整）

* 新增 `GET /study/dashboard`
* 新增 `POST /study/reminders/subscribe`
* 新增 `GET /study/reminders/status`

2. `bookworm-backend/src/services/study/dashboardService.ts`（新增）

* 聚合计算 dueCardCount、dueQuizCount、wrongCount、eta、热力图、streak、currentCourse
* 内部可调用现有 `cardScheduler`、`quizService`、`streakService` 等

3. Prisma

* 新增表 `StudyReminderSubscription`（必需）
* 可选新增 `StudyReminderSendLog`

4. 定时任务

* 新增 job：`sendStudyReminders`
* 每日固定时间扫描并发送，带去重与失败重试策略
* 发送频率：单用户每日最多 1 条([腾讯云][1])

### 4. 接口与数据契约

#### 4.1 `GET /study/dashboard`

* 请求：无或 `courseKey?`（可选）
* 响应示例

```json
{
  "dueCardCount": 32,
  "dueQuizCount": 10,
  "wrongCount": 7,
  "etaMinutes": 18,
  "streakDays": 5,
  "activeHeatmap": [
    {"date":"2026-01-19","count":1},
    {"date":"2026-01-20","count":0}
  ],
  "currentCourse": {
    "courseKey":"MA101",
    "title":"高数上",
    "progress":0.42
  },
  "resumeSession": {
    "type":"flashcard",
    "sessionId":"abc",
    "updatedAt":"2026-01-23T08:00:00.000Z"
  }
}
```

* 错误码

  * `401` 未登录
  * `500` 聚合计算失败

#### 4.2 `POST /study/reminders/subscribe`

* 请求

```json
{
  "templateId": "TEMPLATE_ID",
  "result": "accept",
  "timezone": "Asia/Shanghai"
}
```

* 响应

```json
{
  "status": "ACCEPT",
  "nextSendAt": "2026-01-24T01:00:00.000Z"
}
```

* 规则

  * `result=reject` 时写入 `REJECT`，不创建 nextSendAt
  * 重复提交同一模板：更新 consentAt 与 status，保持幂等（按 userId+templateId 唯一）

#### 4.3 `GET /study/reminders/status`

* 响应

```json
{
  "status": "ACCEPT",
  "templateId": "TEMPLATE_ID",
  "lastSentAt": "2026-01-22T01:00:00.000Z",
  "nextSendAt": "2026-01-24T01:00:00.000Z"
}
```

### 5. 实施步骤

1. 现状确认

* 列出复习首页当前请求的接口清单与耗时
* 确认闪卡与测验是否已有 sessionId 与进度持久化字段

2. 后端先行

* 实现 `dashboardService` 与 `GET /study/dashboard`
* Prisma 加表并迁移
* 实现订阅状态写入与查询接口

3. 前端首页改造

* 接入 dashboard 接口
* 落地 UI 三态与缓存策略
* 一键开始编排逻辑

4. 会话可恢复

* 闪卡与测验写入 resumeSession 所需字段
* 首页展示继续入口并打通跳转

5. 订阅消息闭环

* 结算页按钮触发 `wx.requestSubscribeMessage`（必须点击触发）([腾讯云][1])
* 将结果回传后端并展示状态
* 个人中心补“提醒设置”

6. 分包预下载

* 配置 `preloadRule` 并验证首进子包速度变化([掘金][2])

7. 定时发送任务（P1）

* 新增 job 与发送日志
* 灰度到小流量用户，验证到达与点击归因

8. 埋点与监控

* 前端事件打点与后端接收
* 接入性能采集（可基于 `getPerformance` 的启动与渲染阶段耗时）([腾讯云][4])
* App 级错误监听并上报([腾讯云][3])

### 6. 测试要求

* 后端

  * dashboard 聚合：有无课程、有无到期、有无错题、并发请求稳定性
  * subscribe 幂等：重复 accept、accept→reject、reject→accept
  * job 去重：同一用户同一日最多发送 1 次
* 前端

  * 首页三态：加载、空、错
  * 一键开始路径：优先 quiz/优先 flashcard 的分支
  * 会话恢复：退出后 24 小时内恢复
  * 订阅流程：同意、拒绝、系统设置关闭后重新授权

### 7. 验收口径

* 对应 PRD 成功指标与 P0 功能点：

  * 首页到会话启动转化率 ≥ 45%
  * 会话完成率 ≥ 60%
  * 订阅授权率 ≥ 25%
  * 订阅消息必须由按钮点击触发，且用户每日最多 1 条([腾讯云][1])
  * 分包预下载生效且首进子包等待时间下降([掘金][2])

### 8. 运行命令

后端（`bookworm-backend/`）

* `npm run dev`
* `npm test`
* `npm run test:integration`
* `npm run lint`
* `npm run migrate:dev`

小程序（`miniprogram/`）

* 使用微信开发者工具打开目录并构建预览
* 需要从项目现有配置确认 API endpoint 设置位置（通常在 miniprogram 配置或 utils/api.js）

---

如果你接下来要我把这套改动拆成“P0 一周内必须做完的最小集合”，我可以按依赖关系给出更细的任务单与验收用例映射，便于直接丢给 Codex/Claude Code 分步执行。

[1]: https://cloud.tencent.com/document/product/1301/103770?utm_source=chatgpt.com "实现小程序订阅消息推送"
[2]: https://juejin.cn/post/7409675898327236647?utm_source=chatgpt.com "微信小程序中使用分包、独立分包、分包预下载的使用和注意 ..."
[3]: https://cloud.tencent.com/developer/article/1683396?utm_source=chatgpt.com "详解：如何监控小程序异常及处理错误？"
[4]: https://cloud.tencent.com/developer/article/2162765?utm_source=chatgpt.com "微信小程序性能监控方式"
