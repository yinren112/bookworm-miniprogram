
> bookworm-backend@1.0.1 test:integration
> dotenv -e .env.test -- vitest run --config vitest.integration.config.ts


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mC:/Users/wapadil/WeChatProjects/miniprogram-13/bookworm-backend[39m

[Simple Setup] Using existing DATABASE_URL from .env.test
[Simple Setup] Database URL configured
[Simple Setup] Applying migrations...
[Simple Setup] Migrations applied successfully
[Simple Setup] Resetting database...
[Simple Setup] Database reset complete
[Simple Setup] Setup complete
[90mstdout[2m | src/tests/services/create.integration.test.ts[2m > [22m[2mOrder Creation Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

 [31m‚ùØ[39m src/tests/services/create.integration.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 8138[2mms[22m[39m
[31m   [31m√ó[31m Order Creation Integration Tests[2m > [22mcreateOrder - Happy Path[2m > [22mshould successfully create order with single item[39m[33m 593[2mms[22m[39m
[31m     ‚Üí expected 'reserved' to be 'RESERVED' // Object.is equality[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Happy Path[2m > [22mshould successfully create order with multiple items [33m 541[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Happy Path[2m > [22mshould deduplicate inventory item IDs [33m 467[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Happy Path[2m > [22mshould create pending payment order record [33m 371[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Input Validation[2m > [22mshould throw 400 for empty inventory item list [33m 351[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Input Validation[2m > [22mshould throw 400 when exceeding MAX_ITEMS_PER_ORDER [33m 414[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Inventory Validation[2m > [22mshould throw 409 when inventory items are not available [33m 380[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Inventory Validation[2m > [22mshould throw 409 when items are already reserved [33m 445[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Inventory Validation[2m > [22mshould throw 409 when partial inventory unavailable [33m 449[2mms[22m[39m
[31m   [31m√ó[31m Order Creation Integration Tests[2m > [22mcreateOrder - User Reservation Limits[2m > [22mshould throw 403 when user exceeds MAX_RESERVED_ITEMS_PER_USER[39m[33m 735[2mms[22m[39m
[31m     ‚Üí 
Invalid `prisma.pendingPaymentOrder.delete()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\services\create.integration.test.ts:408:40

  405   where: { id: order1.id },
  406   data: { status: "PENDING_PICKUP", paid_at: new Date() },
  407 });
‚Üí 408 await prisma.pendingPaymentOrder.delete(
An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Concurrent Order Protection[2m > [22mshould throw 409 when user already has pending payment order [33m 612[2mms[22m[39m
[31m   [31m√ó[31m Order Creation Integration Tests[2m > [22mcreateOrder - Concurrent Order Protection[2m > [22mshould allow creating new order after previous order is paid[39m[33m 568[2mms[22m[39m
[31m     ‚Üí 
Invalid `prisma.pendingPaymentOrder.delete()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\services\create.integration.test.ts:488:40

  485 });
  486 
  487 // Delete pending payment order record
‚Üí 488 await prisma.pendingPaymentOrder.delete(
An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Transaction Atomicity[2m > [22mshould rollback transaction if order creation fails [33m 539[2mms[22m[39m
[31m   [31m√ó[31m Order Creation Integration Tests[2m > [22mcreateOrder - Metrics[2m > [22mshould increment ordersCreated metric on success[39m[33m 478[2mms[22m[39m
[31m     ‚Üí metrics.ordersCreated.get is not a function[39m
[31m   [31m√ó[31m Order Creation Integration Tests[2m > [22mcreateOrder - Pickup Code Generation[2m > [22mshould generate unique pickup code for each order[39m[33m 580[2mms[22m[39m
[31m     ‚Üí 
Invalid `prisma.pendingPaymentOrder.delete()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\services\create.integration.test.ts:566:40

  563   where: { id: order1.id },
  564   data: { status: "PENDING_PICKUP", paid_at: new Date() },
  565 });
‚Üí 566 await prisma.pendingPaymentOrder.delete(
An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.[39m
   [33m[2m‚úì[22m[39m Order Creation Integration Tests[2m > [22mcreateOrder - Payment Expiration[2m > [22mshould set paymentExpiresAt based on ORDER_PAYMENT_TTL_MINUTES [33m 602[2mms[22m[39m
[90mstdout[2m | src/tests/services/payments.integration.test.ts[2m > [22m[2mPayments Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

{"level":50,"time":1761579932967,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","orderId":1,"storedAmount":99999,"calculatedAmount":7500,"userId":1,"msg":"CRITICAL: Amount mismatch detected for order 1. This indicates data corruption!"}
{"level":50,"time":1761579932986,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","orderId":1,"storedAmount":99999,"calculatedAmount":7500,"userId":1,"msg":"CRITICAL: Amount mismatch detected for order 1. This indicates data corruption!"}
{"level":30,"time":1761579934278,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Order 1 successfully updated to PENDING_PICKUP."],"msg":"info log"}
{"level":40,"time":1761579934691,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification with future timestamp rejected for BOOKWORM_1. Notification: 1761580054, Current: 1761579934, Tolerance: 60s"],"msg":"warn log"}
{"level":40,"time":1761579934691,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification with future timestamp rejected for BOOKWORM_1. Notification: 1761580054, Current: 1761579934, Tolerance: 60s"],"msg":"warn log"}
{"level":40,"time":1761579935099,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification timestamp validation failed for BOOKWORM_1. Age: 310s"],"msg":"warn log"}
{"level":40,"time":1761579935100,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification timestamp validation failed for BOOKWORM_1. Age: 310s"],"msg":"warn log"}
{"level":50,"time":1761579935497,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification signature validation failed for BOOKWORM_1"],"msg":"error log"}
{"level":50,"time":1761579935498,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification signature validation failed for BOOKWORM_1"],"msg":"error log"}
{"level":30,"time":1761579935899,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Order 1 successfully updated to PENDING_PICKUP."],"msg":"info log"}
{"level":30,"time":1761579935930,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification for BOOKWORM_1 already processed (status: SUCCESS). Skipping."],"msg":"info log"}
{"level":50,"time":1761579936330,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["CRITICAL: Payment succeeded for an order (1) that was not PENDING_PAYMENT (likely cancelled). Marked for refund."],"msg":"error log"}
{"level":40,"time":1761579936727,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification for unknown out_trade_no BOOKWORM_99999 received. Ignoring."],"msg":"warn log"}
 [31m‚ùØ[39m src/tests/services/payments.integration.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 6789[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mpreparePaymentIntent[2m > [22mshould successfully prepare payment intent for valid order [33m 832[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mpreparePaymentIntent[2m > [22mshould throw 403 when user does not own the order [33m 520[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mpreparePaymentIntent[2m > [22mshould throw 409 when order status is not PENDING_PAYMENT [33m 401[2mms[22m[39m
[31m   [31m√ó[31m Payments Integration Tests[2m > [22mpreparePaymentIntent[2m > [22mshould throw 500 and increment metric when amount mismatch detected[39m[33m 456[2mms[22m[39m
[31m     ‚Üí expected "inc" to be called once, but got 2 times[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mpreparePaymentIntent[2m > [22mshould throw 400 for invalid amount (negative) [33m 423[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mpreparePaymentIntent[2m > [22mshould be idempotent (calling twice creates only one payment record) [33m 431[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mprocessPaymentNotification[2m > [22mshould successfully process valid payment notification [33m 439[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mprocessPaymentNotification[2m > [22mshould reject notification with future timestamp [33m 417[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mprocessPaymentNotification[2m > [22mshould reject notification with expired timestamp [33m 395[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mprocessPaymentNotification[2m > [22mshould reject notification with invalid signature [33m 390[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mprocessPaymentNotification[2m > [22mshould be idempotent (processing same notification twice) [33m 447[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mprocessPaymentNotification[2m > [22mshould mark payment as REFUND_REQUIRED when order is cancelled [33m 398[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mprocessPaymentNotification[2m > [22mshould skip processing for unknown out_trade_no [33m 394[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mbuildWechatPaymentRequest[2m > [22mshould build valid WeChat payment request [33m 443[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payments Integration Tests[2m > [22mbuildClientPaymentSignature[2m > [22mshould generate valid client payment signature [33m 397[2mms[22m[39m
[90mstdout[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

Sourcemap for "C:/Users/wapadil/WeChatProjects/miniprogram-13/bookworm-backend/node_modules/node-cron/dist/esm/node-cron.js" points to missing source files
[90mstderr[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1761579939494,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9196","remoteAddress":"::ffff:127.0.0.1","remotePort":9197},"msg":"incoming request"}
{"level":30,"time":1761579939557,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":62.46389999985695,"msg":"request completed"}
{"level":30,"time":1761579939580,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9199","remoteAddress":"::ffff:127.0.0.1","remotePort":9200},"msg":"incoming request"}
{"level":30,"time":1761579939582,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579939595,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":14.54959999769926,"msg":"request completed"}
{"level":30,"time":1761579939864,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9201","remoteAddress":"::ffff:127.0.0.1","remotePort":9202},"msg":"incoming request"}
{"level":30,"time":1761579939893,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":29.20780000090599,"msg":"request completed"}
{"level":30,"time":1761579939900,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9203","remoteAddress":"::ffff:127.0.0.1","remotePort":9204},"msg":"incoming request"}
{"level":30,"time":1761579939901,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579939926,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":200},"responseTime":26.153599999845028,"msg":"request completed"}
{"level":30,"time":1761579940215,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9205","remoteAddress":"::ffff:127.0.0.1","remotePort":9206},"msg":"incoming request"}
{"level":30,"time":1761579940238,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":23.391100000590086,"msg":"request completed"}
{"level":30,"time":1761579940266,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9207","remoteAddress":"::ffff:127.0.0.1","remotePort":9208},"msg":"incoming request"}
{"level":30,"time":1761579940266,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579940283,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":17.403000000864267,"msg":"request completed"}
{"level":30,"time":1761579940637,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9209","remoteAddress":"::ffff:127.0.0.1","remotePort":9210},"msg":"incoming request"}
{"level":30,"time":1761579940664,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":26.56990000233054,"msg":"request completed"}
{"level":30,"time":1761579940678,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9211","remoteAddress":"::ffff:127.0.0.1","remotePort":9212},"msg":"incoming request"}
{"level":30,"time":1761579940679,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":50,"time":1761579940685,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé PENDING_PAYMENT Êõ¥Êñ∞‰∏∫ COMPLETED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé PENDING_PAYMENT Êõ¥Êñ∞‰∏∫ COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9211","remoteAddress":"::ffff:127.0.0.1","remotePort":9212},"msg":"An error occurred during the request"}
{"level":30,"time":1761579940686,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":400},"responseTime":8.103199999779463,"msg":"request completed"}
{"level":30,"time":1761579940949,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9213","remoteAddress":"::ffff:127.0.0.1","remotePort":9214},"msg":"incoming request"}
{"level":30,"time":1761579940975,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":201},"responseTime":25.795299999415874,"msg":"request completed"}
{"level":30,"time":1761579940997,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9215","remoteAddress":"::ffff:127.0.0.1","remotePort":9216},"msg":"incoming request"}
{"level":30,"time":1761579940997,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":50,"time":1761579941003,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé COMPLETED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé COMPLETED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9215","remoteAddress":"::ffff:127.0.0.1","remotePort":9216},"msg":"An error occurred during the request"}
{"level":30,"time":1761579941003,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":400},"responseTime":6.490399997681379,"msg":"request completed"}
{"level":30,"time":1761579941304,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9217","remoteAddress":"::ffff:127.0.0.1","remotePort":9218},"msg":"incoming request"}
{"level":30,"time":1761579941330,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":201},"responseTime":25.1418999992311,"msg":"request completed"}
{"level":30,"time":1761579941344,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9219","remoteAddress":"::ffff:127.0.0.1","remotePort":9220},"msg":"incoming request"}
{"level":30,"time":1761579941344,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":50,"time":1761579941349,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ COMPLETED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9219","remoteAddress":"::ffff:127.0.0.1","remotePort":9220},"msg":"An error occurred during the request"}
{"level":30,"time":1761579941349,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":400},"responseTime":5.383899997919798,"msg":"request completed"}
{"level":30,"time":1761579941642,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9221","remoteAddress":"::ffff:127.0.0.1","remotePort":9222},"msg":"incoming request"}
{"level":30,"time":1761579941668,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","res":{"statusCode":201},"responseTime":25.913600001484156,"msg":"request completed"}
{"level":30,"time":1761579941675,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9223","remoteAddress":"::ffff:127.0.0.1","remotePort":9224},"msg":"incoming request"}
{"level":30,"time":1761579941676,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","res":{"statusCode":403},"responseTime":0.6233999989926815,"msg":"request completed"}
{"level":30,"time":1761579941932,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9225","remoteAddress":"::ffff:127.0.0.1","remotePort":9226},"msg":"incoming request"}
{"level":30,"time":1761579941957,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","res":{"statusCode":201},"responseTime":24.657899998128414,"msg":"request completed"}
{"level":30,"time":1761579941963,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9227","remoteAddress":"::ffff:127.0.0.1","remotePort":9228},"msg":"incoming request"}
{"level":30,"time":1761579941964,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","res":{"statusCode":401},"responseTime":0.25849999859929085,"msg":"request completed"}
{"level":30,"time":1761579942259,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9229","remoteAddress":"::ffff:127.0.0.1","remotePort":9230},"msg":"incoming request"}
{"level":30,"time":1761579942284,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","res":{"statusCode":201},"responseTime":25.053700000047684,"msg":"request completed"}
{"level":30,"time":1761579942292,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:9231","remoteAddress":"::ffff:127.0.0.1","remotePort":9232},"msg":"incoming request"}
{"level":30,"time":1761579942293,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":50,"time":1761579942298,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:9231","remoteAddress":"::ffff:127.0.0.1","remotePort":9232},"msg":"An error occurred during the request"}
{"level":30,"time":1761579942298,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","res":{"statusCode":404},"responseTime":5.9344999976456165,"msg":"request completed"}
{"level":30,"time":1761579942575,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9233","remoteAddress":"::ffff:127.0.0.1","remotePort":9234},"msg":"incoming request"}
{"level":30,"time":1761579942598,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","res":{"statusCode":201},"responseTime":22.19530000165105,"msg":"request completed"}
{"level":30,"time":1761579942603,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:9235","remoteAddress":"::ffff:127.0.0.1","remotePort":9236},"msg":"incoming request"}
{"level":50,"time":1761579942603,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","err":{"type":"Error","message":"params/id must be number","stack":"Error: params/id must be number\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:145:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/id","schemaPath":"#/properties/id/type","keyword":"type","params":{"type":"number"},"message":"must be number"}],"validationContext":"params"},"req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:9235","remoteAddress":"::ffff:127.0.0.1","remotePort":9236},"msg":"An error occurred during the request"}
{"level":30,"time":1761579942606,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","res":{"statusCode":400},"responseTime":2.8628000020980835,"msg":"request completed"}
{"level":30,"time":1761579942900,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9237","remoteAddress":"::ffff:127.0.0.1","remotePort":9238},"msg":"incoming request"}
{"level":30,"time":1761579942924,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","res":{"statusCode":201},"responseTime":23.536900002509356,"msg":"request completed"}
{"level":30,"time":1761579942933,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9239","remoteAddress":"::ffff:127.0.0.1","remotePort":9240},"msg":"incoming request"}
{"level":50,"time":1761579942933,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","err":{"type":"Error","message":"body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf","stack":"Error: body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/0/const","keyword":"const","params":{"allowedValue":"COMPLETED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/1/const","keyword":"const","params":{"allowedValue":"CANCELLED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf","keyword":"anyOf","params":{},"message":"must match a schema in anyOf"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9239","remoteAddress":"::ffff:127.0.0.1","remotePort":9240},"msg":"An error occurred during the request"}
{"level":30,"time":1761579942934,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","res":{"statusCode":400},"responseTime":0.8187999986112118,"msg":"request completed"}
{"level":30,"time":1761579943209,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9241","remoteAddress":"::ffff:127.0.0.1","remotePort":9242},"msg":"incoming request"}
{"level":30,"time":1761579943233,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","res":{"statusCode":201},"responseTime":24.15819999948144,"msg":"request completed"}
{"level":30,"time":1761579943242,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9243","remoteAddress":"::ffff:127.0.0.1","remotePort":9244},"msg":"incoming request"}
{"level":50,"time":1761579943243,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9243","remoteAddress":"::ffff:127.0.0.1","remotePort":9244},"msg":"An error occurred during the request"}
{"level":30,"time":1761579943243,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","res":{"statusCode":400},"responseTime":0.5461000017821789,"msg":"request completed"}
{"level":30,"time":1761579943532,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9245","remoteAddress":"::ffff:127.0.0.1","remotePort":9246},"msg":"incoming request"}
{"level":30,"time":1761579943553,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","res":{"statusCode":201},"responseTime":20.571799997240305,"msg":"request completed"}
{"level":30,"time":1761579943558,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9247","remoteAddress":"::ffff:127.0.0.1","remotePort":9248},"msg":"incoming request"}
{"level":30,"time":1761579943559,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943570,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","res":{"statusCode":200},"responseTime":11.48199999704957,"msg":"request completed"}
{"level":30,"time":1761579943839,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9249","remoteAddress":"::ffff:127.0.0.1","remotePort":9250},"msg":"incoming request"}
{"level":30,"time":1761579943859,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","res":{"statusCode":201},"responseTime":19.12959999963641,"msg":"request completed"}
{"level":30,"time":1761579943868,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9252},"msg":"incoming request"}
{"level":30,"time":1761579943869,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943869,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9253},"msg":"incoming request"}
{"level":30,"time":1761579943869,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943869,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9254},"msg":"incoming request"}
{"level":30,"time":1761579943869,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943870,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9255},"msg":"incoming request"}
{"level":30,"time":1761579943870,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943870,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9256},"msg":"incoming request"}
{"level":30,"time":1761579943871,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943871,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9257},"msg":"incoming request"}
{"level":30,"time":1761579943871,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943872,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9258},"msg":"incoming request"}
{"level":30,"time":1761579943872,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943872,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9259},"msg":"incoming request"}
{"level":30,"time":1761579943873,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943873,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9260},"msg":"incoming request"}
{"level":30,"time":1761579943873,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943873,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-11","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9261},"msg":"incoming request"}
{"level":30,"time":1761579943874,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579943889,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","res":{"statusCode":200},"responseTime":20.753200002014637,"msg":"request completed"}
{"level":50,"time":1761579943894,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9255},"msg":"An error occurred during the request"}
{"level":30,"time":1761579943894,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","res":{"statusCode":400},"responseTime":24.463700000196695,"msg":"request completed"}
{"level":50,"time":1761579943894,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9256},"msg":"An error occurred during the request"}
{"level":30,"time":1761579943895,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","res":{"statusCode":400},"responseTime":24.193300001323223,"msg":"request completed"}
{"level":50,"time":1761579943896,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9257},"msg":"An error occurred during the request"}
{"level":30,"time":1761579943896,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","res":{"statusCode":400},"responseTime":24.959200002253056,"msg":"request completed"}
{"level":50,"time":1761579943904,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9258},"msg":"An error occurred during the request"}
{"level":30,"time":1761579943907,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","res":{"statusCode":400},"responseTime":35.03380000218749,"msg":"request completed"}
{"level":50,"time":1761579943907,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9259},"msg":"An error occurred during the request"}
{"level":30,"time":1761579943908,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","res":{"statusCode":400},"responseTime":35.816199999302626,"msg":"request completed"}
{"level":50,"time":1761579943914,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9260},"msg":"An error occurred during the request"}
{"level":30,"time":1761579943915,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","res":{"statusCode":400},"responseTime":42.13720000162721,"msg":"request completed"}
{"level":50,"time":1761579943917,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-11","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé CANCELLED Êõ¥Êñ∞‰∏∫ CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9251","remoteAddress":"::ffff:127.0.0.1","remotePort":9261},"msg":"An error occurred during the request"}
{"level":30,"time":1761579943918,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-11","res":{"statusCode":400},"responseTime":44.05590000003576,"msg":"request completed"}
{"level":30,"time":1761579943921,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","res":{"statusCode":200},"responseTime":52.04129999876022,"msg":"request completed"}
{"level":30,"time":1761579943933,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","res":{"statusCode":200},"responseTime":63.72030000016093,"msg":"request completed"}
 [32m‚úì[39m src/tests/order-status-management.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 6193[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould allow STAFF to complete a PENDING_PICKUP order [33m 429[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould allow STAFF to cancel a PENDING_PICKUP order [33m 333[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould allow STAFF to cancel a PENDING_PAYMENT order [33m 380[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould reject invalid status transitions [33m 369[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould reject attempts to change status of already COMPLETED orders [33m 355[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mSTAFF Order Status Updates[2m > [22mshould reject attempts to change status of already CANCELLED orders [33m 323[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mAccess Control[2m > [22mshould reject regular USER attempts to update order status [33m 316[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mAccess Control[2m > [22mshould handle non-existent order IDs [33m 329[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mAccess Control[2m > [22mshould handle invalid order IDs [33m 303[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mRequest Validation[2m > [22mshould reject invalid status values [33m 325[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mRequest Validation[2m > [22mshould reject missing status field [33m 314[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mRequest Validation[2m > [22mshould reject requests with extra fields [33m 327[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Status Management Integration Tests[2m > [22mRate Limiting[2m > [22mshould handle rapid requests gracefully when rate limiting is disabled [33m 363[2mms[22m[39m
[90mstdout[2m | src/tests/contract/api.contract.integration.test.ts[2m > [22m[2mAPI Contract Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

[90mstderr[2m | src/tests/contract/api.contract.integration.test.ts[2m > [22m[2mAPI Contract Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/contract/api.contract.integration.test.ts[2m > [22m[2mAPI Contract Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1761579944491,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/auth/login","hostname":"127.0.0.1:9267","remoteAddress":"::ffff:127.0.0.1","remotePort":9268},"msg":"incoming request"}
{"level":30,"time":1761579944503,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":4,"openid":"mock-o***","msg":"New user created"}
{"level":30,"time":1761579944507,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":200},"responseTime":15.393100000917912,"msg":"request completed"}
{"level":30,"time":1761579944787,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"GET","url":"/api/inventory/available?page=1&limit=10","hostname":"127.0.0.1:9269","remoteAddress":"::ffff:127.0.0.1","remotePort":9270},"msg":"incoming request"}
{"level":30,"time":1761579944795,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":7.908500000834465,"msg":"request completed"}
{"level":30,"time":1761579945061,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"GET","url":"/api/inventory/item/1","hostname":"127.0.0.1:9271","remoteAddress":"::ffff:127.0.0.1","remotePort":9272},"msg":"incoming request"}
{"level":30,"time":1761579945067,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":200},"responseTime":6.6266000010073185,"msg":"request completed"}
{"level":30,"time":1761579945326,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9273","remoteAddress":"::ffff:127.0.0.1","remotePort":9274},"msg":"incoming request"}
{"level":30,"time":1761579945374,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":201},"responseTime":47.88749999925494,"msg":"request completed"}
{"level":30,"time":1761579945650,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9275","remoteAddress":"::ffff:127.0.0.1","remotePort":9276},"msg":"incoming request"}
{"level":30,"time":1761579945679,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":28.439400002360344,"msg":"request completed"}
{"level":30,"time":1761579945682,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"GET","url":"/api/orders/1","hostname":"127.0.0.1:9277","remoteAddress":"::ffff:127.0.0.1","remotePort":9278},"msg":"incoming request"}
{"level":30,"time":1761579945697,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":14.376600001007318,"msg":"request completed"}
{"level":30,"time":1761579946032,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9279","remoteAddress":"::ffff:127.0.0.1","remotePort":9280},"msg":"incoming request"}
{"level":30,"time":1761579946056,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":23.357400000095367,"msg":"request completed"}
{"level":30,"time":1761579946058,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9281","remoteAddress":"::ffff:127.0.0.1","remotePort":9282},"msg":"incoming request"}
[90mstdout[2m | src/tests/contract/api.contract.integration.test.ts[2m > [22m[2mAPI Contract Tests[2m > [22m[2mOrder APIs[2m > [22m[2mGET /api/orders/my - Ëé∑ÂèñÁî®Êà∑ËÆ¢ÂçïÂàóË°®
[22m[39mprisma:error 
Invalid `tx.order.create()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\services\orders\create.ts:162:29

  159 const pickup_code = await generateUniquePickupCode();
  160 
  161 try {
‚Üí 162   return await tx.order.create(
Unique constraint failed on the fields: (`user_id`)

{"level":50,"time":1761579946075,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","err":{"type":"ApiError","message":"ÊÇ®Êúâ‰∏Ä‰∏™Ê≠£Âú®‰ªòÊ¨æÁöÑËÆ¢ÂçïÔºåËØ∑ÂÖàÂÆåÊàê‰ªòÊ¨æÊàñÁ≠âÂæÖËÆ¢ÂçïËøáÊúü","stack":"ApiError: ÊÇ®Êúâ‰∏Ä‰∏™Ê≠£Âú®‰ªòÊ¨æÁöÑËÆ¢ÂçïÔºåËØ∑ÂÖàÂÆåÊàê‰ªòÊ¨æÊàñÁ≠âÂæÖËÆ¢ÂçïËøáÊúü\n    at createOrder (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\create.ts:332:15)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:64:21)","name":"ApiError","statusCode":409,"code":"CONCURRENT_PENDING_ORDER"},"req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9281","remoteAddress":"::ffff:127.0.0.1","remotePort":9282},"msg":"An error occurred during the request"}
{"level":30,"time":1761579946076,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":409},"responseTime":18.312899999320507,"msg":"request completed"}
{"level":30,"time":1761579946078,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"GET","url":"/api/orders/my?limit=10","hostname":"127.0.0.1:9283","remoteAddress":"::ffff:127.0.0.1","remotePort":9284},"msg":"incoming request"}
{"level":30,"time":1761579946087,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":200},"responseTime":8.959300000220537,"msg":"request completed"}
{"level":30,"time":1761579946385,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"GET","url":"/api/books/recommendations","hostname":"127.0.0.1:9285","remoteAddress":"::ffff:127.0.0.1","remotePort":9286},"msg":"incoming request"}
{"level":30,"time":1761579946389,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":200},"responseTime":4.209499999880791,"msg":"request completed"}
{"level":30,"time":1761579946643,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"GET","url":"/api/books/recommendations","hostname":"127.0.0.1:9291","remoteAddress":"::ffff:127.0.0.1","remotePort":9292},"msg":"incoming request"}
{"level":30,"time":1761579946647,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":200},"responseTime":3.7587000019848347,"msg":"request completed"}
{"level":30,"time":1761579946904,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"GET","url":"/api/content/test-content-1761579946898","hostname":"127.0.0.1:9293","remoteAddress":"::ffff:127.0.0.1","remotePort":9294},"msg":"incoming request"}
{"level":30,"time":1761579946909,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":200},"responseTime":4.693399999290705,"msg":"request completed"}
{"level":30,"time":1761579947223,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","req":{"method":"GET","url":"/api/users/me","hostname":"127.0.0.1:9295","remoteAddress":"::ffff:127.0.0.1","remotePort":9296},"msg":"incoming request"}
{"level":30,"time":1761579947230,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","res":{"statusCode":200},"responseTime":7.7374000027775764,"msg":"request completed"}
{"level":30,"time":1761579947683,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:9299","remoteAddress":"::ffff:127.0.0.1","remotePort":9300},"msg":"incoming request"}
{"level":30,"time":1761579947684,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","res":{"statusCode":401},"responseTime":0.27540000155568123,"msg":"request completed"}
{"level":30,"time":1761579947977,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","req":{"method":"GET","url":"/api/orders/pending-pickup","hostname":"127.0.0.1:9301","remoteAddress":"::ffff:127.0.0.1","remotePort":9302},"msg":"incoming request"}
{"level":30,"time":1761579947978,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","res":{"statusCode":403},"responseTime":0.43449999764561653,"msg":"request completed"}
{"level":30,"time":1761579948330,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","req":{"method":"GET","url":"/api/orders/99999","hostname":"127.0.0.1:9303","remoteAddress":"::ffff:127.0.0.1","remotePort":9304},"msg":"incoming request"}
{"level":50,"time":1761579948339,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","err":{"type":"ApiError","message":"Order not found","stack":"ApiError: Order not found\n    at getOrderById (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\queries.ts:144:11)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:83:21)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"GET","url":"/api/orders/99999","hostname":"127.0.0.1:9303","remoteAddress":"::ffff:127.0.0.1","remotePort":9304},"msg":"An error occurred during the request"}
{"level":30,"time":1761579948340,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","res":{"statusCode":404},"responseTime":9.815499998629093,"msg":"request completed"}
{"level":30,"time":1761579948654,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9305","remoteAddress":"::ffff:127.0.0.1","remotePort":9306},"msg":"incoming request"}
{"level":50,"time":1761579948654,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","err":{"type":"Error","message":"body/inventoryItemIds must be array","stack":"Error: body/inventoryItemIds must be array\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/inventoryItemIds","schemaPath":"#/properties/inventoryItemIds/type","keyword":"type","params":{"type":"array"},"message":"must be array"}],"validationContext":"body"},"req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9305","remoteAddress":"::ffff:127.0.0.1","remotePort":9306},"msg":"An error occurred during the request"}
{"level":30,"time":1761579948654,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","res":{"statusCode":400},"responseTime":0.6569999977946281,"msg":"request completed"}
{"level":30,"time":1761579948914,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9307","remoteAddress":"::ffff:127.0.0.1","remotePort":9308},"msg":"incoming request"}
{"level":30,"time":1761579948936,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","res":{"statusCode":201},"responseTime":21.678800001740456,"msg":"request completed"}
{"level":30,"time":1761579948952,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9309","remoteAddress":"::ffff:127.0.0.1","remotePort":9310},"msg":"incoming request"}
[90mstdout[2m | src/tests/contract/api.contract.integration.test.ts[2m > [22m[2mAPI Contract Tests[2m > [22m[2mError Response Contracts[2m > [22m[2m409 Conflict - ‰∏öÂä°ÂÜ≤Á™Å
[22m[39mprisma:error 
Invalid `tx.order.create()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\services\orders\create.ts:162:29

  159 const pickup_code = await generateUniquePickupCode();
  160 
  161 try {
‚Üí 162   return await tx.order.create(
Unique constraint failed on the fields: (`user_id`)

{"level":50,"time":1761579948965,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","err":{"type":"ApiError","message":"ÊÇ®Êúâ‰∏Ä‰∏™Ê≠£Âú®‰ªòÊ¨æÁöÑËÆ¢ÂçïÔºåËØ∑ÂÖàÂÆåÊàê‰ªòÊ¨æÊàñÁ≠âÂæÖËÆ¢ÂçïËøáÊúü","stack":"ApiError: ÊÇ®Êúâ‰∏Ä‰∏™Ê≠£Âú®‰ªòÊ¨æÁöÑËÆ¢ÂçïÔºåËØ∑ÂÖàÂÆåÊàê‰ªòÊ¨æÊàñÁ≠âÂæÖËÆ¢ÂçïËøáÊúü\n    at createOrder (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\create.ts:332:15)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:64:21)","name":"ApiError","statusCode":409,"code":"CONCURRENT_PENDING_ORDER"},"req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9309","remoteAddress":"::ffff:127.0.0.1","remotePort":9310},"msg":"An error occurred during the request"}
{"level":30,"time":1761579948966,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","res":{"statusCode":409},"responseTime":13.715799998492002,"msg":"request completed"}
 [32m‚úì[39m src/tests/contract/api.contract.integration.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 5001[2mms[22m[39m
   [33m[2m‚úì[22m[39m API Contract Tests[2m > [22mAuthentication APIs[2m > [22mPOST /api/auth/login - ÁôªÂΩïÊàêÂäüËøîÂõûtokenÂíåuserId [33m 313[2mms[22m[39m
   [33m[2m‚úì[22m[39m API Contract Tests[2m > [22mOrder APIs[2m > [22mPOST /api/orders/create - ÂàõÂª∫ËÆ¢Âçï [33m 319[2mms[22m[39m
   [33m[2m‚úì[22m[39m API Contract Tests[2m > [22mOrder APIs[2m > [22mGET /api/orders/:id - Ëé∑ÂèñËÆ¢ÂçïËØ¶ÊÉÖ [33m 358[2mms[22m[39m
   [33m[2m‚úì[22m[39m API Contract Tests[2m > [22mOrder APIs[2m > [22mGET /api/orders/my - Ëé∑ÂèñÁî®Êà∑ËÆ¢ÂçïÂàóË°® [33m 358[2mms[22m[39m
   [33m[2m‚úì[22m[39m API Contract Tests[2m > [22mUser APIs[2m > [22mGET /api/users/me - Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ [33m 316[2mms[22m[39m
   [33m[2m‚úì[22m[39m API Contract Tests[2m > [22mError Response Contracts[2m > [22m401 Unauthorized - Áº∫Â∞ëËÆ§ËØÅ‰ª§Áâå [33m 435[2mms[22m[39m
   [33m[2m‚úì[22m[39m API Contract Tests[2m > [22mError Response Contracts[2m > [22m404 Not Found - ËµÑÊ∫ê‰∏çÂ≠òÂú® [33m 408[2mms[22m[39m
   [33m[2m‚úì[22m[39m API Contract Tests[2m > [22mError Response Contracts[2m > [22m409 Conflict - ‰∏öÂä°ÂÜ≤Á™Å [33m 327[2mms[22m[39m
[90mstdout[2m | src/tests/concurrent-order-control.integration.test.ts[2m > [22m[2mConcurrent Order Control Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

 [32m‚úì[39m src/tests/concurrent-order-control.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 6176[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÔºöÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïËßÑÂàô[2m > [22mÂ∫îËØ•Èò≤Ê≠¢Âêå‰∏ÄÁî®Êà∑ÂàõÂª∫Â§ö‰∏™PENDING_PAYMENTËÆ¢Âçï [33m 387[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÔºöÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïËßÑÂàô[2m > [22mÂ∫îËØ•ÂÖÅËÆ∏‰∏çÂêåÁî®Êà∑ÂêåÊó∂ÂàõÂª∫PENDING_PAYMENTËÆ¢Âçï [33m 352[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÔºöÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïËßÑÂàô[2m > [22mÂπ∂ÂèëÁ´û‰∫âÂêå‰∏ÄÂ∫ìÂ≠òÊó∂Â∫î‰ªÖ‰∏ÄÁ¨îÊàêÂäü [33m 407[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÂ±ÇÈù¢ÔºöÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïËßÑÂàô[2m > [22mÁî®Êà∑ËÆ¢ÂçïÁä∂ÊÄÅÂèòÂåñÂêéÂ∫îËØ•ËÉΩÂàõÂª∫Êñ∞ËÆ¢Âçï [33m 418[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•Èò≤Ê≠¢Áî®Êà∑È¢ÑÁïôË∂ÖËøá‰∏äÈôêÁöÑÂïÜÂìÅÊÄªÊï∞ [33m 311[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•ÈÄöËøáÈÉ®ÂàÜÂîØ‰∏ÄÁ¥¢ÂºïÈò≤Ê≠¢Áî®Êà∑ÂàõÂª∫Â§ö‰∏™pendingËÆ¢Âçï [33m 353[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•ÈÄöËøáÊ®°ÊãüÊï∞ÊçÆÊµãËØïMAX_RESERVED_ITEMS_PER_USERÈÄªËæë [33m 393[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•ÂÖÅËÆ∏Âú®ÂçïÁ¨îËÆ¢Âçï‰∏äÈôêÂÜÖÂàõÂª∫ËÆ¢Âçï [33m 613[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂ∫îÁî®Â±ÇÈù¢ÔºöÊÄªÂ∫ìÂ≠ò‰∏äÈôêÊ£ÄÊü•[2m > [22mÂ∫îËØ•ÂÖÅËÆ∏Âú®ÊÄªÈ¢ÑÁïô‰∏äÈôêÂÜÖÂàõÂª∫Â§ö‰∏™ËÆ¢Âçï [33m 605[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÂèåÈáç‰øùÊä§Êú∫Âà∂ÂçèÂêåÂ∑•‰Ωú[2m > [22m‰∏§‰∏™ËßÑÂàôÂ∫îËØ•Áã¨Á´ãÂ∑•‰ΩúÔºå‰∏ç‰∫íÁõ∏Âπ≤Êâ∞ [33m 619[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mÊï∞ÊçÆÂ∫ìÈò≤Á∫ø[2m > [22mË∂ÖÂá∫Êï∞ÊçÆÂ∫ìÈ¢ÑÁïô‰∏äÈôêÊó∂Â∫îÁõ¥Êé•ÊãíÁªù [33m 683[2mms[22m[39m
   [33m[2m‚úì[22m[39m Concurrent Order Control Integration Tests[2m > [22mËæπÁïåÊÉÖÂÜµÊµãËØï[2m > [22mÂ∫îËØ•Ê≠£Á°ÆÂ§ÑÁêÜÁ©∫ÂïÜÂìÅÂàóË°® [33m 510[2mms[22m[39m
[90mstdout[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

[90mstderr[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1761579955872,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:9318","remoteAddress":"::ffff:127.0.0.1","remotePort":9319},"msg":"incoming request"}
{"level":30,"time":1761579955873,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":401},"responseTime":0.5685999989509583,"msg":"request completed"}
{"level":30,"time":1761579956146,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:9320","remoteAddress":"::ffff:127.0.0.1","remotePort":9321},"msg":"incoming request"}
{"level":40,"time":1761579956147,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","err":{"type":"TokenError","message":"The token is malformed.","stack":"Error: The token is malformed.\n    at decode (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fast-jwt\\src\\decoder.js:18:11)\n    at verify (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fast-jwt\\src\\verifier.js:285:15)\n    at Object.authenticate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\plugins\\auth.ts:16:29)\n    at hookIterator (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:405:10)\n    at next (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:239:18)\n    at hookRunner (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:261:5)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:116:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at handleRequest (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:24:5)","code":"FAST_JWT_MALFORMED"},"msg":"Authentication failed"}
{"level":30,"time":1761579956149,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":401},"responseTime":2.247299998998642,"msg":"request completed"}
{"level":30,"time":1761579956393,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"GET","url":"/api/orders/pending-pickup","hostname":"127.0.0.1:9322","remoteAddress":"::ffff:127.0.0.1","remotePort":9323},"msg":"incoming request"}
{"level":30,"time":1761579956394,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":403},"responseTime":0.4714999981224537,"msg":"request completed"}
{"level":30,"time":1761579956621,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9332","remoteAddress":"::ffff:127.0.0.1","remotePort":9333},"msg":"incoming request"}
{"level":50,"time":1761579956622,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"Error","message":"body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf","stack":"Error: body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/0/const","keyword":"const","params":{"allowedValue":"COMPLETED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/1/const","keyword":"const","params":{"allowedValue":"CANCELLED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf","keyword":"anyOf","params":{},"message":"must match a schema in anyOf"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9332","remoteAddress":"::ffff:127.0.0.1","remotePort":9333},"msg":"An error occurred during the request"}
{"level":30,"time":1761579956623,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":400},"responseTime":1.4158999994397163,"msg":"request completed"}
{"level":30,"time":1761579956864,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9334","remoteAddress":"::ffff:127.0.0.1","remotePort":9335},"msg":"incoming request"}
{"level":50,"time":1761579956865,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9334","remoteAddress":"::ffff:127.0.0.1","remotePort":9335},"msg":"An error occurred during the request"}
{"level":30,"time":1761579956865,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":400},"responseTime":0.9835999980568886,"msg":"request completed"}
{"level":30,"time":1761579957114,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9336","remoteAddress":"::ffff:127.0.0.1","remotePort":9337},"msg":"incoming request"}
{"level":50,"time":1761579957115,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","err":{"type":"SyntaxError","message":"Unexpected token 'i', \"invalid-json{\" is not valid JSON","stack":"SyntaxError: Unexpected token 'i', \"invalid-json{\" is not valid JSON","statusCode":400},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9336","remoteAddress":"::ffff:127.0.0.1","remotePort":9337},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957115,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":400},"responseTime":0.42659999802708626,"msg":"request completed"}
{"level":30,"time":1761579957361,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"GET","url":"/api/inventory/available?search=a","hostname":"127.0.0.1:9338","remoteAddress":"::ffff:127.0.0.1","remotePort":9339},"msg":"incoming request"}
{"level":30,"time":1761579957369,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":7.573300000280142,"msg":"request completed"}
{"level":30,"time":1761579957608,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9341},"msg":"incoming request"}
{"level":30,"time":1761579957608,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957608,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9342},"msg":"incoming request"}
{"level":30,"time":1761579957609,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957609,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9343},"msg":"incoming request"}
{"level":30,"time":1761579957609,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957609,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9352},"msg":"incoming request"}
{"level":30,"time":1761579957609,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957610,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9353},"msg":"incoming request"}
{"level":30,"time":1761579957610,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957610,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9354},"msg":"incoming request"}
{"level":30,"time":1761579957610,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957610,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9355},"msg":"incoming request"}
{"level":30,"time":1761579957610,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957611,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9344},"msg":"incoming request"}
{"level":30,"time":1761579957611,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957611,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9345},"msg":"incoming request"}
{"level":30,"time":1761579957611,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957611,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9346},"msg":"incoming request"}
{"level":30,"time":1761579957612,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957612,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9347},"msg":"incoming request"}
{"level":30,"time":1761579957612,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957612,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9348},"msg":"incoming request"}
{"level":30,"time":1761579957612,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957612,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9349},"msg":"incoming request"}
{"level":30,"time":1761579957612,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957613,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9350},"msg":"incoming request"}
{"level":30,"time":1761579957613,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579957613,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9351},"msg":"incoming request"}
{"level":30,"time":1761579957613,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":50,"time":1761579957619,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9353},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957620,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":404},"responseTime":10.340199999511242,"msg":"request completed"}
{"level":50,"time":1761579957620,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9343},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957620,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":404},"responseTime":11.55570000037551,"msg":"request completed"}
{"level":50,"time":1761579957620,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9341},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957621,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":404},"responseTime":12.994199998676777,"msg":"request completed"}
{"level":50,"time":1761579957621,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9352},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957621,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":404},"responseTime":12.028500001877546,"msg":"request completed"}
{"level":50,"time":1761579957621,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9342},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957622,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":404},"responseTime":13.16330000013113,"msg":"request completed"}
{"level":50,"time":1761579957627,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9354},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957628,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","res":{"statusCode":404},"responseTime":17.69979999959469,"msg":"request completed"}
{"level":50,"time":1761579957628,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9355},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957628,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","res":{"statusCode":404},"responseTime":18.31020000204444,"msg":"request completed"}
{"level":50,"time":1761579957629,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9345},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957630,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","res":{"statusCode":404},"responseTime":18.796900000423193,"msg":"request completed"}
{"level":50,"time":1761579957630,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9346},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957630,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","res":{"statusCode":404},"responseTime":18.702599998563528,"msg":"request completed"}
{"level":50,"time":1761579957630,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9344},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957631,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","res":{"statusCode":404},"responseTime":19.856800001114607,"msg":"request completed"}
{"level":50,"time":1761579957635,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9350},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957636,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","res":{"statusCode":404},"responseTime":23.125700000673532,"msg":"request completed"}
{"level":50,"time":1761579957636,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9349},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957636,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","res":{"statusCode":404},"responseTime":23.9358000010252,"msg":"request completed"}
{"level":50,"time":1761579957636,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9348},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957637,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","res":{"statusCode":404},"responseTime":24.549300000071526,"msg":"request completed"}
{"level":50,"time":1761579957637,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9347},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957637,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","res":{"statusCode":404},"responseTime":25.14140000194311,"msg":"request completed"}
{"level":50,"time":1761579957637,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9340","remoteAddress":"::ffff:127.0.0.1","remotePort":9351},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957637,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","res":{"statusCode":404},"responseTime":24.264199998229742,"msg":"request completed"}
{"level":30,"time":1761579957978,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:9356","remoteAddress":"::ffff:127.0.0.1","remotePort":9357},"msg":"incoming request"}
{"level":30,"time":1761579957978,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":50,"time":1761579957982,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:9356","remoteAddress":"::ffff:127.0.0.1","remotePort":9357},"msg":"An error occurred during the request"}
{"level":30,"time":1761579957982,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","res":{"statusCode":404},"responseTime":4.332100000232458,"msg":"request completed"}
{"level":30,"time":1761579958239,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:9358","remoteAddress":"::ffff:127.0.0.1","remotePort":9359},"msg":"incoming request"}
{"level":50,"time":1761579958239,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","err":{"type":"Error","message":"params/id must be number","stack":"Error: params/id must be number\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:145:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/id","schemaPath":"#/properties/id/type","keyword":"type","params":{"type":"number"},"message":"must be number"}],"validationContext":"params"},"req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:9358","remoteAddress":"::ffff:127.0.0.1","remotePort":9359},"msg":"An error occurred during the request"}
{"level":30,"time":1761579958239,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","res":{"statusCode":400},"responseTime":0.6676000021398067,"msg":"request completed"}
{"level":30,"time":1761579958486,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:9360","remoteAddress":"::ffff:127.0.0.1","remotePort":9361},"msg":"incoming request"}
{"level":30,"time":1761579958510,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","res":{"statusCode":201},"responseTime":23.752700001001358,"msg":"request completed"}
{"level":30,"time":1761579958512,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9362","remoteAddress":"::ffff:127.0.0.1","remotePort":9363},"msg":"incoming request"}
{"level":30,"time":1761579958512,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":50,"time":1761579958516,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","err":{"type":"ApiError","message":"Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé PENDING_PAYMENT Êõ¥Êñ∞‰∏∫ COMPLETED","stack":"ApiError: Êó†Ê≥ïÂ∞ÜËÆ¢Âçï‰ªé PENDING_PAYMENT Êõ¥Êñ∞‰∏∫ COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:75:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/1/status","hostname":"127.0.0.1:9362","remoteAddress":"::ffff:127.0.0.1","remotePort":9363},"msg":"An error occurred during the request"}
{"level":30,"time":1761579958517,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","res":{"statusCode":400},"responseTime":4.69029999896884,"msg":"request completed"}
{"level":30,"time":1761579958753,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","req":{"method":"GET","url":"/api/inventory/item/99999","hostname":"127.0.0.1:9364","remoteAddress":"::ffff:127.0.0.1","remotePort":9365},"msg":"incoming request"}
{"level":50,"time":1761579958757,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","err":{"type":"ApiError","message":"Book not found.","stack":"ApiError: Book not found.\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\inventory.ts:76:15)","name":"ApiError","statusCode":404,"code":"BOOK_NOT_FOUND"},"req":{"method":"GET","url":"/api/inventory/item/99999","hostname":"127.0.0.1:9364","remoteAddress":"::ffff:127.0.0.1","remotePort":9365},"msg":"An error occurred during the request"}
{"level":30,"time":1761579958758,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","res":{"statusCode":404},"responseTime":4.323100000619888,"msg":"request completed"}
{"level":30,"time":1761579959009,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:9366","remoteAddress":"::ffff:127.0.0.1","remotePort":9367},"msg":"incoming request"}
{"level":30,"time":1761579959009,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","res":{"statusCode":401},"responseTime":0.2176000028848648,"msg":"request completed"}
{"level":30,"time":1761579959012,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","req":{"method":"GET","url":"/api/orders/pending-pickup","hostname":"127.0.0.1:9368","remoteAddress":"::ffff:127.0.0.1","remotePort":9369},"msg":"incoming request"}
{"level":30,"time":1761579959012,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","res":{"statusCode":403},"responseTime":0.27969999983906746,"msg":"request completed"}
{"level":30,"time":1761579959014,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9370","remoteAddress":"::ffff:127.0.0.1","remotePort":9371},"msg":"incoming request"}
{"level":50,"time":1761579959015,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:9370","remoteAddress":"::ffff:127.0.0.1","remotePort":9371},"msg":"An error occurred during the request"}
{"level":30,"time":1761579959015,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","res":{"statusCode":400},"responseTime":0.41760000213980675,"msg":"request completed"}
{"level":30,"time":1761579959017,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:9372","remoteAddress":"::ffff:127.0.0.1","remotePort":9373},"msg":"incoming request"}
{"level":30,"time":1761579959017,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":2,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":50,"time":1761579959023,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","err":{"type":"ApiError","message":"ËÆ¢Âçï‰∏çÂ≠òÂú®","stack":"ApiError: ËÆ¢Âçï‰∏çÂ≠òÂú®\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\management.ts:62:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:169:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:9372","remoteAddress":"::ffff:127.0.0.1","remotePort":9373},"msg":"An error occurred during the request"}
{"level":30,"time":1761579959023,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","res":{"statusCode":404},"responseTime":5.761199999600649,"msg":"request completed"}
{"level":30,"time":1761579959277,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","req":{"method":"GET","url":"/api/health","hostname":"127.0.0.1:9374","remoteAddress":"::ffff:127.0.0.1","remotePort":9375},"msg":"incoming request"}
{"level":30,"time":1761579959280,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","res":{"statusCode":200},"responseTime":2.4712000004947186,"msg":"request completed"}
 [32m‚úì[39m src/tests/error-handling.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3944[2mms[22m[39m
   [33m[2m‚úì[22m[39m Error Handling Integration Tests[2m > [22mLayer 1: Authentication/Authorization Errors (401/403)[2m > [22mshould return 401 with correct format for missing token [33m 348[2mms[22m[39m
   [33m[2m‚úì[22m[39m Error Handling Integration Tests[2m > [22mLayer 4: Business Logic Errors (ApiError)[2m > [22mshould return correct format for business logic error [33m 358[2mms[22m[39m
[90mstdout[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

{"level":30,"time":1761579959633,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","msg":"WeChat Pay SDK initialized successfully"}
[90mstderr[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1761579959804,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9377","remoteAddress":"::ffff:127.0.0.1","remotePort":9378},"msg":"incoming request"}
{"level":40,"time":1761579959820,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at decryptPaymentNotification (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\middleware\\paymentSecurity.ts:159:35)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\middleware\\paymentSecurity.ts:215:11)\n    at hookIterator (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:405:10)\n    at next (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:239:18)\n    at handleResolve (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:250:7)"},"resource":{"algorithm":"AEAD_AES_256_GCM","ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely malformed/malicious request."}
{"level":30,"time":1761579959821,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":200},"responseTime":16.976600002497435,"msg":"request completed"}
{"level":30,"time":1761579960083,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9379","remoteAddress":"::ffff:127.0.0.1","remotePort":9380},"msg":"incoming request"}
{"level":40,"time":1761579960086,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at decryptPaymentNotification (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\middleware\\paymentSecurity.ts:159:35)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\middleware\\paymentSecurity.ts:215:11)\n    at hookIterator (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:405:10)\n    at next (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:239:18)\n    at handleResolve (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:250:7)"},"resource":{"algorithm":"AEAD_AES_256_GCM","ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely malformed/malicious request."}
{"level":30,"time":1761579960086,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":3.796500001102686,"msg":"request completed"}
{"level":30,"time":1761579960407,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9381","remoteAddress":"::ffff:127.0.0.1","remotePort":9382},"msg":"incoming request"}
{"level":40,"time":1761579960411,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at decryptPaymentNotification (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\middleware\\paymentSecurity.ts:159:35)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\middleware\\paymentSecurity.ts:215:11)\n    at hookIterator (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:405:10)\n    at next (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:239:18)\n    at handleResolve (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:250:7)"},"resource":{"algorithm":"AEAD_AES_256_GCM","ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely malformed/malicious request."}
{"level":30,"time":1761579960412,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":200},"responseTime":5.034699998795986,"msg":"request completed"}
{"level":30,"time":1761579960659,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9383","remoteAddress":"::ffff:127.0.0.1","remotePort":9384},"msg":"incoming request"}
{"level":50,"time":1761579960661,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"FastifyError","message":"Body cannot be empty when content-type is set to 'application/json'","stack":"FastifyError: Body cannot be empty when content-type is set to 'application/json'\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:295:19)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)\n    at IncomingMessage.emit (node:events:530:35)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)","code":"FST_ERR_CTP_EMPTY_JSON_BODY","name":"FastifyError","statusCode":400},"req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9383","remoteAddress":"::ffff:127.0.0.1","remotePort":9384},"msg":"An error occurred during the request"}
{"level":30,"time":1761579960662,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":400},"responseTime":2.3471000008285046,"msg":"request completed"}
{"level":30,"time":1761579960929,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9385","remoteAddress":"::ffff:127.0.0.1","remotePort":9386},"msg":"incoming request"}
{"level":40,"time":1761579960940,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification for unknown out_trade_no UNKNOWN_PAYMENT received. Ignoring."],"msg":"warn log"}
{"level":30,"time":1761579960944,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":200},"responseTime":15.384299997240305,"msg":"request completed"}
{"level":30,"time":1761579961191,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9387","remoteAddress":"::ffff:127.0.0.1","remotePort":9388},"msg":"incoming request"}
{"level":40,"time":1761579961199,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification for unknown out_trade_no TEST_ORDER_12345 received. Ignoring."],"msg":"warn log"}
{"level":30,"time":1761579961205,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":13.919199999421835,"msg":"request completed"}
{"level":30,"time":1761579961518,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9389","remoteAddress":"::ffff:127.0.0.1","remotePort":9390},"msg":"incoming request"}
{"level":40,"time":1761579961526,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification for unknown out_trade_no TEST_ORDER_12345 received. Ignoring."],"msg":"warn log"}
{"level":30,"time":1761579961531,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":12.683699999004602,"msg":"request completed"}
{"level":30,"time":1761579961800,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9399","remoteAddress":"::ffff:127.0.0.1","remotePort":9400},"msg":"incoming request"}
{"level":30,"time":1761579961815,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Order 1 successfully updated to PENDING_PICKUP."],"msg":"info log"}
{"level":30,"time":1761579961820,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":19.38350000232458,"msg":"request completed"}
{"level":30,"time":1761579962124,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9401","remoteAddress":"::ffff:127.0.0.1","remotePort":9402},"msg":"incoming request"}
{"level":40,"time":1761579962136,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment for TEST_FAIL_1761579962106 is in a final failure state (CLOSED). Marked as FAILED."],"msg":"warn log"}
{"level":30,"time":1761579962139,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":200},"responseTime":14.950200002640486,"msg":"request completed"}
{"level":30,"time":1761579962425,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9403","remoteAddress":"::ffff:127.0.0.1","remotePort":9404},"msg":"incoming request"}
{"level":40,"time":1761579962436,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment for TEST_PAYERROR_1761579962410 is in a final failure state (PAYERROR). Marked as FAILED."],"msg":"warn log"}
{"level":30,"time":1761579962441,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":200},"responseTime":15.028799999505281,"msg":"request completed"}
{"level":30,"time":1761579962690,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9405","remoteAddress":"::ffff:127.0.0.1","remotePort":9406},"msg":"incoming request"}
{"level":40,"time":1761579962697,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Payment notification for unknown out_trade_no NONEXISTENT_ORDER_99999 received. Ignoring."],"msg":"warn log"}
{"level":30,"time":1761579962700,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":200},"responseTime":9.388199999928474,"msg":"request completed"}
{"level":30,"time":1761579962935,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:9408","remoteAddress":"::ffff:127.0.0.1","remotePort":9410},"msg":"incoming request"}
{"level":40,"time":1761579962938,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"SyntaxError","message":"Unexpected token 'i', \"invalid-json{\" is not valid JSON","stack":"SyntaxError: Unexpected token 'i', \"invalid-json{\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at decryptPaymentNotification (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\middleware\\paymentSecurity.ts:159:35)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\middleware\\paymentSecurity.ts:215:11)\n    at hookIterator (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:405:10)\n    at next (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:239:18)\n    at handleResolve (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:250:7)"},"resource":{"algorithm":"AEAD_AES_256_GCM","ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely malformed/malicious request."}
{"level":30,"time":1761579962938,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":200},"responseTime":3.4217000007629395,"msg":"request completed"}
{"level":50,"time":1761579963235,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","orderId":1,"storedAmount":99999,"calculatedAmount":5000,"userId":1,"msg":"CRITICAL: Amount mismatch detected for order 1. This indicates data corruption!"}
 [32m‚úì[39m src/tests/paymentSecurity.integration.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3781[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22mshould handle successful payment notification [33m 313[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22mshould persist payment success and transition order status [33m 324[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mPayment Business Logic - ÁúüÊ≠£ÁöÑÊàêÂäüÂíåÂ§±Ë¥•Âú∫ÊôØ[2m > [22mshould mark payment record as FAILED when gateway reports final failure [33m 323[2mms[22m[39m
   [33m[2m‚úì[22m[39m Payment Security Integration Tests[2m > [22mAmount Mismatch Alert Mechanism[2m > [22mshould trigger an amount mismatch alert if order total is inconsistent [33m 308[2mms[22m[39m
[90mstdout[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

[90mstderr[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1761579963736,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579963738,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579963757,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":21.047600001096725,"msg":"request completed"}
{"level":30,"time":1761579963987,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579963988,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579964002,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":201},"responseTime":15.060500003397465,"msg":"request completed"}
{"level":30,"time":1761579964003,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579964003,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579964014,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":11.250999998301268,"msg":"request completed"}
{"level":30,"time":1761579964280,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579964280,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579964288,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":201},"responseTime":7.965500000864267,"msg":"request completed"}
{"level":30,"time":1761579964503,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579964504,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":403},"responseTime":0.4644000008702278,"msg":"request completed"}
{"level":30,"time":1761579964770,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579964783,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":12.319000001996756,"msg":"request completed"}
{"level":30,"time":1761579965019,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579965026,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":7.7005999982357025,"msg":"request completed"}
{"level":30,"time":1761579965251,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579965254,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":2.818300001323223,"msg":"request completed"}
{"level":30,"time":1761579965490,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579965494,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":200},"responseTime":4.232900001108646,"msg":"request completed"}
{"level":30,"time":1761579965710,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579965710,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":401},"responseTime":0.2881000004708767,"msg":"request completed"}
 [32m‚úì[39m src/tests/profile-and-recommendations.integration.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 2432[2mms[22m[39m
   [33m[2m‚úì[22m[39m User Profile & Recommendations Integration Tests[2m > [22mPOST /api/acquisitions - Customer Profile Collection[2m > [22mÂ∫îËØ•Âú®Êî∂Ë¥≠Êó∂ÂàõÂª∫Áî®Êà∑ÁîªÂÉè [33m 309[2mms[22m[39m
[90mstdout[2m | src/tests/inventoryService.integration.test.ts[2m > [22m[2mInventory Service Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

 [32m‚úì[39m src/tests/inventoryService.integration.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2206[2mms[22m[39m
   [33m[2m‚úì[22m[39m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould handle search terms with multiple special characters [33m 310[2mms[22m[39m
[90mstdout[2m | src/tests/user-merge.integration.test.ts[2m > [22m[2mUser Account Merge
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

{"level":30,"time":1761579968309,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"openid":"wx_rea***","msg":"PRE_REGISTERED user upgraded to REGISTERED"}
{"level":30,"time":1761579968531,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"openid":"wx_new***","msg":"New user created"}
{"level":30,"time":1761579968985,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"openid":"wx_no_***","msg":"New user created"}
{"level":30,"time":1761579969222,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"openid":"wx_ope***","msg":"PRE_REGISTERED user upgraded to REGISTERED"}
{"level":30,"time":1761579969477,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","preRegisteredUserId":2,"registeredUserId":1,"phone":"135****5555","msg":"Merge conflict detected: transferring data from PRE_REGISTERED to REGISTERED user"}
{"level":30,"time":1761579969477,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","fromUserId":2,"toUserId":1,"strategiesCount":4,"msg":"Starting user data migration"}
{"level":20,"time":1761579969481,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"orders","count":0,"msg":"Orders migrated"}
{"level":20,"time":1761579969483,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"pending_payment_orders","count":0,"msg":"Pending payment orders migrated"}
{"level":20,"time":1761579969485,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"acquisitions","count":1,"msg":"Acquisitions migrated"}
{"level":20,"time":1761579969490,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"user_profile","action":"no_migration_needed","msg":"Profile migration skipped"}
{"level":30,"time":1761579969490,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","fromUserId":2,"toUserId":1,"msg":"User data migration completed"}
{"level":20,"time":1761579969493,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","deletedUserId":2,"msg":"PRE_REGISTERED user deleted"}
{"level":20,"time":1761579969495,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"msg":"Phone number updated on REGISTERED user"}
{"level":30,"time":1761579969497,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","preRegisteredUserId":2,"registeredUserId":1,"msg":"Merge complete: data transferred and placeholder deleted"}
{"level":30,"time":1761579969757,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","preRegisteredUserId":2,"registeredUserId":1,"phone":"133****3333","msg":"Merge conflict detected: transferring data from PRE_REGISTERED to REGISTERED user"}
{"level":30,"time":1761579969757,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","fromUserId":2,"toUserId":1,"strategiesCount":4,"msg":"Starting user data migration"}
{"level":20,"time":1761579969758,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"orders","count":1,"msg":"Orders migrated"}
{"level":20,"time":1761579969759,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"pending_payment_orders","count":1,"msg":"Pending payment orders migrated"}
{"level":20,"time":1761579969760,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"acquisitions","count":1,"msg":"Acquisitions migrated"}
{"level":20,"time":1761579969765,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"user_profile","action":"transferred","msg":"Profile migrated"}
{"level":30,"time":1761579969765,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","fromUserId":2,"toUserId":1,"msg":"User data migration completed"}
{"level":20,"time":1761579969767,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","deletedUserId":2,"msg":"PRE_REGISTERED user deleted"}
{"level":20,"time":1761579969768,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"msg":"Phone number updated on REGISTERED user"}
{"level":30,"time":1761579969770,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","preRegisteredUserId":2,"registeredUserId":1,"msg":"Merge complete: data transferred and placeholder deleted"}
{"level":30,"time":1761579970021,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","preRegisteredUserId":2,"registeredUserId":1,"phone":"134****4444","msg":"Merge conflict detected: transferring data from PRE_REGISTERED to REGISTERED user"}
{"level":30,"time":1761579970021,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","fromUserId":2,"toUserId":1,"strategiesCount":4,"msg":"Starting user data migration"}
{"level":20,"time":1761579970023,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"orders","count":0,"msg":"Orders migrated"}
{"level":20,"time":1761579970024,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"pending_payment_orders","count":0,"msg":"Pending payment orders migrated"}
{"level":20,"time":1761579970026,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"acquisitions","count":0,"msg":"Acquisitions migrated"}
{"level":20,"time":1761579970030,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","strategy":"user_profile","action":"no_migration_needed","msg":"Profile migration skipped"}
{"level":30,"time":1761579970030,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","fromUserId":2,"toUserId":1,"msg":"User data migration completed"}
{"level":20,"time":1761579970032,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","deletedUserId":2,"msg":"PRE_REGISTERED user deleted"}
{"level":30,"time":1761579970034,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","preRegisteredUserId":2,"registeredUserId":1,"msg":"Merge complete: data transferred and placeholder deleted"}
 [32m‚úì[39m src/tests/user-merge.integration.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2006[2mms[22m[39m
[90mstdout[2m | src/tests/databaseRules.integration.test.ts[2m > [22m[2mDatabase-level Business Rules
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

 [31m‚ùØ[39m src/tests/databaseRules.integration.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1783[2mms[22m[39m
[31m   [31m√ó[31m Database-level Business Rules[2m > [22mwithTxRetry[2m > [22mretries deterministically on serialization conflicts[39m[33m 331[2mms[22m[39m
[31m     ‚Üí expected 'rejected' to be 'fulfilled' // Object.is equality[39m
   [32m‚úì[39m Database-level Business Rules[2m > [22mwithTxRetry[2m > [22mdoes not retry for non-retryable errors[32m 227[2mms[22m[39m
   [32m‚úì[39m Database-level Business Rules[2m > [22mshould enforce MAX_RESERVED_ITEMS_PER_USER via trigger using custom setting[32m 286[2mms[22m[39m
   [32m‚úì[39m Database-level Business Rules[2m > [22mOrder type consistency check[2m > [22mshould reject a PURCHASE order carrying SELL-specific columns[32m 224[2mms[22m[39m
   [32m‚úì[39m Database-level Business Rules[2m > [22mOrder type consistency check[2m > [22mshould accept a valid SELL order (without legacy fields)[32m 235[2mms[22m[39m
   [32m‚úì[39m Database-level Business Rules[2m > [22mSource order type trigger[2m > [22mshould reject an inventory item referencing a PURCHASE order[32m 240[2mms[22m[39m
   [32m‚úì[39m Database-level Business Rules[2m > [22mSource order type trigger[2m > [22mshould allow an inventory item referencing a SELL order[32m 237[2mms[22m[39m
[90mstdout[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

[90mstderr[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1761579972346,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579972370,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":23.779100000858307,"msg":"request completed"}
{"level":30,"time":1761579972584,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":50,"time":1761579972593,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","err":{"type":"ApiError","message":"ÈÉ®ÂàÜ‰π¶Á±çÂ∑≤‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞ÂêéÈáçËØï","stack":"ApiError: ÈÉ®ÂàÜ‰π¶Á±çÂ∑≤‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞ÂêéÈáçËØï\n    at validateInventoryAndReservations (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\create.ts:129:11)\n    at createOrderImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\create.ts:272:5)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at withTxRetry (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\db\\transaction.ts:78:14)\n    at createOrder (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\create.ts:314:14)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:64:21)","name":"ApiError","statusCode":409,"code":"INSUFFICIENT_INVENTORY_PRECHECK"},"req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"An error occurred during the request"}
{"level":30,"time":1761579972593,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":409},"responseTime":9.172800000756979,"msg":"request completed"}
{"level":30,"time":1761579972831,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579972850,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":19.08439999818802,"msg":"request completed"}
{"level":30,"time":1761579972851,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"GET","url":"/api/orders/1","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":50,"time":1761579972857,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"ApiError","message":"Order not found","stack":"ApiError: Order not found\n    at getOrderById (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orders\\queries.ts:144:11)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:83:21)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"GET","url":"/api/orders/1","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"An error occurred during the request"}
{"level":30,"time":1761579972858,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":404},"responseTime":6.864900000393391,"msg":"request completed"}
{"level":30,"time":1761579973099,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579973117,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":18.020700000226498,"msg":"request completed"}
{"level":30,"time":1761579973118,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"GET","url":"/api/orders/1","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579973127,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":9.828899998217821,"msg":"request completed"}
{"level":30,"time":1761579973357,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579973378,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":20.324000000953674,"msg":"request completed"}
{"level":30,"time":1761579973378,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"GET","url":"/api/orders/my","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579973384,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":6.148499999195337,"msg":"request completed"}
 [32m‚úì[39m src/tests/order.integration.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1476[2mms[22m[39m
[90mstdout[2m | src/tests/publicEndpointSecurity.integration.test.ts[2m > [22m[2mPublic Endpoint Security Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

 [32m‚úì[39m src/tests/publicEndpointSecurity.integration.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 1527[2mms[22m[39m
[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

{"level":30,"time":1761579975221,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock acquired, running task"}
{"level":30,"time":1761579975235,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":30,"time":1761579975235,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":30,"time":1761579975237,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":30,"time":1761579975238,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":30,"time":1761579975238,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":30,"time":1761579975238,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":30,"time":1761579975240,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":30,"time":1761579975240,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":30,"time":1761579975240,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock could not be acquired, another instance is likely running"}
{"level":20,"time":1761579975436,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:concurrent-lock-verification","msg":"Advisory lock released"}
{"level":30,"time":1761579975658,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:lock-b","msg":"Advisory lock acquired, running task"}
{"level":30,"time":1761579975658,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:lock-a","msg":"Advisory lock acquired, running task"}
{"level":20,"time":1761579975659,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:lock-a","msg":"Advisory lock released"}
{"level":20,"time":1761579975660,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:lock-b","msg":"Advisory lock released"}
{"level":30,"time":1761579975879,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:error-handling-lock","msg":"Advisory lock acquired, running task"}
{"level":20,"time":1761579975881,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:error-handling-lock","msg":"Advisory lock released"}
{"level":30,"time":1761579975884,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:error-handling-lock","msg":"Advisory lock acquired, running task"}
{"level":20,"time":1761579975885,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","lockName":"test:error-handling-lock","msg":"Advisory lock released"}
 [32m‚úì[39m src/tests/advisoryLock.integration.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 902[2mms[22m[39m
   [33m[2m‚úì[22m[39m Advisory Lock Concurrent Execution Tests[2m > [22mÂ∫îËØ•Á°Æ‰øùÂú®Âπ∂ÂèëÂú∫ÊôØ‰∏ãÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°ÂÆû‰æãËÉΩËé∑ÂèñÂà∞Âêå‰∏Ä‰∏™Âí®ËØ¢ÈîÅ [33m 456[2mms[22m[39m
[90mstdout[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

[90mstderr[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1761579976276,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/sell-orders","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579976277,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","userId":1,"userRole":"STAFF","requiredRole":"STAFF","source":"jwt_payload","msg":"Role check debug"}
{"level":30,"time":1761579976277,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","operatorId":1,"customerPhoneNumber":"13900139000","totalWeightKg":3.2,"unitPriceCents":250,"settlementType":"CASH","action":"CREATE_SELL_ORDER","msg":"STAFF member creating sell order"}
{"level":30,"time":1761579976312,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","operatorId":1,"targetUserId":2,"orderId":1,"totalAmount":800,"action":"SELL_ORDER_CREATED","msg":"Sell order created successfully"}
{"level":30,"time":1761579976312,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":35.89580000191927,"msg":"request completed"}
{"level":30,"time":1761579976531,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/sell-orders","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579976532,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":403},"responseTime":0.37799999862909317,"msg":"request completed"}
 [32m‚úì[39m src/tests/sellOrders.integration.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 852[2mms[22m[39m
[90mstdout[2m | tests/integration/db/views/orderView.test.ts
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

 [32m‚úì[39m tests/integration/db/views/orderView.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 817[2mms[22m[39m
   [33m[2m‚úì[22m[39m db/views/orderView[2m > [22mreturns the expected public shape for orders with inventory items [33m 334[2mms[22m[39m
[90mstdout[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

[90mstderr[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39m!!! WARNING: Failed to initialize WeChat Pay SDK. Payment features will be disabled. Reason: WeChat Pay configuration is incomplete or certificate files are missing.

[90mstderr[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1761579978021,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"GET","url":"/api/acquisitions/check?isbn=9781234567897","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579978033,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":200},"responseTime":11.298599999397993,"msg":"request completed"}
{"level":30,"time":1761579978246,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"GET","url":"/api/acquisitions/check?isbn=9781234567898","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1761579978249,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":2.91330000013113,"msg":"request completed"}
 [32m‚úì[39m src/tests/acquisitions.integration.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 618[2mms[22m[39m
[90mstdout[2m | src/tests/refund-recovery.integration.test.ts[2m > [22m[2mRefund Recovery Integration
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

{"level":50,"time":1761579978857,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Failed to process refund for out_trade_no: FAIL_1_1761579978843",{}],"msg":"error log"}
{"level":50,"time":1761579978860,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Refund permanently failed after 5 attempts for out_trade_no: FAIL_1_1761579978843"],"msg":"error log"}
 [32m‚úì[39m src/tests/refund-recovery.integration.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 594[2mms[22m[39m
   [33m[2m‚úì[22m[39m Refund Recovery Integration[2m > [22mshould resume processing refunds that are stuck in REFUND_PROCESSING [33m 318[2mms[22m[39m
[90mstdout[2m | tests/integration/db/views/inventoryView.test.ts
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

 [32m‚úì[39m tests/integration/db/views/inventoryView.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 471[2mms[22m[39m
[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests[2m > [22m[2mshould cancel expired orders and release inventory
[22m[39mCreated test user ID: [33m1[39m
Created inventory item IDs: [ [33m1[39m, [33m2[39m ]

[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests[2m > [22m[2mshould cancel expired orders and release inventory
[22m[39mFound inventory items: [ { id: [33m1[39m, status: [32m'in_stock'[39m }, { id: [33m2[39m, status: [32m'in_stock'[39m } ]

{"level":30,"time":1761579979736,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","data":["Atomically cancelled 1 orders and released 2 items back to stock."],"msg":"info log"}
 [32m‚úì[39m src/tests/order-expiration.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 314[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Expiration Integration Tests[2m > [22mshould cancel expired orders and release inventory [33m 311[2mms[22m[39m
[90mstdout[2m | src/tests/order-pagination.integration.test.ts[2m > [22m[2mOrder Cursor Pagination Integration
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

 [32m‚úì[39m src/tests/order-pagination.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 312[2mms[22m[39m
   [33m[2m‚úì[22m[39m Order Cursor Pagination Integration[2m > [22mshould return first page with next cursor for subsequent fetch [33m 308[2mms[22m[39m
[90mstdout[2m | src/tests/order-payment-amount.integration.test.ts[2m > [22m[2morder payment amount integrity
[22m[39m[Simple Setup] Creating new Prisma client for worker 1

{"level":50,"time":1761579980468,"pid":50652,"hostname":"LAPTOP-P2FCIAFQ","orderId":1,"storedAmount":8001,"calculatedAmount":8000,"userId":1,"msg":"CRITICAL: Amount mismatch detected for order 1. This indicates data corruption!"}
 [32m‚úì[39m src/tests/order-payment-amount.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 282[2mms[22m[39m

[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Tests 7 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m src/tests/databaseRules.integration.test.ts[2m > [22mDatabase-level Business Rules[2m > [22mwithTxRetry[2m > [22mretries deterministically on serialization conflicts
[31m[1mAssertionError[22m: expected 'rejected' to be 'fulfilled' // Object.is equality[39m

Expected: [32m"[7mfulfill[27med"[39m
Received: [31m"[7mreject[27med"[39m

[36m [2m‚ùØ[22m src/tests/databaseRules.integration.test.ts:[2m56:34[22m[39m
    [90m 54| [39m      const [, retryResult] = await Promise.allSettled([lockingTransac‚Ä¶
    [90m 55| [39m
    [90m 56| [39m      [34mexpect[39m(retryResult[33m.[39mstatus)[33m.[39m[34mtoBe[39m([32m"fulfilled"[39m)[33m;[39m
    [90m   | [39m                                 [31m^[39m
    [90m 57| [39m      [34mexpect[39m(attempts)[33m.[39m[34mtoBeGreaterThan[39m([34m1[39m)[33m;[39m
    [90m 58| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/7]‚éØ[22m[39m

[41m[1m FAIL [22m[49m src/tests/services/create.integration.test.ts[2m > [22mOrder Creation Integration Tests[2m > [22mcreateOrder - Happy Path[2m > [22mshould successfully create order with single item
[31m[1mAssertionError[22m: expected 'reserved' to be 'RESERVED' // Object.is equality[39m

Expected: [32m"RESERVED"[39m
Received: [31m"reserved"[39m

[36m [2m‚ùØ[22m src/tests/services/create.integration.test.ts:[2m118:37[22m[39m
    [90m116| [39m        where[33m:[39m { id[33m:[39m testInventoryItemIds[[34m0[39m] }[33m,[39m
    [90m117| [39m      })[33m;[39m
    [90m118| [39m      [34mexpect[39m(inventoryItem[33m?.[39mstatus)[33m.[39m[34mtoBe[39m([32m"RESERVED"[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m119| [39m
    [90m120| [39m      [90m// Verify order items created[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[2/7]‚éØ[22m[39m

[41m[1m FAIL [22m[49m src/tests/services/create.integration.test.ts[2m > [22mOrder Creation Integration Tests[2m > [22mcreateOrder - User Reservation Limits[2m > [22mshould throw 403 when user exceeds MAX_RESERVED_ITEMS_PER_USER
[31m[1mPrismaClientKnownRequestError[22m: 
Invalid `prisma.pendingPaymentOrder.delete()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\services\create.integration.test.ts:408:40

  405   where: { id: order1.id },
  406   data: { status: "PENDING_PICKUP", paid_at: new Date() },
  407 });
‚Üí 408 await prisma.pendingPaymentOrder.delete(
An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.[39m
[90m [2m‚ùØ[22m ei.handleRequestError node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m228:13[22m[39m
[90m [2m‚ùØ[22m ei.handleAndLogRequestError node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m174:12[22m[39m
[90m [2m‚ùØ[22m ei.request node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m143:12[22m[39m
[90m [2m‚ùØ[22m a node_modules/@prisma/client/src/runtime/getPrismaClient.ts:[2m833:24[22m[39m
[36m [2m‚ùØ[22m src/tests/services/create.integration.test.ts:[2m408:7[22m[39m
    [90m406| [39m        data[33m:[39m { status[33m:[39m [32m"PENDING_PICKUP"[39m[33m,[39m paid_at[33m:[39m [35mnew[39m [33mDate[39m() }[33m,[39m
    [90m407| [39m      })[33m;[39m
    [90m408| [39m      [35mawait[39m prisma[33m.[39mpendingPaymentOrder[33m.[39m[35mdelete[39m({
    [90m   | [39m      [31m^[39m
    [90m409| [39m        where[33m:[39m { order_id[33m:[39m order1[33m.[39mid }[33m,[39m
    [90m410| [39m      })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[3/7]‚éØ[22m[39m

[41m[1m FAIL [22m[49m src/tests/services/create.integration.test.ts[2m > [22mOrder Creation Integration Tests[2m > [22mcreateOrder - Concurrent Order Protection[2m > [22mshould allow creating new order after previous order is paid
[31m[1mPrismaClientKnownRequestError[22m: 
Invalid `prisma.pendingPaymentOrder.delete()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\services\create.integration.test.ts:488:40

  485 });
  486 
  487 // Delete pending payment order record
‚Üí 488 await prisma.pendingPaymentOrder.delete(
An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.[39m
[90m [2m‚ùØ[22m ei.handleRequestError node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m228:13[22m[39m
[90m [2m‚ùØ[22m ei.handleAndLogRequestError node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m174:12[22m[39m
[90m [2m‚ùØ[22m ei.request node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m143:12[22m[39m
[90m [2m‚ùØ[22m a node_modules/@prisma/client/src/runtime/getPrismaClient.ts:[2m833:24[22m[39m
[36m [2m‚ùØ[22m src/tests/services/create.integration.test.ts:[2m488:7[22m[39m
    [90m486| [39m
    [90m487| [39m      [90m// Delete pending payment order record[39m
    [90m488| [39m      [35mawait[39m prisma[33m.[39mpendingPaymentOrder[33m.[39m[35mdelete[39m({
    [90m   | [39m      [31m^[39m
    [90m489| [39m        where[33m:[39m {
    [90m490| [39m          order_id: firstOrder.id, // Use primary key instead of compo‚Ä¶

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[4/7]‚éØ[22m[39m

[41m[1m FAIL [22m[49m src/tests/services/create.integration.test.ts[2m > [22mOrder Creation Integration Tests[2m > [22mcreateOrder - Metrics[2m > [22mshould increment ordersCreated metric on success
[31m[1mTypeError[22m: metrics.ordersCreated.get is not a function[39m
[36m [2m‚ùØ[22m src/tests/services/create.integration.test.ts:[2m539:57[22m[39m
    [90m537| [39m  [34mdescribe[39m([32m"createOrder - Metrics"[39m[33m,[39m () [33m=>[39m {
    [90m538| [39m    it("should increment ordersCreated metric on success", async () =>‚Ä¶
    [90m539| [39m      [35mconst[39m initialMetric [33m=[39m [35mawait[39m metrics[33m.[39mordersCreated[33m.[39m[35mget[39m()[33m;[39m
    [90m   | [39m                                                        [31m^[39m
    [90m540| [39m      [35mconst[39m initialValue [33m=[39m initialMetric[33m.[39mvalues[[34m0[39m][33m?.[39mvalue [33m||[39m [34m0[39m[33m;[39m
    [90m541| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[5/7]‚éØ[22m[39m

[41m[1m FAIL [22m[49m src/tests/services/create.integration.test.ts[2m > [22mOrder Creation Integration Tests[2m > [22mcreateOrder - Pickup Code Generation[2m > [22mshould generate unique pickup code for each order
[31m[1mPrismaClientKnownRequestError[22m: 
Invalid `prisma.pendingPaymentOrder.delete()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\services\create.integration.test.ts:566:40

  563   where: { id: order1.id },
  564   data: { status: "PENDING_PICKUP", paid_at: new Date() },
  565 });
‚Üí 566 await prisma.pendingPaymentOrder.delete(
An operation failed because it depends on one or more records that were required but not found. No record was found for a delete.[39m
[90m [2m‚ùØ[22m ei.handleRequestError node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m228:13[22m[39m
[90m [2m‚ùØ[22m ei.handleAndLogRequestError node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m174:12[22m[39m
[90m [2m‚ùØ[22m ei.request node_modules/@prisma/client/src/runtime/RequestHandler.ts:[2m143:12[22m[39m
[90m [2m‚ùØ[22m a node_modules/@prisma/client/src/runtime/getPrismaClient.ts:[2m833:24[22m[39m
[36m [2m‚ùØ[22m src/tests/services/create.integration.test.ts:[2m566:7[22m[39m
    [90m564| [39m        data[33m:[39m { status[33m:[39m [32m"PENDING_PICKUP"[39m[33m,[39m paid_at[33m:[39m [35mnew[39m [33mDate[39m() }[33m,[39m
    [90m565| [39m      })[33m;[39m
    [90m566| [39m      [35mawait[39m prisma[33m.[39mpendingPaymentOrder[33m.[39m[35mdelete[39m({
    [90m   | [39m      [31m^[39m
    [90m567| [39m        where[33m:[39m {
    [90m568| [39m          order_id: order1.id, // Use primary key instead of composite‚Ä¶

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[6/7]‚éØ[22m[39m

[41m[1m FAIL [22m[49m src/tests/services/payments.integration.test.ts[2m > [22mPayments Integration Tests[2m > [22mpreparePaymentIntent[2m > [22mshould throw 500 and increment metric when amount mismatch detected
[31m[1mAssertionError[22m: expected "inc" to be called once, but got 2 times[39m
[36m [2m‚ùØ[22m src/tests/services/payments.integration.test.ts:[2m199:26[22m[39m
    [90m197| [39m
    [90m198| [39m      [90m// Verify metric was incremented[39m
    [90m199| [39m      [34mexpect[39m(metricsSpy)[33m.[39m[34mtoHaveBeenCalledOnce[39m()[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m200| [39m    })[33m;[39m
    [90m201| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[7/7]‚éØ[22m[39m


[2m Test Files [22m [1m[31m3 failed[39m[22m[2m | [22m[1m[32m19 passed[39m[22m[90m (22)[39m
[2m      Tests [22m [1m[31m7 failed[39m[22m[2m | [22m[1m[32m155 passed[39m[22m[90m (162)[39m
[2m   Start at [22m 23:45:18
[2m   Duration [22m 61.88s[2m (transform 941ms, setup 193ms, collect 1.98s, tests 56.62s, environment 0ms, prepare 170ms)[22m

[Simple Setup] Tearing down...
[Simple Setup] Teardown complete
