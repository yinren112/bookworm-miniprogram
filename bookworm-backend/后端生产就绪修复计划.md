# 后端生产就绪性修复计划

> 审查日期: 2025-12-07
> 审查范围: bookworm-backend 全部代码
> 总计问题: 43个 (4 CRITICAL, 12 HIGH, 15 MEDIUM, 12 LOW)

---

## Phase 1: CRITICAL 级别（阻塞上线）

### C-1: Placeholder OpenID 碰撞风险 ✅ 已修复
**位置**: `src/services/sellOrderService.ts:42`

**问题描述**:
使用时间戳作为临时openid创建PRE_REGISTERED用户，存在毫秒级碰撞风险。

**修复方案**:
改用UUID确保完全唯一：
```typescript
import { randomUUID } from 'crypto';
openid: `pre_${randomUUID()}`, // 使用UUID确保完全唯一，避免任何碰撞风险
```

**影响范围**: sellOrderService.ts
**修复日期**: 2025-12-07
**状态**: [x] 已修复

---

### C-2: 退款状态竞态条件 ✅ 已正确实现
**位置**: `src/services/refundService.ts:46-56`

**审查结论**:
代码已正确实现乐观锁模式，使用 `updatedAt` 作为版本号防止并发问题：
```typescript
const locked = await dbCtx.paymentRecord.updateMany({
  where: {
    id: record.id,
    status: record.status,
    updatedAt: record.updatedAt, // 乐观锁条件
  },
  data: { status: "REFUND_PROCESSING", ... },
});
if (locked.count === 0) {
  // 跳过 - 已被其他进程处理
}
```

**状态**: [x] 无需修复（已正确实现）

---

### C-3: Acquisition事务污染 ✅ 已正确实现
**位置**: `src/services/acquisitionService.ts:175-188`

**审查结论**:
代码已正确设计事务处理：
- 所有写操作（Acquisition创建、User更新、UserProfile upsert、InventoryItem批量创建）都在 `withTxRetry` 包裹的事务内
- 第115行使用独立 `dbCtx` 查询冲突用户是有意设计（事务失败后需要查询外部状态）
- 使用 `Serializable` 隔离级别确保强一致性

**状态**: [x] 无需修复（已正确实现）

---

### C-4: 缺少CORS配置 ✅ 已修复
**位置**: `src/index.ts:277-292`, `src/config.ts:69-72`

**修复内容**:
1. 安装 `@fastify/cors` 依赖
2. 添加 `CORS_ORIGIN` 配置项（逗号分隔的允许来源列表）
3. 在 `setupApplication` 中注册CORS插件：
   - 生产环境：仅允许 `CORS_ORIGIN` 配置的来源
   - 开发环境：允许所有来源（仅用于本地调试）

```typescript
// config.ts
CORS_ORIGIN: Type.String({ default: "" }),

// index.ts
if (config.CORS_ORIGIN) {
  await fastify.register(cors, {
    origin: config.CORS_ORIGIN.split(",").map((o) => o.trim()),
    credentials: true,
    methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization"],
  });
}
```

**修复日期**: 2025-12-07
**状态**: [x] 已修复

---

## Phase 2: HIGH 级别（上线前应修复）

### H-1: ISBN验证不一致 ✅ 已修复
**位置**: `src/routes/sharedSchemas.ts`

**修复内容**:
创建统一的 `ISBN13Schema` 并在所有路由中使用：
```typescript
export const ISBN13Schema = Type.String({
  pattern: "^[0-9\\-]+$",
  minLength: 10,
  maxLength: 17,
  description: "ISBN-10 或 ISBN-13，支持带短横线格式",
});
```

**修改文件**: sharedSchemas.ts, books.ts, inventory.ts, acquisitions.ts
**修复日期**: 2025-12-07
**状态**: [x] 已修复

---

### H-2: 公开端点缺少速率限制 ✅ 已修复
**位置**: `src/routes/books.ts:23-29`

**修复内容**:
为 `/api/books/meta` 添加速率限制（30次/分钟），与其他公开端点保持一致。

**修复日期**: 2025-12-07
**状态**: [x] 已修复

---

### H-3: pickup_code验证过弱 ✅ 已修复
**位置**: `src/routes/sharedSchemas.ts`, `src/routes/orders.ts`

**修复内容**:
创建统一的 `PickupCodeSchema` 并在fulfill路由中使用：
```typescript
export const PickupCodeSchema = Type.String({
  pattern: "^[a-fA-F0-9]{10}$",
  minLength: 10,
  maxLength: 10,
  description: "取货码 (10位十六进制)",
});
```

**修复日期**: 2025-12-07
**状态**: [x] 已修复

---

### H-4: 定时任务在测试环境启动 ✅ 已修复
**位置**: `src/jobs.ts:40-45`

**修复内容**:
在 `startCronJobs` 开头添加测试环境检查：
```typescript
if (config.NODE_ENV === "test") {
  fastify.log.info("Skipping cron jobs in test environment");
  return;
}
```

**修复日期**: 2025-12-07
**状态**: [x] 已修复

---

### H-5: 无优雅关闭机制 ✅ 已修复
**位置**: `src/jobs.ts:11-38`, `src/index.ts:328-354`

**修复内容**:
1. 在 jobs.ts 添加 `stopCronJobs()` 函数，追踪正在执行的任务
2. 在 index.ts 注册 SIGTERM/SIGINT 处理器，优雅关闭服务：
   - 停止接受新请求
   - 等待定时任务完成
   - 关闭数据库连接

**修复日期**: 2025-12-07
**状态**: [x] 已修复

---

### H-6: FK约束onDelete行为未定义 ⏸️ 延后
**位置**: `prisma/schema.prisma`

**问题描述**:
部分外键关联缺少 `onDelete` 行为定义，删除父记录时行为不可预测。

**评估**: 当前业务逻辑不涉及删除父记录（订单、用户等），此问题风险较低，延后至数据清理需求出现时处理。

**状态**: [ ] 延后处理

---

### H-7: OrderSellDetails孤儿记录风险 ✅ 已验证安全
**位置**: `src/services/sellOrderService.ts:82-107`

**审查结论**:
OrderSellDetails 的创建已在 `withTxRetry` 包裹的事务内（与Order创建在同一事务），不存在孤儿记录风险。

**状态**: [x] 无需修复（已正确实现）

---

### H-8: HOST配置风险 ✅ 已验证安全
**位置**: `src/config.ts:10`

**审查结论**:
当前默认值已是 `127.0.0.1`（非0.0.0.0），符合安全要求。

**状态**: [x] 无需修复（已正确配置）

---

### H-9: JWT过期时间硬编码 ✅ 已验证安全
**位置**: `src/services/authService.ts:120-122`

**审查结论**:
JWT签名已使用 `config.JWT_EXPIRES_IN`：
```typescript
const signer = createSigner({
  key: config.JWT_SECRET,
  expiresIn: config.JWT_EXPIRES_IN, // 从配置读取
});
```

**状态**: [x] 无需修复（已正确实现）

---

### H-10: View Selector重复定义 ✅ 已验证
**位置**: `src/db/views/index.ts`

**审查结论**:
已存在统一导出文件 `db/views/index.ts`，所有view selectors已集中管理。

**状态**: [x] 无需修复（已正确实现）

---

### H-11: 微信支付缺少连接超时 ⏸️ 延后
**位置**: `src/adapters/wechatPayAdapter.ts`

**评估**:
wechatpay-node-v3 SDK内部使用axios，需要修改SDK配置或使用拦截器。此问题影响较小，延后至SDK升级时处理。

**状态**: [ ] 延后处理

---

### H-12: 日志敏感字段redaction不完整 ✅ 已验证完整
**位置**: `src/index.ts:50-79`

**审查结论**:
当前redaction配置已覆盖28个敏感字段路径，包括：
- authorization headers
- phone_number, phoneNumber, customerPhoneNumber
- openid, unionid
- pickup_code, pickupCode
- phoneCode

**状态**: [x] 无需修复（已正确实现）

---

## Phase 3: MEDIUM 级别（上线后迭代）

### M-1: N+1查询风险
**位置**: `src/services/inventoryService.ts`
**描述**: 循环内执行单条查询
**状态**: [ ] 待修复

### M-2: 外部API缺少重试逻辑
**位置**: `src/services/bookMetadataService.ts`
**描述**: 谭书API调用无重试
**状态**: [ ] 待修复

### M-3: 用户数据未过滤敏感字段
**位置**: `src/routes/users.ts`
**描述**: 返回数据可能包含敏感信息
**状态**: [ ] 待修复

### M-4: 异常静默吞掉
**位置**: `src/jobs/refundProcessor.ts`
**描述**: 缺少告警机制
**状态**: [ ] 待修复

### M-5: 指标标签基数过高
**位置**: `src/plugins/metrics.ts`
**描述**: 可能导致Prometheus内存问题
**状态**: [ ] 待修复

### M-6: console.log残留
**位置**: 多处
**描述**: 应替换为结构化日志
**状态**: [ ] 待修复

### M-7: 索引缺少注释
**位置**: `prisma/schema.prisma`
**描述**: 索引用途不明确
**状态**: [ ] 待修复

### M-8: access_token刷新边界条件
**位置**: `src/services/authService.ts`
**描述**: 边界条件未处理
**状态**: [ ] 待修复

### M-9: 错误响应格式不统一
**位置**: `src/routes/acquisitions.ts`
**描述**: 缺少标准化错误格式
**状态**: [ ] 待修复

### M-10: 环境变量验证不完整
**位置**: `src/config.ts`
**描述**: 部分变量缺少验证
**状态**: [ ] 待修复

### M-11: 连接池耗尽无降级
**位置**: `src/db/index.ts`
**描述**: 无降级策略
**状态**: [ ] 待修复

### M-12: 分页cursor验证不充分
**位置**: `src/routes/orders/index.ts`
**描述**: 可能导致注入
**状态**: [ ] 待修复

### M-13: 内容缓存无失效
**位置**: `src/services/contentService.ts`
**描述**: 无TTL机制
**状态**: [ ] 待修复

### M-14: 指标采集失败未记录
**位置**: `src/jobs/inventoryMetrics.ts`
**描述**: 静默失败
**状态**: [ ] 待修复

### M-15: 证书刷新失败无告警
**位置**: `src/adapters/wechatPayAdapter.ts`
**描述**: 缺少告警
**状态**: [ ] 待修复

---

## Phase 4: LOW 级别（可选优化）

- L-1: 代码注释不足
- L-2: 部分函数过长
- L-3: 魔法数字未提取常量
- L-4: 类型定义可优化
- L-5: 测试覆盖率可提升
- L-6: 错误消息国际化
- L-7: API文档不完整
- L-8: 代码格式不一致
- L-9: 无用import残留
- L-10: 变量命名不规范
- L-11: Promise链可优化
- L-12: 日志级别使用不当

---

## 修复进度追踪

| Phase | 总计 | 已完成 | 延后 | 进度 |
|-------|------|--------|------|------|
| CRITICAL | 4 | 4 | 0 | 100% ✅ |
| HIGH | 12 | 10 | 2 | 83% ✅ |
| MEDIUM | 15 | 0 | 0 | 0% |
| LOW | 12 | 0 | 0 | 0% |
| **总计** | **43** | **14** | **2** | **33%** |

### CRITICAL 完成明细
- [x] C-1: 改用UUID避免OpenID碰撞（已修复）
- [x] C-2: 退款乐观锁（已正确实现，无需修复）
- [x] C-3: Acquisition事务设计（已正确实现，无需修复）
- [x] C-4: CORS配置（已修复）

### HIGH 完成明细
- [x] H-1: ISBN验证统一（已修复）
- [x] H-2: 公开端点速率限制（已修复）
- [x] H-3: pickup_code验证加强（已修复）
- [x] H-4: 测试环境跳过cron（已修复）
- [x] H-5: 优雅关闭机制（已修复）
- [ ] H-6: FK约束onDelete（延后）
- [x] H-7: OrderSellDetails事务安全（已正确实现）
- [x] H-8: HOST配置（已正确配置）
- [x] H-9: JWT过期时间（已正确实现）
- [x] H-10: View Selector统一导出（已正确实现）
- [ ] H-11: 微信支付超时（延后）
- [x] H-12: 日志redaction完整性（已正确实现）

---

## 修复顺序建议

1. ~~**第一批次（阻塞上线）**: C-1, C-2, C-3, C-4~~ ✅ 已完成
2. ~~**第二批次（上线前）**: H-1 ~ H-12~~ ✅ 已完成（2项延后）
3. **第三批次（上线后迭代）**: M-1 ~ M-15
4. **第四批次（可选优化）**: L-1 ~ L-12

---

*最后更新: 2025-12-07 19:55*
