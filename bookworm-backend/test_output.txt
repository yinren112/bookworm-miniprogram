
> bookworm-backend@1.0.0 test:integration
> dotenv -e .env.test -- vitest run --config vitest.integration.config.ts


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mC:/Users/wapadil/WeChatProjects/miniprogram-13/bookworm-backend[39m

[Worker 1] Starting a dedicated PostgreSQL container...
[Worker 1] Container started. Applying migrations...
[Worker 1] Migrations applied.
[90mstdout[2m | src/tests/concurrent-order-control.integration.test.ts[2m > [22m[2mConcurrent Order Control Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m✓[39m src/tests/concurrent-order-control.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1529[2mms[22m[39m
[90mstdout[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...
✅ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstdout[2m | src/tests/profile-and-recommendations.integration.test.ts[2m > [22m[2mUser Profile & Recommendations Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760178485765,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485785,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":17,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178485805,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":39.65819999575615,"msg":"request completed"}
{"level":30,"time":1760178485823,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485825,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":19,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178485832,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":201},"responseTime":9.120800018310547,"msg":"request completed"}
{"level":30,"time":1760178485833,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485835,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":19,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178485845,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":11.5625,"msg":"request completed"}
{"level":30,"time":1760178485867,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485869,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":21,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178485876,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":201},"responseTime":8.892800003290176,"msg":"request completed"}
{"level":30,"time":1760178485890,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/acquisitions","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485892,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":403},"responseTime":2.8750999867916107,"msg":"request completed"}
{"level":30,"time":1760178485923,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485941,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":17.075299978256226,"msg":"request completed"}
{"level":30,"time":1760178485968,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485976,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":7.731700003147125,"msg":"request completed"}
{"level":30,"time":1760178485982,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485985,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":2.9345000088214874,"msg":"request completed"}
{"level":30,"time":1760178485991,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485994,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":200},"responseTime":2.9200000166893005,"msg":"request completed"}
{"level":30,"time":1760178485995,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"GET","url":"/api/books/recommendations","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178485995,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":401},"responseTime":0.20509999990463257,"msg":"request completed"}
 [32m✓[39m src/tests/profile-and-recommendations.integration.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 1209[2mms[22m[39m
[90mstdout[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...
✅ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstdout[2m | src/tests/order-status-management.integration.test.ts[2m > [22m[2mOrder Status Management Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760178486284,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13666","remoteAddress":"::ffff:127.0.0.1","remotePort":13667},"msg":"incoming request"}
{"level":30,"time":1760178486317,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":32.54010000824928,"msg":"request completed"}
{"level":30,"time":1760178486329,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"PATCH","url":"/api/orders/19/status","hostname":"127.0.0.1:13668","remoteAddress":"::ffff:127.0.0.1","remotePort":13669},"msg":"incoming request"}
{"level":30,"time":1760178486331,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178486356,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":27.338200002908707,"msg":"request completed"}
{"level":30,"time":1760178486383,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13670","remoteAddress":"::ffff:127.0.0.1","remotePort":13671},"msg":"incoming request"}
{"level":30,"time":1760178486406,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":22.75110000371933,"msg":"request completed"}
{"level":30,"time":1760178486413,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"PATCH","url":"/api/orders/20/status","hostname":"127.0.0.1:13672","remoteAddress":"::ffff:127.0.0.1","remotePort":13673},"msg":"incoming request"}
{"level":30,"time":1760178486417,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178486434,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":200},"responseTime":20.17270001769066,"msg":"request completed"}
{"level":30,"time":1760178486458,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13674","remoteAddress":"::ffff:127.0.0.1","remotePort":13675},"msg":"incoming request"}
{"level":30,"time":1760178486480,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":21.994500011205673,"msg":"request completed"}
{"level":30,"time":1760178486493,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"PATCH","url":"/api/orders/21/status","hostname":"127.0.0.1:13676","remoteAddress":"::ffff:127.0.0.1","remotePort":13677},"msg":"incoming request"}
{"level":30,"time":1760178486494,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178486504,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":11.183699995279312,"msg":"request completed"}
{"level":30,"time":1760178486527,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13678","remoteAddress":"::ffff:127.0.0.1","remotePort":13679},"msg":"incoming request"}
{"level":30,"time":1760178486545,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":18.583499997854233,"msg":"request completed"}
{"level":30,"time":1760178486558,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"PATCH","url":"/api/orders/22/status","hostname":"127.0.0.1:13680","remoteAddress":"::ffff:127.0.0.1","remotePort":13681},"msg":"incoming request"}
{"level":30,"time":1760178486560,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760178486567,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","err":{"type":"ApiError","message":"无法将订单从 PENDING_PAYMENT 更新为 COMPLETED","stack":"ApiError: 无法将订单从 PENDING_PAYMENT 更新为 COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/22/status","hostname":"127.0.0.1:13680","remoteAddress":"::ffff:127.0.0.1","remotePort":13681},"msg":"An error occurred during the request"}
{"level":30,"time":1760178486569,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":400},"responseTime":10.43529999256134,"msg":"request completed"}
{"level":30,"time":1760178486599,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13682","remoteAddress":"::ffff:127.0.0.1","remotePort":13683},"msg":"incoming request"}
{"level":30,"time":1760178486622,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":201},"responseTime":22.282899975776672,"msg":"request completed"}
{"level":30,"time":1760178486637,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"PATCH","url":"/api/orders/23/status","hostname":"127.0.0.1:13684","remoteAddress":"::ffff:127.0.0.1","remotePort":13685},"msg":"incoming request"}
{"level":30,"time":1760178486640,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760178486646,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","err":{"type":"ApiError","message":"无法将订单从 COMPLETED 更新为 CANCELLED","stack":"ApiError: 无法将订单从 COMPLETED 更新为 CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/23/status","hostname":"127.0.0.1:13684","remoteAddress":"::ffff:127.0.0.1","remotePort":13685},"msg":"An error occurred during the request"}
{"level":30,"time":1760178486647,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":400},"responseTime":10.294699996709824,"msg":"request completed"}
{"level":30,"time":1760178486670,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13686","remoteAddress":"::ffff:127.0.0.1","remotePort":13687},"msg":"incoming request"}
{"level":30,"time":1760178486689,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":201},"responseTime":19.171999990940094,"msg":"request completed"}
{"level":30,"time":1760178486698,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"PATCH","url":"/api/orders/24/status","hostname":"127.0.0.1:13688","remoteAddress":"::ffff:127.0.0.1","remotePort":13689},"msg":"incoming request"}
{"level":30,"time":1760178486700,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760178486706,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"ApiError","message":"无法将订单从 CANCELLED 更新为 COMPLETED","stack":"ApiError: 无法将订单从 CANCELLED 更新为 COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/24/status","hostname":"127.0.0.1:13688","remoteAddress":"::ffff:127.0.0.1","remotePort":13689},"msg":"An error occurred during the request"}
{"level":30,"time":1760178486706,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":400},"responseTime":8.037400007247925,"msg":"request completed"}
{"level":30,"time":1760178486727,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13690","remoteAddress":"::ffff:127.0.0.1","remotePort":13691},"msg":"incoming request"}
{"level":30,"time":1760178486742,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","res":{"statusCode":201},"responseTime":14.457500010728836,"msg":"request completed"}
{"level":30,"time":1760178486746,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","req":{"method":"PATCH","url":"/api/orders/25/status","hostname":"127.0.0.1:13692","remoteAddress":"::ffff:127.0.0.1","remotePort":13693},"msg":"incoming request"}
{"level":30,"time":1760178486749,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","res":{"statusCode":403},"responseTime":2.3294000029563904,"msg":"request completed"}
{"level":30,"time":1760178486774,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13694","remoteAddress":"::ffff:127.0.0.1","remotePort":13695},"msg":"incoming request"}
{"level":30,"time":1760178486786,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","res":{"statusCode":201},"responseTime":12.877099990844727,"msg":"request completed"}
{"level":30,"time":1760178486791,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","req":{"method":"PATCH","url":"/api/orders/26/status","hostname":"127.0.0.1:13696","remoteAddress":"::ffff:127.0.0.1","remotePort":13697},"msg":"incoming request"}
{"level":30,"time":1760178486792,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","res":{"statusCode":401},"responseTime":0.3109999895095825,"msg":"request completed"}
{"level":30,"time":1760178486813,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13698","remoteAddress":"::ffff:127.0.0.1","remotePort":13699},"msg":"incoming request"}
{"level":30,"time":1760178486827,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","res":{"statusCode":201},"responseTime":14.376200020313263,"msg":"request completed"}
{"level":30,"time":1760178486833,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:13700","remoteAddress":"::ffff:127.0.0.1","remotePort":13701},"msg":"incoming request"}
{"level":30,"time":1760178486836,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760178486840,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:13700","remoteAddress":"::ffff:127.0.0.1","remotePort":13701},"msg":"An error occurred during the request"}
{"level":30,"time":1760178486842,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","res":{"statusCode":404},"responseTime":8.417799979448318,"msg":"request completed"}
{"level":30,"time":1760178486867,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13702","remoteAddress":"::ffff:127.0.0.1","remotePort":13703},"msg":"incoming request"}
{"level":30,"time":1760178486879,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","res":{"statusCode":201},"responseTime":12.751800000667572,"msg":"request completed"}
{"level":30,"time":1760178486887,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:13704","remoteAddress":"::ffff:127.0.0.1","remotePort":13705},"msg":"incoming request"}
{"level":50,"time":1760178486887,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","err":{"type":"Error","message":"params/id must be number","stack":"Error: params/id must be number\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:145:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/id","schemaPath":"#/properties/id/type","keyword":"type","params":{"type":"number"},"message":"must be number"}],"validationContext":"params"},"req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:13704","remoteAddress":"::ffff:127.0.0.1","remotePort":13705},"msg":"An error occurred during the request"}
{"level":30,"time":1760178486889,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","res":{"statusCode":400},"responseTime":2.297199994325638,"msg":"request completed"}
{"level":30,"time":1760178486909,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:13706","remoteAddress":"::ffff:127.0.0.1","remotePort":13707},"msg":"incoming request"}
{"level":30,"time":1760178486922,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","res":{"statusCode":201},"responseTime":12.761000007390976,"msg":"request completed"}
{"level":30,"time":1760178486930,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","req":{"method":"PATCH","url":"/api/orders/29/status","hostname":"127.0.0.1:13708","remoteAddress":"::ffff:127.0.0.1","remotePort":13709},"msg":"incoming request"}
{"level":50,"time":1760178486930,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","err":{"type":"Error","message":"body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf","stack":"Error: body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/0/const","keyword":"const","params":{"allowedValue":"COMPLETED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/1/const","keyword":"const","params":{"allowedValue":"CANCELLED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf","keyword":"anyOf","params":{},"message":"must match a schema in anyOf"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/29/status","hostname":"127.0.0.1:13708","remoteAddress":"::ffff:127.0.0.1","remotePort":13709},"msg":"An error occurred during the request"}
{"level":30,"time":1760178486930,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","res":{"statusCode":400},"responseTime":0.6570999920368195,"msg":"request completed"}
{"level":30,"time":1760178486955,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:4824","remoteAddress":"::ffff:127.0.0.1","remotePort":4825},"msg":"incoming request"}
{"level":30,"time":1760178486974,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","res":{"statusCode":201},"responseTime":18.85189998149872,"msg":"request completed"}
{"level":30,"time":1760178486981,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","req":{"method":"PATCH","url":"/api/orders/30/status","hostname":"127.0.0.1:4826","remoteAddress":"::ffff:127.0.0.1","remotePort":4827},"msg":"incoming request"}
{"level":50,"time":1760178486981,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/30/status","hostname":"127.0.0.1:4826","remoteAddress":"::ffff:127.0.0.1","remotePort":4827},"msg":"An error occurred during the request"}
{"level":30,"time":1760178486981,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","res":{"statusCode":400},"responseTime":0.5895000100135803,"msg":"request completed"}
{"level":30,"time":1760178487003,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:4828","remoteAddress":"::ffff:127.0.0.1","remotePort":4829},"msg":"incoming request"}
{"level":30,"time":1760178487025,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","res":{"statusCode":201},"responseTime":22.321399986743927,"msg":"request completed"}
{"level":30,"time":1760178487032,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","req":{"method":"PATCH","url":"/api/orders/31/status","hostname":"127.0.0.1:4830","remoteAddress":"::ffff:127.0.0.1","remotePort":4831},"msg":"incoming request"}
{"level":30,"time":1760178487034,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487045,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","res":{"statusCode":200},"responseTime":13.400999993085861,"msg":"request completed"}
{"level":30,"time":1760178487073,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:4832","remoteAddress":"::ffff:127.0.0.1","remotePort":4833},"msg":"incoming request"}
{"level":30,"time":1760178487089,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","res":{"statusCode":201},"responseTime":15.843799978494644,"msg":"request completed"}
{"level":30,"time":1760178487100,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4837},"msg":"incoming request"}
{"level":30,"time":1760178487101,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4840},"msg":"incoming request"}
{"level":30,"time":1760178487102,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4835},"msg":"incoming request"}
{"level":30,"time":1760178487102,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4836},"msg":"incoming request"}
{"level":30,"time":1760178487103,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4838},"msg":"incoming request"}
{"level":30,"time":1760178487103,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4839},"msg":"incoming request"}
{"level":30,"time":1760178487104,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4841},"msg":"incoming request"}
{"level":30,"time":1760178487105,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4842},"msg":"incoming request"}
{"level":30,"time":1760178487106,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4843},"msg":"incoming request"}
{"level":30,"time":1760178487106,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-11","req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4844},"msg":"incoming request"}
{"level":30,"time":1760178487107,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487107,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487107,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487108,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487117,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487118,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487120,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487121,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487122,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487123,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":28,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487125,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-11","res":{"statusCode":200},"responseTime":18.256999999284744,"msg":"request completed"}
{"level":50,"time":1760178487130,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","err":{"type":"ApiError","message":"无法将订单从 CANCELLED 更新为 CANCELLED","stack":"ApiError: 无法将订单从 CANCELLED 更新为 CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4837},"msg":"An error occurred during the request"}
{"level":30,"time":1760178487130,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","res":{"statusCode":400},"responseTime":29.830099999904633,"msg":"request completed"}
{"level":50,"time":1760178487131,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","err":{"type":"ApiError","message":"无法将订单从 CANCELLED 更新为 CANCELLED","stack":"ApiError: 无法将订单从 CANCELLED 更新为 CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4839},"msg":"An error occurred during the request"}
{"level":30,"time":1760178487131,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-x","res":{"statusCode":400},"responseTime":27.83220002055168,"msg":"request completed"}
{"level":50,"time":1760178487131,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","err":{"type":"ApiError","message":"无法将订单从 CANCELLED 更新为 CANCELLED","stack":"ApiError: 无法将订单从 CANCELLED 更新为 CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4836},"msg":"An error occurred during the request"}
{"level":30,"time":1760178487132,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","res":{"statusCode":400},"responseTime":29.4510999917984,"msg":"request completed"}
{"level":50,"time":1760178487133,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","err":{"type":"ApiError","message":"无法将订单从 CANCELLED 更新为 CANCELLED","stack":"ApiError: 无法将订单从 CANCELLED 更新为 CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4838},"msg":"An error occurred during the request"}
{"level":30,"time":1760178487133,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","res":{"statusCode":400},"responseTime":30.593100011348724,"msg":"request completed"}
{"level":50,"time":1760178487136,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","err":{"type":"ApiError","message":"无法将订单从 CANCELLED 更新为 CANCELLED","stack":"ApiError: 无法将订单从 CANCELLED 更新为 CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4841},"msg":"An error occurred during the request"}
{"level":30,"time":1760178487136,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-y","res":{"statusCode":400},"responseTime":32.084199994802475,"msg":"request completed"}
{"level":50,"time":1760178487136,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","err":{"type":"ApiError","message":"无法将订单从 CANCELLED 更新为 CANCELLED","stack":"ApiError: 无法将订单从 CANCELLED 更新为 CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4843},"msg":"An error occurred during the request"}
{"level":30,"time":1760178487136,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-10","res":{"statusCode":400},"responseTime":30.645000010728836,"msg":"request completed"}
{"level":50,"time":1760178487136,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","err":{"type":"ApiError","message":"无法将订单从 CANCELLED 更新为 CANCELLED","stack":"ApiError: 无法将订单从 CANCELLED 更新为 CANCELLED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/32/status","hostname":"127.0.0.1:4834","remoteAddress":"::ffff:127.0.0.1","remotePort":4842},"msg":"An error occurred during the request"}
{"level":30,"time":1760178487137,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-z","res":{"statusCode":400},"responseTime":32.01339998841286,"msg":"request completed"}
{"level":30,"time":1760178487145,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","res":{"statusCode":200},"responseTime":43.43309998512268,"msg":"request completed"}
{"level":30,"time":1760178487156,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","res":{"statusCode":200},"responseTime":54.74309998750687,"msg":"request completed"}
 [32m✓[39m src/tests/order-status-management.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1093[2mms[22m[39m
[90mstdout[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...
✅ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstdout[2m | src/tests/auth-role-revocation.integration.test.ts[2m > [22m[2mAuth: Role Revocation Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760178487316,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178487321,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":30,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487652,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":336.176499992609,"msg":"request completed"}
{"level":30,"time":1760178487657,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178487659,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":403},"responseTime":2.103199988603592,"msg":"request completed"}
{"level":30,"time":1760178487663,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178487664,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":403},"responseTime":1.8113999962806702,"msg":"request completed"}
{"level":30,"time":1760178487668,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178487671,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":31,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487762,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":201},"responseTime":93.80590000748634,"msg":"request completed"}
{"level":30,"time":1760178487770,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178487773,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":32,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178487879,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":108.69390001893044,"msg":"request completed"}
{"level":30,"time":1760178487881,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178487886,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":403},"responseTime":4.887499988079071,"msg":"request completed"}
{"level":30,"time":1760178487891,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/inventory/add","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178487894,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":32,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178488001,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":109.51900002360344,"msg":"request completed"}
 [32m✓[39m src/tests/auth-role-revocation.integration.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 824[2mms[22m[39m
   [33m[2m✓[22m[39m Auth: Role Revocation Integration Tests[2m > [22mshould immediately deny access after a user role is demoted from STAFF to USER [33m 367[2mms[22m[39m
[90mstdout[2m | src/tests/inventoryService.integration.test.ts[2m > [22m[2mInventory Service Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [31m❯[39m src/tests/inventoryService.integration.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[32m 281[2mms[22m[39m
   [32m✓[39m Inventory Service Integration Tests[2m > [22maddBookToInventory[2m > [22mshould create a new bookMaster, sku, and inventory item for a new ISBN[32m 49[2mms[22m[39m
   [32m✓[39m Inventory Service Integration Tests[2m > [22maddBookToInventory[2m > [22mshould create only a new inventory item for an existing book SKU[32m 53[2mms[22m[39m
   [32m✓[39m Inventory Service Integration Tests[2m > [22mfulfillOrder[2m > [22mshould complete the order and mark inventory as sold with a valid pickup code[32m 80[2mms[22m[39m
   [32m✓[39m Inventory Service Integration Tests[2m > [22mfulfillOrder[2m > [22mshould throw an error for an invalid pickup code[32m 4[2mms[22m[39m
[31m   [31m×[31m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould find a book with a literal "%" in the title[39m[32m 25[2mms[22m[39m
[31m     → expected [ Array(2) ] to have a length of 1 but got 2[39m
[31m   [31m×[31m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould find a book with literal "__" in the title and not treat it as a wildcard[39m[32m 7[2mms[22m[39m
[31m     → expected [ { id: 265, …(4) }, …(2) ] to have a length of 1 but got 3[39m
   [32m✓[39m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould find a book with "C++" without treating "+" as a special character[32m 2[2mms[22m[39m
   [32m✓[39m Inventory Service Integration Tests[2m > [22mgetAvailableBooks - Search with special LIKE characters[2m > [22mshould handle search terms with multiple special characters[32m 11[2mms[22m[39m
[90mstdout[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...
✅ Test database URL set for worker 1: postgres://test:test@localhost...

{"level":30,"time":1760178488501,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","msg":"WeChat Pay SDK initialized successfully"}
[90mstdout[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760178488544,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4859","remoteAddress":"::ffff:127.0.0.1","remotePort":4860},"msg":"incoming request"}
{"level":40,"time":1760178488560,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\payment.ts:108:33)\n    at preHandlerCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:139:37)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:123:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)"},"resource":{"ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely a malformed/malicious request."}
{"level":30,"time":1760178488561,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":200},"responseTime":17.268700003623962,"msg":"request completed"}
{"level":30,"time":1760178488565,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4861","remoteAddress":"::ffff:127.0.0.1","remotePort":4862},"msg":"incoming request"}
{"level":40,"time":1760178488566,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\payment.ts:108:33)\n    at preHandlerCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:139:37)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:123:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)"},"resource":{"ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely a malformed/malicious request."}
{"level":30,"time":1760178488566,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":1.5023000240325928,"msg":"request completed"}
{"level":30,"time":1760178488571,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4863","remoteAddress":"::ffff:127.0.0.1","remotePort":4864},"msg":"incoming request"}
{"level":40,"time":1760178488572,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","err":{"type":"SyntaxError","message":"\"undefined\" is not valid JSON","stack":"SyntaxError: \"undefined\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\payment.ts:108:33)\n    at preHandlerCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:139:37)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:123:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)"},"resource":{"ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely a malformed/malicious request."}
{"level":30,"time":1760178488573,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":200},"responseTime":1.4431999921798706,"msg":"request completed"}
{"level":30,"time":1760178488576,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4865","remoteAddress":"::ffff:127.0.0.1","remotePort":4866},"msg":"incoming request"}
{"level":50,"time":1760178488576,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"FastifyError","message":"Body cannot be empty when content-type is set to 'application/json'","stack":"FastifyError: Body cannot be empty when content-type is set to 'application/json'\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:295:19)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)\n    at IncomingMessage.emit (node:events:530:35)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)","code":"FST_ERR_CTP_EMPTY_JSON_BODY","name":"FastifyError","statusCode":400},"req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4865","remoteAddress":"::ffff:127.0.0.1","remotePort":4866},"msg":"An error occurred during the request"}
{"level":30,"time":1760178488577,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":400},"responseTime":1.2715000212192535,"msg":"request completed"}
{"level":30,"time":1760178488580,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4867","remoteAddress":"::ffff:127.0.0.1","remotePort":4868},"msg":"incoming request"}
{"level":30,"time":1760178488585,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":200},"responseTime":4.9731999933719635,"msg":"request completed"}
{"level":30,"time":1760178488588,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4869","remoteAddress":"::ffff:127.0.0.1","remotePort":4870},"msg":"incoming request"}
{"level":30,"time":1760178488591,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":3.2875999808311462,"msg":"request completed"}
{"level":30,"time":1760178488595,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4871","remoteAddress":"::ffff:127.0.0.1","remotePort":4872},"msg":"incoming request"}
{"level":30,"time":1760178488598,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":2.7379000186920166,"msg":"request completed"}
{"level":30,"time":1760178488629,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4874","remoteAddress":"::ffff:127.0.0.1","remotePort":4875},"msg":"incoming request"}
[90mstdout[2m | src/tests/paymentSecurity.integration.test.ts[2m > [22m[2mPayment Security Integration Tests[2m > [22m[2mPayment Business Logic - 真正的成功和失败场景[2m > [22m[2mshould persist payment success and transition order status
[22m[39mOrder 34 successfully updated to PENDING_PICKUP.

{"level":30,"time":1760178488649,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":20.158399999141693,"msg":"request completed"}
{"level":30,"time":1760178488689,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4876","remoteAddress":"::ffff:127.0.0.1","remotePort":4877},"msg":"incoming request"}
{"level":30,"time":1760178488702,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":200},"responseTime":12.097000002861023,"msg":"request completed"}
{"level":30,"time":1760178488743,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4878","remoteAddress":"::ffff:127.0.0.1","remotePort":4879},"msg":"incoming request"}
{"level":30,"time":1760178488754,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":200},"responseTime":10.671299993991852,"msg":"request completed"}
{"level":30,"time":1760178488773,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4880","remoteAddress":"::ffff:127.0.0.1","remotePort":4881},"msg":"incoming request"}
{"level":30,"time":1760178488777,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":200},"responseTime":3.9151999950408936,"msg":"request completed"}
{"level":30,"time":1760178488780,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"POST","url":"/api/payment/notify","hostname":"127.0.0.1:4882","remoteAddress":"::ffff:127.0.0.1","remotePort":4883},"msg":"incoming request"}
{"level":40,"time":1760178488780,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"SyntaxError","message":"Unexpected token 'i', \"invalid-json{\" is not valid JSON","stack":"SyntaxError: Unexpected token 'i', \"invalid-json{\" is not valid JSON\n    at JSON.parse (<anonymous>)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\payment.ts:108:33)\n    at preHandlerCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:139:37)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:123:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)"},"resource":{"ciphertext":"mock-ciphertext","associated_data":"mock-associated-data","nonce":"mock-nonce"},"msg":"Payment notification decryption failed. Likely a malformed/malicious request."}
{"level":30,"time":1760178488781,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":200},"responseTime":0.7229999899864197,"msg":"request completed"}
 [32m✓[39m src/tests/paymentSecurity.integration.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 409[2mms[22m[39m
[90mstdout[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...
✅ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstdout[2m | src/tests/error-handling.integration.test.ts[2m > [22m[2mError Handling Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760178489025,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:4885","remoteAddress":"::ffff:127.0.0.1","remotePort":4886},"msg":"incoming request"}
{"level":30,"time":1760178489026,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":401},"responseTime":0.4674000144004822,"msg":"request completed"}
{"level":30,"time":1760178489028,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:4887","remoteAddress":"::ffff:127.0.0.1","remotePort":4888},"msg":"incoming request"}
{"level":40,"time":1760178489028,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","err":{"type":"TokenError","message":"The token is malformed.","stack":"Error: The token is malformed.\n    at decode (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fast-jwt\\src\\decoder.js:18:11)\n    at verify (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fast-jwt\\src\\verifier.js:285:15)\n    at Object.authenticate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\plugins\\auth.ts:17:29)\n    at hookIterator (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:405:10)\n    at next (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:239:18)\n    at hookRunner (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\hooks.js:261:5)\n    at validationCompleted (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:116:5)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:100:5)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at handleRequest (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:24:5)","code":"FAST_JWT_MALFORMED"},"msg":"Authentication failed"}
{"level":30,"time":1760178489030,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":401},"responseTime":1.8858999907970428,"msg":"request completed"}
{"level":30,"time":1760178489033,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"GET","url":"/api/orders/pending-pickup","hostname":"127.0.0.1:4889","remoteAddress":"::ffff:127.0.0.1","remotePort":4890},"msg":"incoming request"}
{"level":30,"time":1760178489035,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":403},"responseTime":2.0474999845027924,"msg":"request completed"}
{"level":30,"time":1760178489037,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4891","remoteAddress":"::ffff:127.0.0.1","remotePort":4892},"msg":"incoming request"}
{"level":50,"time":1760178489037,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"Error","message":"body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf","stack":"Error: body/status must be equal to constant, body/status must be equal to constant, body/status must match a schema in anyOf\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/0/const","keyword":"const","params":{"allowedValue":"COMPLETED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf/1/const","keyword":"const","params":{"allowedValue":"CANCELLED"},"message":"must be equal to constant"},{"instancePath":"/status","schemaPath":"#/properties/status/anyOf","keyword":"anyOf","params":{},"message":"must match a schema in anyOf"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4891","remoteAddress":"::ffff:127.0.0.1","remotePort":4892},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489038,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":400},"responseTime":0.5108999907970428,"msg":"request completed"}
{"level":30,"time":1760178489040,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4893","remoteAddress":"::ffff:127.0.0.1","remotePort":4894},"msg":"incoming request"}
{"level":50,"time":1760178489040,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4893","remoteAddress":"::ffff:127.0.0.1","remotePort":4894},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489041,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":400},"responseTime":0.6622999906539917,"msg":"request completed"}
{"level":30,"time":1760178489043,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4895","remoteAddress":"::ffff:127.0.0.1","remotePort":4896},"msg":"incoming request"}
{"level":50,"time":1760178489044,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","err":{"type":"SyntaxError","message":"Unexpected token 'i', \"invalid-json{\" is not valid JSON","stack":"SyntaxError: Unexpected token 'i', \"invalid-json{\" is not valid JSON","statusCode":400},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4895","remoteAddress":"::ffff:127.0.0.1","remotePort":4896},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489044,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":400},"responseTime":0.3174000084400177,"msg":"request completed"}
{"level":30,"time":1760178489047,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"GET","url":"/api/inventory/available?search=a","hostname":"127.0.0.1:4897","remoteAddress":"::ffff:127.0.0.1","remotePort":4898},"msg":"incoming request"}
{"level":30,"time":1760178489058,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":200},"responseTime":11.842200011014938,"msg":"request completed"}
{"level":30,"time":1760178489069,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4900},"msg":"incoming request"}
{"level":30,"time":1760178489070,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4905},"msg":"incoming request"}
{"level":30,"time":1760178489071,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4910},"msg":"incoming request"}
{"level":30,"time":1760178489072,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4901},"msg":"incoming request"}
{"level":30,"time":1760178489072,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4902},"msg":"incoming request"}
{"level":30,"time":1760178489073,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4903},"msg":"incoming request"}
{"level":30,"time":1760178489074,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4904},"msg":"incoming request"}
{"level":30,"time":1760178489074,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4906},"msg":"incoming request"}
{"level":30,"time":1760178489075,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4907},"msg":"incoming request"}
{"level":30,"time":1760178489075,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4908},"msg":"incoming request"}
{"level":30,"time":1760178489076,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4909},"msg":"incoming request"}
{"level":30,"time":1760178489076,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4911},"msg":"incoming request"}
{"level":30,"time":1760178489076,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4912},"msg":"incoming request"}
{"level":30,"time":1760178489077,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4913},"msg":"incoming request"}
{"level":30,"time":1760178489077,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4914},"msg":"incoming request"}
{"level":30,"time":1760178489077,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489077,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489077,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178489078,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760178489082,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4900},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489083,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":404},"responseTime":13.640900015830994,"msg":"request completed"}
{"level":50,"time":1760178489084,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4901},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489084,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-b","res":{"statusCode":404},"responseTime":12.48030000925064,"msg":"request completed"}
{"level":50,"time":1760178489084,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4902},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489085,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-c","res":{"statusCode":404},"responseTime":12.220299988985062,"msg":"request completed"}
{"level":50,"time":1760178489085,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4910},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489085,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-a","res":{"statusCode":404},"responseTime":14.265399992465973,"msg":"request completed"}
{"level":50,"time":1760178489085,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4905},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489085,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-9","res":{"statusCode":404},"responseTime":15.3226999938488,"msg":"request completed"}
{"level":50,"time":1760178489086,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4903},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489086,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-d","res":{"statusCode":404},"responseTime":12.592099994421005,"msg":"request completed"}
{"level":50,"time":1760178489086,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4904},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489086,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-e","res":{"statusCode":404},"responseTime":12.401199996471405,"msg":"request completed"}
{"level":50,"time":1760178489086,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4908},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489087,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-h","res":{"statusCode":404},"responseTime":11.35970002412796,"msg":"request completed"}
{"level":50,"time":1760178489088,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4907},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489088,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-g","res":{"statusCode":404},"responseTime":13.5901999771595,"msg":"request completed"}
{"level":50,"time":1760178489089,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4906},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489089,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-f","res":{"statusCode":404},"responseTime":15.048200011253357,"msg":"request completed"}
{"level":50,"time":1760178489099,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4914},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489100,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-m","res":{"statusCode":404},"responseTime":23.118000000715256,"msg":"request completed"}
{"level":50,"time":1760178489100,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4912},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489101,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-k","res":{"statusCode":404},"responseTime":24.378000020980835,"msg":"request completed"}
{"level":50,"time":1760178489101,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4911},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489101,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-j","res":{"statusCode":404},"responseTime":25.237800002098083,"msg":"request completed"}
{"level":50,"time":1760178489104,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4909},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489104,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-i","res":{"statusCode":404},"responseTime":28.79289999604225,"msg":"request completed"}
{"level":50,"time":1760178489105,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4899","remoteAddress":"::ffff:127.0.0.1","remotePort":4913},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489105,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-l","res":{"statusCode":404},"responseTime":28.271100014448166,"msg":"request completed"}
{"level":30,"time":1760178489110,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:4920","remoteAddress":"::ffff:127.0.0.1","remotePort":4921},"msg":"incoming request"}
{"level":30,"time":1760178489113,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760178489119,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:4920","remoteAddress":"::ffff:127.0.0.1","remotePort":4921},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489119,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-n","res":{"statusCode":404},"responseTime":9.46560001373291,"msg":"request completed"}
{"level":30,"time":1760178489122,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:4922","remoteAddress":"::ffff:127.0.0.1","remotePort":4923},"msg":"incoming request"}
{"level":50,"time":1760178489123,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","err":{"type":"Error","message":"params/id must be number","stack":"Error: params/id must be number\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:145:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/id","schemaPath":"#/properties/id/type","keyword":"type","params":{"type":"number"},"message":"must be number"}],"validationContext":"params"},"req":{"method":"PATCH","url":"/api/orders/invalid-id/status","hostname":"127.0.0.1:4922","remoteAddress":"::ffff:127.0.0.1","remotePort":4923},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489123,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-o","res":{"statusCode":400},"responseTime":1.016299992799759,"msg":"request completed"}
{"level":30,"time":1760178489155,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","req":{"method":"POST","url":"/api/orders/create","hostname":"127.0.0.1:4924","remoteAddress":"::ffff:127.0.0.1","remotePort":4925},"msg":"incoming request"}
{"level":30,"time":1760178489187,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-p","res":{"statusCode":201},"responseTime":32.19200000166893,"msg":"request completed"}
{"level":30,"time":1760178489190,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","req":{"method":"PATCH","url":"/api/orders/38/status","hostname":"127.0.0.1:4926","remoteAddress":"::ffff:127.0.0.1","remotePort":4927},"msg":"incoming request"}
{"level":30,"time":1760178489194,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760178489200,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","err":{"type":"ApiError","message":"无法将订单从 PENDING_PAYMENT 更新为 COMPLETED","stack":"ApiError: 无法将订单从 PENDING_PAYMENT 更新为 COMPLETED\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1111:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":400,"code":"INVALID_STATUS_TRANSITION"},"req":{"method":"PATCH","url":"/api/orders/38/status","hostname":"127.0.0.1:4926","remoteAddress":"::ffff:127.0.0.1","remotePort":4927},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489200,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-q","res":{"statusCode":400},"responseTime":9.773499995470047,"msg":"request completed"}
{"level":30,"time":1760178489203,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","req":{"method":"GET","url":"/api/inventory/item/99999","hostname":"127.0.0.1:4928","remoteAddress":"::ffff:127.0.0.1","remotePort":4929},"msg":"incoming request"}
{"level":50,"time":1760178489205,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","err":{"type":"ApiError","message":"Book not found.","stack":"ApiError: Book not found.\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\inventory.ts:66:15)","name":"ApiError","statusCode":404,"code":"BOOK_NOT_FOUND"},"req":{"method":"GET","url":"/api/inventory/item/99999","hostname":"127.0.0.1:4928","remoteAddress":"::ffff:127.0.0.1","remotePort":4929},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489206,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-r","res":{"statusCode":404},"responseTime":3.0509999990463257,"msg":"request completed"}
{"level":30,"time":1760178489209,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","req":{"method":"GET","url":"/api/orders/my","hostname":"127.0.0.1:4930","remoteAddress":"::ffff:127.0.0.1","remotePort":4931},"msg":"incoming request"}
{"level":30,"time":1760178489209,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-s","res":{"statusCode":401},"responseTime":0.16760000586509705,"msg":"request completed"}
{"level":30,"time":1760178489211,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","req":{"method":"GET","url":"/api/orders/pending-pickup","hostname":"127.0.0.1:4932","remoteAddress":"::ffff:127.0.0.1","remotePort":4933},"msg":"incoming request"}
{"level":30,"time":1760178489213,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-t","res":{"statusCode":403},"responseTime":1.9675999879837036,"msg":"request completed"}
{"level":30,"time":1760178489218,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4934","remoteAddress":"::ffff:127.0.0.1","remotePort":4935},"msg":"incoming request"}
{"level":50,"time":1760178489219,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","err":{"type":"Error","message":"body must have required property 'status'","stack":"Error: body must have required property 'status'\n    at defaultSchemaErrorFormatter (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\context.js:114:10)\n    at wrapValidationError (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:249:17)\n    at validate (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\validation.js:167:16)\n    at preValidationCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:93:25)\n    at handler (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\handleRequest.js:77:7)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at done (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:304:5)\n    at IncomingMessage.onEnd (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\fastify\\lib\\contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"status"},"message":"must have required property 'status'"}],"validationContext":"body"},"req":{"method":"PATCH","url":"/api/orders/123/status","hostname":"127.0.0.1:4934","remoteAddress":"::ffff:127.0.0.1","remotePort":4935},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489220,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-u","res":{"statusCode":400},"responseTime":1.9041999876499176,"msg":"request completed"}
{"level":30,"time":1760178489226,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:4936","remoteAddress":"::ffff:127.0.0.1","remotePort":4937},"msg":"incoming request"}
{"level":30,"time":1760178489228,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":39,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":50,"time":1760178489235,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","err":{"type":"ApiError","message":"订单不存在","stack":"ApiError: 订单不存在\n    at updateOrderStatusImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1098:11)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:168:28)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"PATCH","url":"/api/orders/99999/status","hostname":"127.0.0.1:4936","remoteAddress":"::ffff:127.0.0.1","remotePort":4937},"msg":"An error occurred during the request"}
{"level":30,"time":1760178489237,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-v","res":{"statusCode":404},"responseTime":10.940400004386902,"msg":"request completed"}
{"level":30,"time":1760178489242,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","req":{"method":"GET","url":"/api/health","hostname":"127.0.0.1:4938","remoteAddress":"::ffff:127.0.0.1","remotePort":4939},"msg":"incoming request"}
{"level":30,"time":1760178489245,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-w","res":{"statusCode":200},"responseTime":2.622099995613098,"msg":"request completed"}
 [32m✓[39m src/tests/error-handling.integration.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 359[2mms[22m[39m
[90mstdout[2m | src/tests/databaseRules.integration.test.ts[2m > [22m[2mDatabase-level Business Rules
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m✓[39m src/tests/databaseRules.integration.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 611[2mms[22m[39m
[90mstdout[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...
✅ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstdout[2m | src/tests/order.integration.test.ts[2m > [22m[2mOrder Integration Tests
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760178490173,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178490198,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":23.985000014305115,"msg":"request completed"}
{"level":30,"time":1760178490205,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":50,"time":1760178490215,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","err":{"type":"ApiError","message":"部分书籍已不可用，请刷新后重试","stack":"ApiError: 部分书籍已不可用，请刷新后重试\n    at validateInventoryAndReservations (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:133:11)\n    at createOrderImpl (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:227:48)\n    at Proxy._transactionWithCallback (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:251:16\n    at withTxRetry (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:57:14)\n    at createOrder (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:250:14)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:63:21)","name":"ApiError","statusCode":409,"code":"INSUFFICIENT_INVENTORY_PRECHECK"},"req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"An error occurred during the request"}
{"level":30,"time":1760178490216,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":409},"responseTime":10.812700003385544,"msg":"request completed"}
{"level":30,"time":1760178490254,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178490283,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-3","res":{"statusCode":201},"responseTime":28.788499981164932,"msg":"request completed"}
{"level":30,"time":1760178490284,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","req":{"method":"GET","url":"/api/orders/51","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":50,"time":1760178490291,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","err":{"type":"ApiError","message":"Order not found","stack":"ApiError: Order not found\n    at getOrderById (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\services\\orderService.ts:1064:11)\n    at Object.<anonymous> (C:\\Users\\wapadil\\WeChatProjects\\miniprogram-13\\bookworm-backend\\src\\routes\\orders.ts:82:21)","name":"ApiError","statusCode":404,"code":"ORDER_NOT_FOUND"},"req":{"method":"GET","url":"/api/orders/51","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"An error occurred during the request"}
{"level":30,"time":1760178490291,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-4","res":{"statusCode":404},"responseTime":7.5432000160217285,"msg":"request completed"}
{"level":30,"time":1760178490321,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178490340,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-5","res":{"statusCode":201},"responseTime":18.07279998064041,"msg":"request completed"}
{"level":30,"time":1760178490341,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","req":{"method":"GET","url":"/api/orders/52","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178490362,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-6","res":{"statusCode":200},"responseTime":20.933100014925003,"msg":"request completed"}
{"level":30,"time":1760178490398,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","req":{"method":"POST","url":"/api/orders/create","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178490425,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-7","res":{"statusCode":201},"responseTime":26.85469999909401,"msg":"request completed"}
{"level":30,"time":1760178490426,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","req":{"method":"GET","url":"/api/orders/my","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178490437,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-8","res":{"statusCode":200},"responseTime":10.82490000128746,"msg":"request completed"}
 [32m✓[39m src/tests/order.integration.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 468[2mms[22m[39m
[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Lock acquired for "test:concurrent-lock-verification". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Could not acquire lock for "test:concurrent-lock-verification". Another instance is likely running.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该确保在并发场景下只有一个任务实例能获取到同一个咨询锁
[22m[39m[AdvisoryLock] Lock released for "test:concurrent-lock-verification".

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该允许不同锁名的任务并发执行
[22m[39m[AdvisoryLock] Lock acquired for "test:lock-b". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该允许不同锁名的任务并发执行
[22m[39m[AdvisoryLock] Lock acquired for "test:lock-a". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该允许不同锁名的任务并发执行
[22m[39m[AdvisoryLock] Lock released for "test:lock-b".

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该允许不同锁名的任务并发执行
[22m[39m[AdvisoryLock] Lock released for "test:lock-a".

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该在任务抛出异常时仍然释放锁
[22m[39m[AdvisoryLock] Lock acquired for "test:error-handling-lock". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该在任务抛出异常时仍然释放锁
[22m[39m[AdvisoryLock] Lock released for "test:error-handling-lock".

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该在任务抛出异常时仍然释放锁
[22m[39m[AdvisoryLock] Lock acquired for "test:error-handling-lock". Running task.

[90mstdout[2m | src/tests/advisoryLock.integration.test.ts[2m > [22m[2mAdvisory Lock Concurrent Execution Tests[2m > [22m[2m应该在任务抛出异常时仍然释放锁
[22m[39m[AdvisoryLock] Lock released for "test:error-handling-lock".

 [32m✓[39m src/tests/advisoryLock.integration.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 273[2mms[22m[39m
[90mstdout[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstdout[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39m✅ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstdout[2m | src/tests/sellOrders.integration.test.ts[2m > [22m[2mSell Orders API
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760178491017,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"POST","url":"/api/sell-orders","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178491021,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","userId":55,"userRole":"STAFF","requiredRole":"STAFF","source":"db_lookup","msg":"Role check debug"}
{"level":30,"time":1760178491022,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","operatorId":55,"targetUserId":54,"totalWeightKg":3.2,"unitPriceCents":250,"settlementType":"CASH","action":"CREATE_SELL_ORDER","msg":"STAFF member creating sell order"}
{"level":30,"time":1760178491048,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","operatorId":55,"targetUserId":54,"orderId":54,"totalAmount":800,"action":"SELL_ORDER_CREATED","msg":"Sell order created successfully"}
{"level":30,"time":1760178491049,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":201},"responseTime":31.3885999917984,"msg":"request completed"}
{"level":30,"time":1760178491056,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"POST","url":"/api/sell-orders","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178491058,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":403},"responseTime":1.966399997472763,"msg":"request completed"}
 [32m✓[39m src/tests/sellOrders.integration.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 290[2mms[22m[39m
[90mstdout[2m | src/tests/refund-recovery.integration.test.ts[2m > [22m[2mRefund Recovery Integration
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [31m❯[39m src/tests/refund-recovery.integration.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[32m 80[2mms[22m[39m
[31m   [31m×[31m Refund Recovery Integration[2m > [22mshould resume processing refunds that are stuck in REFUND_PROCESSING[39m[32m 54[2mms[22m[39m
[31m     → 
Invalid `prisma.bookSku.deleteMany()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\refund-recovery.integration.test.ts:16:26

  13 await prisma.orderItem.deleteMany();
  14 await prisma.inventoryItem.deleteMany();
  15 await prisma.order.deleteMany();
→ 16 await prisma.bookSku.deleteMany(
Foreign key constraint violated on the constraint: `RecommendedBookItem_sku_id_fkey`[39m
[31m     → 
Invalid `prisma.bookSku.deleteMany()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\refund-recovery.integration.test.ts:16:26

  13 await prisma.orderItem.deleteMany();
  14 await prisma.inventoryItem.deleteMany();
  15 await prisma.order.deleteMany();
→ 16 await prisma.bookSku.deleteMany(
Foreign key constraint violated on the constraint: `RecommendedBookItem_sku_id_fkey`[39m
[31m   [31m×[31m Refund Recovery Integration[2m > [22mshould mark refund as FAILED after exceeding max attempts[39m[32m 22[2mms[22m[39m
[31m     → 
Invalid `prisma.bookSku.deleteMany()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\refund-recovery.integration.test.ts:16:26

  13 await prisma.orderItem.deleteMany();
  14 await prisma.inventoryItem.deleteMany();
  15 await prisma.order.deleteMany();
→ 16 await prisma.bookSku.deleteMany(
Foreign key constraint violated on the constraint: `RecommendedBookItem_sku_id_fkey`[39m
[31m     → 
Invalid `prisma.bookSku.deleteMany()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\refund-recovery.integration.test.ts:16:26

  13 await prisma.orderItem.deleteMany();
  14 await prisma.inventoryItem.deleteMany();
  15 await prisma.order.deleteMany();
→ 16 await prisma.bookSku.deleteMany(
Foreign key constraint violated on the constraint: `RecommendedBookItem_sku_id_fkey`[39m
[90mstdout[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...
✅ Test database URL set for worker 1: postgres://test:test@localhost...

[90mstdout[2m | src/tests/acquisitions.integration.test.ts[2m > [22m[2mAcquisitions Allowlist API
[22m[39mMetrics endpoint registered at /metrics

{"level":30,"time":1760178491354,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","req":{"method":"GET","url":"/api/acquisitions/check?isbn=9781234567897","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178491372,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-1","res":{"statusCode":200},"responseTime":17.557700008153915,"msg":"request completed"}
{"level":30,"time":1760178491373,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","req":{"method":"GET","url":"/api/acquisitions/check?isbn=9781234567898","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
{"level":30,"time":1760178491376,"pid":34176,"hostname":"LAPTOP-P2FCIAFQ","reqId":"req-2","res":{"statusCode":200},"responseTime":3.401700019836426,"msg":"request completed"}
 [32m✓[39m src/tests/acquisitions.integration.test.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 160[2mms[22m[39m
[90mstdout[2m | src/tests/order-pagination.integration.test.ts[2m > [22m[2mOrder Cursor Pagination Integration
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [31m❯[39m src/tests/order-pagination.integration.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[32m 116[2mms[22m[39m
[31m   [31m×[31m Order Cursor Pagination Integration[2m > [22mshould return first page with next cursor for subsequent fetch[39m[32m 113[2mms[22m[39m
[31m     → 
Invalid `prisma.bookSku.deleteMany()` invocation in
C:\Users\wapadil\WeChatProjects\miniprogram-13\bookworm-backend\src\tests\order-pagination.integration.test.ts:19:26

  16 await prisma.orderItem.deleteMany();
  17 await prisma.inventoryItem.deleteMany();
  18 await prisma.order.deleteMany();
→ 19 await prisma.bookSku.deleteMany(
Foreign key constraint violated on the constraint: `RecommendedBookItem_sku_id_fkey`[39m
[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests[2m > [22m[2mshould cancel expired orders and release inventory
[22m[39mCreated test user ID: [33m59[39m
Created inventory item IDs: [ [33m284[39m, [33m285[39m ]

[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests[2m > [22m[2mshould cancel expired orders and release inventory
[22m[39mFound inventory items: [ { id: [33m284[39m, status: [32m'in_stock'[39m }, { id: [33m285[39m, status: [32m'in_stock'[39m } ]

[90mstdout[2m | src/tests/order-expiration.integration.test.ts[2m > [22m[2mOrder Expiration Integration Tests[2m > [22m[2mshould cancel expired orders and release inventory
[22m[39mAtomically cancelled 1 orders and released 2 items back to stock.

 [32m✓[39m src/tests/order-expiration.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 136[2mms[22m[39m
[90mstdout[2m | src/tests/order-payment-amount.integration.test.ts[2m > [22m[2morder payment amount integrity
[22m[39mCreating new Prisma client for worker 1 with URL: postgres://test:test@localhost...

 [32m✓[39m src/tests/order-payment-amount.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 103[2mms[22m[39m

[2m Test Files [22m [1m[31m3 failed[39m[22m[2m | [22m[1m[32m13 passed[39m[22m[90m (16)[39m
[2m      Tests [22m [1m[31m5 failed[39m[22m[2m | [22m[1m[32m97 passed[39m[22m[90m (102)[39m
[2m   Start at [22m 18:27:53
[2m   Duration [22m 18.13s[2m (transform 546ms, setup 48ms, collect 2.23s, tests 7.94s, environment 0ms, prepare 155ms)[22m

Tearing down all test containers...
All containers stopped.
